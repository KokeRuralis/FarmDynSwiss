********************************************************************************
$ontext

   FARMDYN project

   GAMS file : STORE_RES.GMS

   @purpose  : Store the endogenous variables into the result array
                              and derive e.g. means over the time period


   @author   : W. Britz
   @date     : 12.11.10
   @since    :
   @refDoc   :
   @seeAlso  : model/templ.gms
   @calledBy : exp_starter.gms

$offtext
********************************************************************************
* Fake
*$batinclude 'util/title.gms' "'Store results for '" '%1' '%2'

  option p_res:2:5:1;
  $$ifi defined v_feeding option v_feeding:2:6:1;

  p_res(%1,%2,"etAlg","sum","","mean")        = m_farm.etAlg;
  p_res(%1,%2,"etSolve","sum","","mean")      = m_farm.etSolve;
  p_res(%1,%2,"etSolver","sum","","mean")     = m_farm.etSolver;
  p_res(%1,%2,"resUsd","sum","","mean")       = m_farm.resUsd;
  p_res(%1,%2,"resGen","sum","","mean")       = m_farm.resGen;
  p_res(%1,%2,"iterUsd","sum","","mean")      = m_farm.iterUsd;
  p_res(%1,%2,"numEqu","sum","","mean")       = m_farm.numEqu;
  p_res(%1,%2,"numVar","sum","","mean")       = m_farm.numVar;
  p_res(%1,%2,"numDVar","sum","","mean")      = m_farm.numDVar;
  p_res(%1,%2,"objval","sum","","mean")       = m_farm.objVal;
  p_res(%1,%2,"objEst","sum","","mean")       = m_farm.objEst;
  p_res(%1,%2,"nodUsd","sum","","mean")       = m_farm.nodUsd;

  $$ifi not %3 == full $exit


********************************************************************************
*
* CashFlow and Profit (costs, revenues)
*
********************************************************************************

* --- cash flow and profit

  p_res(%1,%2,"profit","sum","",tCur)         = sum(t_n(tCur,nCur), p_probn(nCur) * v_profitTax.l(tCur,nCur));
  p_res(%1,%2,"profit","sum","","mean")       = sum(tCur,p_res(%1,%2,"profit","sum","",tCur))/p_cardTCur;

  p_res(%1,%2,"netCashFlow","sum","",tCur)    = sum(t_n(tCur,nCur), p_probn(nCur) * v_netCashFlow.l(tCur,nCur));
  p_res(%1,%2,"netCashFlow","sum","","mean")  = sum(tCur,p_res(%1,%2,"netCashFlow","sum","",tCur)) /p_cardTCur;

  p_res(%1,%2,"opCashFlow","sum","",tCur)     = sum(t_n(tCur,nCur), p_probn(nCur) * v_opCashFlow.l(tCur,nCur) );
  p_res(%1,%2,"opCashFlow","sum","","mean")   = sum(t_n(tCur,nCur), p_probn(nCur) * v_opCashFlow.l(tCur,nCur) )/p_cardTCur;

  p_res(%1,%2,"invCashFlow","sum","",tCur)    = sum(t_n(tCur,nCur), p_probn(nCur) * v_invCashFlow.l(tCur,nCur));
  p_res(%1,%2,"invCashFlow","sum","","mean")  = sum(t_n(tCur,nCur), p_probn(nCur) * v_invCashFlow.l(tCur,nCur))/p_cardTCur;

* --- farmer/household income/withdrawl

  p_res(%1,%2,"withDraw","sum","",tCur)       = sum(t_n(tCur,nCur), p_probn(nCur) * v_withDraw.l(tCur,nCur));
  p_res(%1,%2,"withDraw","sum","","mean")     = sum(t_n(tCur,nCur), p_probn(nCur) * v_withDraw.l(tCur,nCur))/p_cardTCur;

  $$iftheni.taxes defined v_incomeTaxTot

     p_res(%1,%2,"incomeTaxTot","sum","",tCur)   = sum(t_n(tCur,nCur), p_probn(nCur) * v_incomeTaxTot.l(tCur,nCur));
     p_res(%1,%2,"incomeTaxTot","sum","","mean") = sum(t_n(tCur,nCur), p_probn(nCur) * v_incomeTaxTot.l(tCur,nCur))/p_cardTCur;

  $$endif.taxes

  p_res(%1,%2,"hhsldIncome","sum","",tCur)    = sum(t_n(tCur,nCur), p_probn(nCur) * v_hhsldIncome.l(tCur,nCur));
  p_res(%1,%2,"hhsldIncome","sum","","mean")  = sum(t_n(tCur,nCur), p_probn(nCur) * v_hhsldIncome.l(tCur,nCur))/p_cardTCur;

  p_res(%1,%2,"depr","sum","",tCur)           = sum(t_n(tCur,nCur), p_probn(nCur) * v_depr.l(tCur,nCur));
  p_res(%1,%2,"depr","sum","","mean")         = sum(t_n(tCur,nCur), p_probn(nCur) * v_depr.l(tCur,nCur))/p_cardTCur;

* --- variable Costs

  p_res(%1,%2,"sumVarCost","sum","",tCur)= sum((t_n(tCur,nCur)),p_probn(nCur) * v_varCost.l(tCur,nCur));
  p_res(%1,%2,"sumVarCost","sum","","mean")  = sum(tCur, p_res(%1,%2,"sumVarCost","sum","",tCur) )/p_cardTCur;

  $$iftheni.h %cattle% == true
    p_res(%1,%2,"feedBuyCost","sum","",tCur)
      = sum((feeds,t_n(tCur,nCur)), p_probn(nCur) * v_feedusebuy.l(feeds,tCur,nCur)*sum(sameas(inputs,feeds), p_inputPrice(inputs,"conv",tCur)));

    p_res(%1,%2,"feedBuyCost","sum","","mean")
     = sum(tCur, p_res(%1,%2,"feedBuyCost","sum","",tCur) )/p_cardTCur;

    p_res(%1,%2,"feedBuyCost",feeds,"",tCur)
       = sum((t_n(tCur,nCur)), p_probn(nCur) * v_feedusebuy.l(feeds,tCur,nCur)*sum(sameas(inputs,feeds), p_inputPrice(inputs,"conv",tCur)));

    p_res(%1,%2,"feedBuyCost",feeds,"","mean")
     = sum(tCur, p_res(%1,%2,"feedBuyCost",feeds,"",tCur) )/p_cardTCur;
  $$endif.h
*
* --- financial results
*
  p_res(%1,%2,"liquid","sum","",tCur)         = sum(t_n(tCur,nCur), p_probn(nCur) * v_liquid.l(tCur,nCur));
  p_res(%1,%2,"liquid","sum","","mean")       = sum(tCur,p_res(%1,%2,"liquid","sum","",tCur)   )/p_cardTCur;

  p_res(%1,%2,"sumInv","sum","",tFull)        = sum(t_n(tFull,nCur), p_probn(nCur) *  v_sumInv.l(tFull,nCur));
  p_res(%1,%2,"sumInv","sum","","mean")       = sum(tFull, p_res(%1,%2,"sumInv","sum","",tFull))/card(tFull);

  p_res(%1,%2,prodsYearly,"OQuant","",tCur)   = sum((t_n(tCur,nCur)), p_probn(nCur) * v_prods.l(prodsYearly,tCur,nCur) );
  p_res(%1,%2,prodsYearly,"OQuant","","mean") = sum(tCur,  p_res(%1,%2,prodsYearly,"OQuant","",tCur) )/p_cardTCur;

  $$ifthenI.cattle "%Cattle%"==true

     p_res(%1,%2,prodsMonthly,"OQuantPast","",tCur)   = sum((t_n(tCur,nCur),m), p_probn(nCur) * v_prodsintr.l(prodsmonthly,tCur,nCur,m) );
     p_res(%1,%2,prodsMonthly,"OQuantPast","","mean") = sum(tCur,  p_res(%1,%2,prodsMonthly,"OQuantPast","",tCur) )/p_cardTCur;

     p_res(%1,%2,prodsYearly,"OQuantResi","",tCur)   = sum(t_n(tCur,nCur), p_probn(nCur) * v_residuesOwnConsum.l(prodsYearly,tCur,nCur) );
     p_res(%1,%2,prodsYearly,"OQuantResi","","mean") = sum(tCur,  p_res(%1,%2,prodsYearly,"OQuantResi","",tCur) )/p_cardTCur;

  $$endif.cattle

  p_res(%1,%2,prodsYearly,"SQuant","",tCur) $ p_res(%1,%2,prodsYearly,"OQuant","",tCur)
         = sum((t_n(tCur,nCur),sys), p_probn(nCur) *  v_saleQuant.l(prodsYearly,sys,tCur,nCur) );

  p_res(%1,%2,prodsYearly,"SReve","",tCur)  $ p_res(%1,%2,prodsYearly,"SQuant","",tCur)
         = sum((t_n(tCur,nCur),sys),
                          p_probn(nCur) * v_salRevProds.l(prodsYearly,sys,tCur,nCur) );

  p_res(%1,%2,prodsYearly,"Price","",tCur) $ p_res(%1,%2,prodsYearly,"OQuant","",tCur)
                  = p_res(%1,%2,prodsYearly,"SReve","",tCur)/p_res(%1,%2,prodsYearly,"OQuant","",tCur);

  p_res(%1,%2,prods,"SQuant","","mean")  = sum(tCur, p_res(%1,%2,prods,"SQuant","",tCur))/p_cardTCur;
  p_res(%1,%2,prods,"SReve","","mean")   = sum(tCur, p_res(%1,%2,prods,"SReve","",tCur)) /p_cardTCur;

  p_res(%1,%2,prods,"Price","","mean") $ p_res(%1,%2,prods,"OQuant","","mean")
                                        =  p_res(%1,%2,prods,"SReve","","mean")/p_res(%1,%2,prods,"OQuant","","mean");
* --- revenue from animals
  $$ifi %herd% == true p_res(%1,%2,"animRev","sum","",tCur)  = sum(animProds, p_res(%1,%2,animProds,"SReve","",tCur));
* --- revenue from crops
  p_res(%1,%2,"cropRev","sum","",tCur)                     = sum(cropProds, p_res(%1,%2,cropProds,"SReve","",tCur));

  p_res(%1,%2,"intRev","sum","",tCur)
    = sum(t_n(tCur,nCur), p_probn(nCur) * v_liquid.l(tCur,nCur) * p_interestGain/100);

  $$iftheni.landLease %landlease% == true
    p_res(%1,%2,"rentRev","sum","",tCur)
       = sum((t_n(tCur,nCur),plot), p_probn(nCur) * v_rentOutPlot.l(plot,tCur,nCur)* p_plotSize(plot) * p_landRent(plot,tCur));
  $$endif.landLease

  p_res(%1,%2,"animRev","sum","","mean")   = sum(tCur, p_res(%1,%2,"animRev","sum","",tCur))   / p_cardTCur;
  p_res(%1,%2,"cropRev","sum","","mean")   = sum(tCur, p_res(%1,%2,"cropRev","sum","",tCur))   / p_cardTCur;
  p_res(%1,%2,"intRev","sum","","mean")    = sum(tCur, p_res(%1,%2,"intRev","sum","",tCur))    / p_cardTCur;
  p_res(%1,%2,"rentRev","sum","","mean")   = sum(tCur, p_res(%1,%2,"rentRev","sum","",tCur))   / p_cardTCur;

*
* --- cropping, results per crop
*
  $$batinclude 'exploiter/store_res_crops.gms' '%1' '%2' intens
  $$batinclude 'exploiter/store_res_crops.gms' '%1' '%2' till
  $$batinclude 'exploiter/store_res_crops.gms' '%1' '%2' '""'


  $$iftheni.herd %herd% == true
*
*    --- Herds, average # of animals per year
*
     p_res(%1,%2,possHerds,"levl",breeds,tCur)
         = sum(m, sum((t_n(tCur,nCur)) $ sum(feedregime,v_herdSize.l(possHerds,breeds,feedRegime,tCur,nCur,m)),p_probn(nCur)));

     p_res(%1,%2,possHerds,"levl",breeds,tCur) $ p_res(%1,%2,possHerds,"levl",breeds,tCur)
         = sum(m, sum((feedRegime,t_n(tCur,nCur)),
                   p_probn(nCur) * v_herdSize.l(possHerds,breeds,feedRegime,tCur,nCur,m)))
                        /p_res(%1,%2,possHerds,"levl",breeds,tCur);

     p_res(%1,%2,possHerds,"levl",breeds,tCur) $( (p_prodLength(possHerds,breeds) eq 1)
                                                 $$ifi "%farmBranchBeef%"=="on"  or sameas(possherds,"bullsSold")
                                               )
         = sum( (feedRegime,t_n(tCur,nCur),m),
                   p_probn(nCur) * v_herdSize.l(possHerds,breeds,feedRegime,tCur,nCur,m));

     p_res(%1,%2,possHerds,"prodLength",breeds,tCur) $ p_res(%1,%2,possHerds,"levl",breeds,tCur)
         =  p_prodLength(possHerds,breeds);
*
*    --- aggregate over breeds
*
     p_res(%1,%2,possHerds,"levl"," ",tCur) $ (not p_res(%1,%2,possHerds,"levl"," ",tCur))
        = sum(breeds,p_res(%1,%2,possHerds,"levl",breeds,tCur));
*
*    --- output coefficients
*
     p_res(%1,%2,possHerds,prods,breeds,tCur) $ p_res(%1,%2,possHerds,"levl",breeds,tCur)
      = p_oCoeff(possHerds,prods,Breeds,tCur);

     p_res(%1,%2,possHerds,"levl",breeds,"mean") = sum(tCur,p_res(%1,%2,possHerds,"levl",breeds,tCur)/p_cardtCur);

     $$ifi %dairyherd% == true p_res(%1,%2,possHerds,"milk",breeds,tCur) $ p_res(%1,%2,possHerds,"levl",breeds,tCur) = p_oCoeff(possHerds,"milk",breeds,tCur)*1000;

   $$endif.herd


   $$iftheni.cattle %cattle% == true
*
*     --- feed input in tons for the whole herd
*       (distribute from several years to single ones and convert to input per head in t per year)
*

      actHerdsF(possHerds,breeds,feedRegime,reqsphase,m)
         $ (not p_res(%1,%2,possHerds,"levl",breeds,"mean")) = no;

      actHerdsF(possHerds,breeds,feedRegime,reqsphase,m) $ (actHerdsF(possHerds,breeds,feedRegime,reqsphase,m)
        $ (not p_reqsPhaseMonths(possHerds,breeds,feedRegime,reqsPhase,"DMMX"))) = no;

      v_feeding.scale(actHerdsF(possHerds,breeds,feedRegime,reqsphase,m),feeds,t_n(tCur,nCur)) = 0;
*

      v_feeding.scale(actHerdsF(possHerds,breeds,feedRegime,reqsPhase,m),feeds,t_n(tCur,nCur))
             $ (v_feeding.l(possHerds,breeds,feedRegime,reqsPhase,m,feeds,tCur,nCur) $v_herdSize.l(possHerds,breeds,feedRegime,tCur,nCur,m)  $ t_n(tCur,nCur))
        = v_feeding.l(possHerds,breeds,feedRegime,reqsPhase,m,feeds,tCur,nCur)/ v_herdSize.l(possHerds,breeds,feedRegime,tCur,nCur,m)
*
*             --- reflect that herd might not be present for a whole year (??? this will increase the feed use per year if the prodlength < 12 ???)
*
              * 12/min(12,p_prodLength(possHerds,breeds));

      p_res(%1,%2,possHerds,feeds,breeds,tCur)
           $ sum((feedRegime,t_n(tCur,nCur),m),v_herdSize.l(possHerds,breeds,feedRegime,tCur,nCur,m))
        = sum( (actHerdsF(possHerds,breeds,feedRegime,reqsPhase,m),t_n(tCur,nCur)),
                p_probn(nCur) * v_feeding.scale(possHerds,breeds,feedRegime,reqsPhase,m,feeds,tCur,nCur)) * 1000/365;

      p_res(%1,%2,possHerds,reqs,breeds,tCur)
           $ sum((feedRegime,t_n(tCur,nCur),m),v_herdSize.l(possHerds,breeds,feedRegime,tCur,nCur,m))
        = sum( (actHerdsF(possHerds,breeds,feedRegime,reqsPhase,m),t_n(tCur,nCur)),
                  p_probn(nCur) * sum(feeds,v_feeding.scale(possHerds,breeds,feedRegime,reqsPhase,m,feeds,tCur,nCur)
                          * p_feedContFMton(feeds,reqs))) * 1000/365;

*
      p_res(%1,%2,sumHerds,feeds,breeds,tCur) $ sum( sum_herds(sumHerds,possHerds),p_res(%1,%2,sumHerds,"levl",breeds,tCur))
         = sum( sum_herds(sumHerds,possHerds) $ p_res(%1,%2,possHerds,"levl",breeds,tCur),
                          p_res(%1,%2,possHerds,feeds,breeds,tCur)*p_res(%1,%2,possHerds,"levl",breeds,tCur))
                           /p_res(%1,%2,sumHerds,"levl",breeds,tCur);
*
      p_res(%1,%2,sumHerds,reqs,breeds,tCur) $ sum( sum_herds(sumHerds,possHerds),p_res(%1,%2,sumHerds,"levl",breeds,tCur))
         = sum( sum_herds(sumHerds,possHerds) $ p_res(%1,%2,possHerds,"levl",breeds,tCur),
                          p_res(%1,%2,possHerds,reqs,breeds,tCur)*p_res(%1,%2,possHerds,"levl",breeds,tCur))
                           /p_res(%1,%2,sumHerds,"levl",breeds,tCur);
*
*     --- aggregate over breeds
*
      p_res(%1,%2,possHerds,feeds,"",tCur)  $ ( (not p_res(%1,%2,possHerds,feeds,"",tCur))
                                                $ p_res(%1,%2,possHerds,"levl","",tCur))
         = sum(breeds, p_res(%1,%2,possHerds,feeds,breeds,tCur)*p_res(%1,%2,possHerds,"levl",breeds,tCur))
          / p_res(%1,%2,possHerds,"levl","",tCur);

      p_res(%1,%2,possHerds,reqs,"",tCur)  $ ( (not p_res(%1,%2,possHerds,reqs,"",tCur))
                                                $ p_res(%1,%2,possHerds,"levl","",tCur))
         = sum(breeds, p_res(%1,%2,possHerds,reqs,breeds,tCur)*p_res(%1,%2,possHerds,"levl",breeds,tCur))
          / p_res(%1,%2,possHerds,"levl","",tCur);

      p_res(%1,%2,possHerds,feeds,breeds,"mean")  $ p_res(%1,%2,possHerds,"levl",breeds,"mean")
         = sum(tCur, p_res(%1,%2,possHerds,feeds,breeds,tCur)*p_res(%1,%2,possHerds,"levl",breeds,tCur))
                  / (p_res(%1,%2,possHerds,"levl",breeds,"mean")*p_cardtCur);


      p_res(%1,%2,possHerds,reqs,breeds,"mean")  $ p_res(%1,%2,possHerds,"levl",breeds,"mean")
         = sum(tCur, p_res(%1,%2,possHerds,reqs,breeds,tCur)*p_res(%1,%2,possHerds,"levl",breeds,tCur))
                  / (p_res(%1,%2,possHerds,"levl",breeds,"mean")*p_cardtCur);

  $$endif.cattle

  p_res(%1,%2,curInputs(inputs),"sum","",tCur)   = sum((sys,t_n(tCur,nCur)),p_probn(nCur) * v_buyCost.l(inputs,sys,tCur,nCur) );
  p_res(%1,%2,curInputs(inputs),"sum","","mean") = sum(tCur, p_res(%1,%2,inputs,"sum","",tCur))/p_cardtCur;

  p_res(%1,%2,"inputCost","sum","",tCur)   = sum(inputs, p_res(%1,%2,inputs,"sum","",tCur));
  p_res(%1,%2,"inputCost","sum","","mean") = sum(tCur, p_res(%1,%2,"inputCost","sum","",tCur))/p_cardtCur;

* --- costs for synthetic fertilizer
  p_res(%1,%2,"syntfertCost","sum","",tCur)   = sum(syntfert, p_res(%1,%2,syntfert,"sum","",tCur));
  p_res(%1,%2,"syntfertCost","sum","","mean") = sum(tCur, p_res(%1,%2,"syntfertCost","sum","",tCur))/p_cardtCur;

* --- costs for phytosanitary measures
  p_res(%1,%2,"phytoSaniCost","sum","",tCur)   = sum(phytoSani, p_res(%1,%2,phytoSani,"sum","",tCur));
  p_res(%1,%2,"phytoSaniCost","sum","","mean") = sum(tCur, p_res(%1,%2,"phytoSaniCost","sum","",tCur))/p_cardtCur;

  p_res(%1,%2,curInputs(inputs),"quant","",tCur)   = sum((sys,t_n(tCur,nCur)),p_probn(nCur) * v_buy.l(inputs,sys,tCur,nCur) );
  p_res(%1,%2,curInputs(inputs),"quant","","mean") = sum(tCur,  p_res(%1,%2,inputs,"quant","",tCur))/p_cardtCur;

  p_res(%1,%2,curInputs(inputs),"price","",tCur) $ p_res(%1,%2,inputs,"quant","",tCur)
     = p_res(%1,%2,inputs,"sum","",tCur)/p_res(%1,%2,inputs,"quant","",tCur);
  p_res(%1,%2,curInputs(inputs),"price","","mean") $ p_res(%1,%2,inputs,"quant","","mean")
    = p_res(%1,%2,inputs,"sum","","mean")/p_res(%1,%2,inputs,"quant","","mean");

  $$ontext

*
*   --- results which are currently commented out in store_res_crops.gms
*

    p_res(%1,%2,"other","sum","",tCur)   = sum(curCrops(crops), p_res(%1,%2,crops,"other","",tCur) * p_res(%1,%2,crops,"levl","",tCur));
    p_res(%1,%2,"other","sum","","mean") = sum(tCur, p_res(%1,%2,"other","sum","",tCur))/p_cardtCur;
    p_res(%1,%2,"fixedMach","sum","",tCur)   = sum(curCrops(crops), p_res(%1,%2,crops,"fixedMach","",tCur) * p_res(%1,%2,crops,"levl","",tCur));
    p_res(%1,%2,"fixedMach","sum","","mean") = sum(tCur, p_res(%1,%2,"fixedMach","sum","",tCur))/p_cardtCur;
    p_res(%1,%2,"buildCost","sum","",tCur)   =

       sum( (curBuildings(buildings),nCur) $ (t_n(tcur,nCur)
                      $ (     sum(t_n(t1,nCur1) $ isNodeBefore(nCur,nCur1), v_buyBuildings.up(buildings,t1,nCur1))
                          or  sum(tOld, p_iniBuildings(buildings,tOld)))),
                      p_probn(nCur) *
                      v_buildingsInv.l(buildings,tCur,nCur) * p_varCostBuild(buildings,tCur))

           $$iftheni.h %herd% == true
*
*          --- repair and insurance costs for stables, see e.g. page 589, KTBL 12/13,
*              fraction of investment cost depending on lifetime
*
                + sum( (stables,hor,nCur) $ (v_stableInv.up(stables,hor,tCur,nCur) $ t_n(tCur,nCur)),
                     p_probn(nCur) *
                     v_stableInv.l(stables,hor,tCur,nCur) * p_priceStables(stables,hor,tCur)
                            * (  0.01 $ sameas(hor,"long")
                               + 0.02 $ sameas(hor,"middle")
                               + 0.03 $ sameas(hor,"short") + 0.002) )
           $$endif.h
           ;
    p_res(%1,%2,"buildCost","sum","","mean") = sum(tCur, p_res(%1,%2,"buildCost","sum","",tCur))/p_cardtCur;
    p_res(%1,%2,"machCost","sum","",tCur) = sum((t_n(tCur,nCur)), p_probn(nCur) * v_varCostMach.l(tCur,nCur));
    p_res(%1,%2,"machCost","sum","","mean") = sum(tCur, p_res(%1,%2,"machCost","sum","",tCur))/p_cardtCur;
    p_res(%1,%2,"vcostsActivity","sum","",tCur) = sum((t_n(tCur,nCur)), p_probn(nCur) * v_varCostActs.l(tCur,nCur));
    p_res(%1,%2,"vcostsActivity","sum","","mean") = sum(tCur, p_res(%1,%2,"vcostsActivity","sum","",tCur))/p_cardtCur;
 $$offtext


 $$iftheni.man %manure% == true

    p_res(%1,%2,"manCost","sum","",tCur)   = sum((t_n(tCur,nCur)),  p_probn(nCur)  * v_varCostMan.l(tCur,nCur));
    p_res(%1,%2,"manCost","sum","","mean") = sum(tCur, p_res(%1,%2,"manCost","sum","",tCur))/p_cardtCur;

 $$endif.man

 $$iftheni.herd %herd% == true

    p_res(%1,%2,possHerds,"vCostO",curBreeds,tCur) $ p_res(%1,%2,possHerds,"levl",curBreeds,tCur)
     = p_vCost(possHerds,curBreeds,tCur)
*
*   --- reflect that cost are defined on a yearly basis
*
      * min(12,p_prodLength(possHerds,curBreeds))/12;

   p_res(%1,%2,possHerds,"vCostO"," ",tCur) $ ( (not curBreeds(" ")) and p_res(%1,%2,possHerds,"levl"," ",tCur))
      = sum(curBreeds $ p_res(%1,%2,possHerds,"levl",curBreeds,tCur),
                      p_res(%1,%2,possHerds,"levl",curBreeds,tCur) * p_res(%1,%2,possHerds,"vCostO",curBreeds,tCur))
                            / p_res(%1,%2,possHerds,"levl"," ",tCur);

   p_res(%1,%2,possHerds,"reve",curBreeds,tCur)  $ (p_res(%1,%2,possHerds,"levl",curBreeds,tCur)
                                                    $ (not p_res(%1,%2,possHerds,"reve",curBreeds,tCur)))
     = sum( (prodsyearly), p_OCoeff(possHerds,prodsyearly,curBreeds,tCur) * p_price(prodsYearly,"conv",tCur));

    p_res(%1,%2,possHerds,"reve"," ",tCur) $ ( (not curBreeds(" ")) and p_res(%1,%2,possHerds,"levl"," ",tCur))
      = sum(curBreeds $ p_res(%1,%2,possHerds,"levl",curBreeds,tCur),
                    p_res(%1,%2,possHerds,"levl",curBreeds,tCur) * p_res(%1,%2,possHerds,"reve",curBreeds,tCur))
                          / p_res(%1,%2,possHerds,"levl"," ",tCur);


  $$endif.herd
*
* --- store variables costs not specified
*
  p_res(%1,%2,"vCostO","sum",breeds,tCur)   = sum(possActs, p_res(%1,%2,possActs,"vCostO",breeds,tCur) * p_res(%1,%2,possActs,"levl",breeds,tCur));
  p_res(%1,%2,"vCostO","sum",breeds,"mean") = sum(tCur, p_res(%1,%2,"vCostO","sum",breeds,tCur))/card(tCur);
*
* --- sum of variable costs for crops (all specified)
*
  curInputs("manCost") = YES;
  curInputs("buildCost") = YES;

  p_res(%1,%2,curCrops(crops),"vCost","",tCur) $ p_res(%1,%2,crops,"levl","",tCur)
         = sum(curInputs(inputs), p_res(%1,%2,crops,inputs,"",tCur));
  p_res(%1,%2,curCrops(crops),"vCost",intens,tCur) $ p_res(%1,%2,crops,"levl",intens,tCur)
         = sum(curInputs(inputs), p_res(%1,%2,crops,inputs,"",tCur));
  p_res(%1,%2,curCrops(crops),"vCost",till,tCur) $ p_res(%1,%2,crops,"levl",till,tCur)
         = sum(curInputs(inputs), p_res(%1,%2,crops,inputs,"",tCur));

  $$iftheni.cattle %cattle% == true
*
*    --- feed costs from feed input coefficient, marketable
*
     p_res(%1,%2,cattle(possHerds),"fCost",curBreeds,tCur) $ p_res(%1,%2,possHerds,"levl",curBreeds,tCur)
           = sum( ( actHerdsF(possHerds,curBreeds,feedRegime,reqsphase,m),concentrates,t_n(tCur,nCur)), p_probn(nCur)
                   * v_feeding.scale(possHerds,curBreeds,feedRegime,reqsPhase,m,concentrates,tCur,nCur)
                            * sum(sameas(inputs,concentrates),p_inputPrice(inputs,"conv",tCur)));
*
*    --- feed costs from feed input coefficient, non marketable
*
     p_res(%1,%2,cattle(possHerds),"fnmCost",curBreeds,tCur) $ (p_res(%1,%2,possHerds,"levl",curBreeds,tCur) $ cattle(possHerds))
              = sum( ( actHerdsF(possHerds,curBreeds,feedRegime,reqsphase,m),roughages,t_n(tCur,nCur)),
                          v_feeding.scale(possHerds,curBreeds,feedRegime,reqsPhase,m,roughages,tCur,nCur)
                           * ( - feeduse_.m(roughages,tCur,nCur)
                               - feeduseM_.m(roughages,m,tCur,nCur)));

     v_feeding.scale(actHerdsF(possHerds,breeds,feedRegime,reqsPhase,m),feeds,t_n(tCur,nCur)) $ (cattle(possHerds)
      $ (v_feeding.scale(possHerds,breeds,feedRegime,reqsPhase,m,feeds,tCur,nCur) eq 0)) = 1;
*
*    --- aggregate over breeds
*
     p_res(%1,%2,cattle(possHerds),"fCost","",tCur) $ ( (not p_res(%1,%2,possHerds,"fCost","",tCur)) $ p_res(%1,%2,possHerds,"levl","",tCur) )
               = sum( curBreeds, p_res(%1,%2,possHerds,"fCost",curBreeds,tCur));

     p_res(%1,%2,cattle(possHerds),"fnmCost","",tCur) $ ( (not p_res(%1,%2,possHerds,"fnmCost","",tCur)) $ p_res(%1,%2,possHerds,"levl","",tCur))
               = sum( curBreeds, p_res(%1,%2,possHerds,"fnmCost",curBreeds,tCur));



  $$endif.cattle

*
* --- Feed cost calculations for pigs   !How to handle own produced crops!
*
  $$iftheni.fattner "%farmBranchFattners%" == true

    p_res(%1,%2,possHerds,"animalPerYear","",tCur) $ fatHerd(possHerds)
      = sum( (prodsYearly,t_n(tCur,nCur)), v_saleQuant.l(prodsYearly,tCur,nCur) / p_OCoeffMeat("fattners","pigmeat"));
    p_res(%1,%2,possHerds,"animalPerYear","","mean") $ fatHerd(possHerds)
      = sum(tcur, p_res(%1,%2,possHerds,"animalPerYear","",tCur)) / p_cardTcur;

*   ---- feeding Per Year
    p_res(%1,%2,possHerds,feedsPig,"",tCur) $ (p_res(%1,%2,possHerds,"levl","",tCur) $ fatHerd(possHerds))
                                =  sum( (feedRegime,t_n(tCur,nCur),m), v_feedingPig.l(possherds,feedsPig,feedRegime,tCur,nCur,m)* p_probn(nCur))
*   ---  transformed in kg
                                       * 1000
*   ---  per head
                                       / p_res(%1,%2,possHerds,"animalPerYear","",tCur);

    p_res(%1,%2,possherds,feedsPig,"","mean") $ fatHerd(possHerds)
     = sum(tCur, p_res(%1,%2,possHerds,feedsPig,"",tCur)) / p_cardtCur;

*   --- own produced feed
    p_res(%1,%2,"feedP",feedspig,"",tCur) $ (sum(possherds,(p_res(%1,%2,possHerds,feedsPig,"",tCur))) $ fatHerd(possHerds))
     =   sum( t_n(tCur,nCur), v_feedOwnPig.l(feedspig,tCur,nCur)) / p_res(%1,%2,"fattners","animalPerYear","",tCur) * 1000 ;
*   ---- total amound of feed
    p_res(%1,%2,"fattnersStore",feedsPig,"",tCur) $ (sum(possherds,(p_res(%1,%2,possHerds,feedsPig,"",tCur))) $ fatHerd(possHerds))
      =  sum((possherds,feedRegime,t_n(tCur,nCur),m) , v_feedingPig.l(possherds,feedsPig,feedRegime,tCur,nCur,m)* p_probn(nCur))
                                                       / p_res(%1,%2,"fattners","animalPerYear","",tCur) * 1000     ;
*   --- feedcost for purchased feeds per finished pig
     p_res(%1,%2,"fattners","fCost","",tCur) $ fatHerd(possHerds)
     =       sum( (sameas(inputs,feedsPig)), (p_res(%1,%2,"fattnersStore",feedsPig,"",tCur)
                                                   - p_res(%1,%2,"feedP",feedspig,"",tCur)) * p_inputPrice(inputs,tCur))
*    --- per kg
                              /1000              ;
*    --- Labhours Pigs
     p_res(%1,%2,possherds,"labhour","",tCur) $ fatHerd(possHerds)  = 0.67667 ;

  $$endif.fattner

  p_res(%1,%2,possActs,"levl",breeds,"mean") = sum(tCur, p_res(%1,%2,possActs,"levl",breeds,tCur))   / p_cardtCur;
  p_res(%1,%2,intens,"levl","","mean")       = sum(tCur, p_res(%1,%2,intens,"levl","",tCur))     / p_cardtCur;
  p_res(%1,%2,till,"levl","","mean")         = sum(tCur, p_res(%1,%2,till,"levl","",tCur))       / p_cardtCur;

  p_res(%1,%2,possActs,meanForActs,breeds,"mean")     $ p_res(%1,%2,possActs,"levl",breeds,"mean")
          = sum(tCur, p_res(%1,%2,possActs,meanForActs,breeds,tCur)  * p_res(%1,%2,possActs,"levl",breeds,tCur))
                        /  (p_res(%1,%2,possActs,"levl",breeds,"mean")*p_cardtCur);

  p_res(%1,%2,curCrops,meanForActs,tia,"mean")     $ p_res(%1,%2,curCrops,"levl",tia,"mean")
          = sum(tCur, p_res(%1,%2,curCrops,meanForActs,tia,tCur)  * p_res(%1,%2,curCrops,"levl",tia,tCur))
                        /  (p_res(%1,%2,curCrops,"levl",tia,"mean")*p_cardtCur);
*
* --- land
*
  $$iftheni.landBuy %landlBy% == true

    p_res(%1,%2,"buyland",landType,"",tCur)
      = sum((t_n(tCur,nCur),plot_lt_soil(plot,landType,soil)) ,p_probn(nCur)*v_buyPlot.l(plot,tCur,nCur)*p_buyPlotSize);

    p_res(%1,%2,"buyland",soil,"",tCur)
       = sum((t_n(tCur,nCur),plot_lt_soil(plot,landType,soil)) ,p_probn(nCur)*v_buyPlot.l(plot,tCur,nCur)*p_buyPlotSize);

  $$endif.landBuy

  p_res(%1,%2,"totland",landType,"",tCur)
   = sum( (t_n(tCur,nCur),soil),p_probn(nCur)* v_croppedLand.l(landType,soil,tCur,nCur) );

  p_res(%1,%2,"totland","tot","",tCur) = sum(landType,p_res(%1,%2,"totland",landType,"",tCur));

  $$iftheni.lease %landlease% == true

     p_res(%1,%2,"rentOut",landType,"",tCur)
          = sum((t_n(tCur,nCur),plot_lt_soil(plot,landType,soil)),
                  p_probn(nCur)*v_rentOutPlot.l(plot,tCur,nCur)* p_plotSize(plot));

     p_res(%1,%2,"rentOut",soil,"",tCur)
          = sum((t_n(tCur,nCur),plot_lt_soil(plot,landType,soil)),
                  p_probn(nCur)*v_rentOutPlot.l(plot,tCur,nCur)* p_plotSize(plot));

     p_res(%1,%2,"rentOut","sum","",tCur)
         = sum((t_n(tCur,nCur),plot_lt_soil(plot,landType,soil)),
                 p_probn(nCur)*v_rentOutPlot.l(plot,tCur,nCur)* p_plotSize(plot));
  $$endif.lease

  p_res(%1,%2,"cropped",landType,"",tCur)
      = sum((t_n(tCur,nCur),soil), p_probn(nCur) * v_croppedLand.l(landType,soil,tCur,nCur) );


  p_res(%1,%2,"buyland",landType,"","mean") = sum(tCur,p_res(%1,%2,"buyland",landType,"",tCur));
  p_res(%1,%2,"buyland",soil,"","mean")     = sum(tCur,p_res(%1,%2,"buyland",soil,"",tCur));
  p_res(%1,%2,"totland",landType,"","mean") = sum(tCur,p_res(%1,%2,"totland",landType,"",tCur)) / p_cardtCur;
  p_res(%1,%2,"totLand","tot","","mean")    = sum(tCur,p_res(%1,%2,"totLand","tot","",tCur))    / p_cardtCur;
  p_res(%1,%2,"cropped",landType,"","mean") = sum(tCur,p_res(%1,%2,"cropped",landType,"",tCur)) / p_cardtCur;
  p_res(%1,%2,"rentOut",landType,"","mean") = sum(tCur,p_res(%1,%2,"rentOut",landType,"",tCur)) / p_cardtCur;

  $$iftheni.herd %herd% == true
*
*    --- Stables
*
     p_res(%1,%2,stables,"Invent","",tFull) = sum(t_n(tFull,nCur),p_probn(nCur)*v_stableInv.l(stables,"Long",tFull,nCur));
     p_res(%1,%2,stables,"Used","",tCur)    = sum(t_n(tCur,nCur),p_probn(nCur)*v_stableUsed.l(stables,tCur,nCur));
     p_res(%1,%2,stables,"UnUsed","",tCur)  = sum((t_n(tCur,nCur),m),p_probn(nCur)*v_stableNotUsed.l(stables,tCur,nCur,m))/card(m);
     p_res(%1,%2,stables,hor,"",tFull)      = sum(t_n(tFull,nCur),p_probn(nCur)*v_buyStablesF.l(stables,hor,tFull,nCur));
     p_res(%1,%2,stables,"new","",tFull)    = sum(t_n(tFull,nCur),p_probn(nCur)*v_buyStablesF.l(stables,"long",tFull,nCur));
     p_res(%1,%2,stables,"price","",tFull)  $ p_res(%1,%2,stables,"new","",tFull)
         = sum((t_n(tFull,nCur),hor), p_priceStables(stables,hor,tFull));

     p_res(%1,%2,stables,"Invent","","mean") = sum(tFull,p_res(%1,%2,stables,"Invent","",tFull)) /card(tFull);
     p_res(%1,%2,stables,hor,"","mean")    = sum(tFull,p_res(%1,%2,stables,hor,"",tFull));
     p_res(%1,%2,stables,"Used","","mean")   = sum(tCur,p_res(%1,%2,stables,"Used","",tCur))   /p_cardtCur;
     p_res(%1,%2,stables,"unUsed","","mean") = sum(tCur,p_res(%1,%2,stables,"unUsed","",tCur)) /p_cardtCur;

     p_res(%1,%2,stables,"new","","mean")  $ sum(tCur,p_res(%1,%2,stables,"new","",tCur))
         = sum((t_n(tCur,nCur)), p_res(%1,%2,stables,"new","",tCur))/p_cardTCur;

     p_res(%1,%2,stables,"price","","mean")  $ sum(tFull $ (p_res(%1,%2,stables,"new","",tFull) gt eps),1)
         = sum((t_n(tFull,nCur),hor), p_priceStables(stables,hor,tFull)*p_res(%1,%2,stables,"new","",tFull))
            / sum(tFull,p_res(%1,%2,stables,"new","",tFull));

     p_res(%1,%2,stableTypes,"Places","",tCur)
           = sum((t_n(tCur,nCur),stables),p_probn(nCur)*v_stableInv.l(stables,"long",tCur,nCur) * p_stableSize(stables,stableTypes));

     p_res(%1,%2,stableTypes,"FreePlaces","",tCur)
       = sum(stables,  p_res(%1,%2,stables,"UnUsed","",tCur) * p_stableSize(stables,stableTypes));

     p_res(%1,%2,stableTypes,"Places","","mean")     = sum(tCur,p_res(%1,%2,stableTypes,"Places","",tCur))    /p_cardtCur;
     p_res(%1,%2,stableTypes,"FreePlaces","","mean") = sum(tCur,p_res(%1,%2,stableTypes,"FreePlaces","",tCur))/p_cardtCur;
     p_res(%1,%2,silos,"new","",tFull)      = sum((curManChain,t_n(tFull,nCur)),p_probn(nCur)*v_buySilos.l(curManChain,silos,tFull,nCur));
     p_res(%1,%2,silos,"new","","mean")     = sum((curManChain,t_n(tFull,nCur)),p_probn(nCur)*v_buySilos.l(curManChain,silos,tFull,nCur));
*
*    --- Silos for manure
*
     p_res(%1,%2,silos,"Invent","",tFull)    = sum((curManChain,t_n(tFull,nCur)),p_probn(nCur)*v_siloInv.l(curManChain,silos,tFull,nCur));
     p_res(%1,%2,silos,"Invent","","mean")   = sum((curManChain,t_n(tFull,nCur)),p_probn(nCur)*v_siloInv.l(curManChain,silos,tFull,nCur))/card(tFull);

  $$endif.herd


  p_res(%1,%2,buildings,"new","",tFull)       = sum(t_n(tFull,nCur),p_probn(nCur)*v_buyBuildings.l(buildings,tFull,nCur));
  p_res(%1,%2,buildings,"new","","mean")      = sum(t_n(tFull,nCur),p_probn(nCur)* v_buyBuildings.l(buildings,tFull,nCur));

  p_res(%1,%2,buildings,"Invent","",tFull)    = sum(t_n(tFull,nCur),p_probn(nCur)*v_buildingsInv.l(buildings,tFull,nCur));
  p_res(%1,%2,buildings,"Invent","","mean")   = sum(t_n(tFull,nCur),p_probn(nCur)*v_buildingsInv.l(buildings,tFull,nCur))/card(tFull);

  $$ifi "%biogas%"=="true" $include 'exploiter/store_res_biogas.gms' '%1' '%2'
*
* --- Machines
*
  p_res(%1,%2,machType,"Invent","",tCur)  = sum((t_n(tCur,nCur),machLifeUnit) $ p_lifeTimeM(machType,machLifeUnit),p_probn(nCur)* v_machInv.l(machType,machLifeUnit,tCur,nCur));
  p_res(%1,%2,machType,"new","",tCur)     = sum(t_n(tCur,nCur),p_probn(nCur)*(v_buyMach.l(machType,tCur,nCur)
                                                                            +v_buyMachFlex.l(machType,tCur,nCur)));

  p_res(%1,%2,machType,"Price","",tCur)   = p_priceMach(machType,tCur);
  p_res(%1,%2,machType,"newCost","",tCur)     = sum(t_n(tCur,nCur),p_probn(nCur)*p_priceMach(machType,tCur)
                                                                           *(v_buyMach.l(machType,tCur,nCur)
                                                                            +v_buyMachFlex.l(machType,tCur,nCur)));
  p_res(%1,%2,machType,"costs","",tCur)   = sum((t_n(tCur,nCur)),[ v_machNeed.l(machType,"ha",tCur,nCur)   * p_machCost(machType,"ha",tCur)
                                                                +v_machNeed.l(machType,"hour",tCur,nCur) * p_machCost(machType,"hour",tCur) ]
                                                                  *p_probn(nCur));
  p_res(%1,%2,machType,"Use","",tCur)     = sum( (t_n(tCur,nCur),machLifeUnit) $ p_lifeTimeM(machType,machLifeUnit),
                                                 v_machNeed.l(machType,machLifeUnit,tCur,nCur) *p_probn(nCur));

  p_res(%1,%2,machType,"Invent","","mean") = sum( (t_n(tCur,nCur),machLifeUnit) $ p_lifeTimeM(machType,machLifeUnit),
                                                     v_machInv.l(machType,machLifeUnit,tCur,nCur)*p_probn(nCur))/p_cardtCur;
  p_res(%1,%2,machType,"new","","mean")    = sum( t_n(tCur,nCur),p_probn(nCur)*( v_buyMach.l(machType,tCur,nCur)
                                                                            +v_buyMachFlex.l(machType,tCur,nCur)));

  p_res(%1,%2,machType,"Price","","mean")  = sum( tCur,p_res(%1,%2,machType,"Price","",tCur))/p_cardtCur;
  p_res(%1,%2,machType,"Use","","mean")    = sum( tCur,p_res(%1,%2,machType,"Use","",tCur))/p_cardtCur;
  p_res(%1,%2,machType,"Costs","","mean")  = sum( tCur,p_res(%1,%2,machType,"Costs","",tCur))/p_cardtCur;

  p_res(%1,%2,machType,"newCost","","mean")    = sum( t_n(tCur,nCur),p_probn(nCur)*p_priceMach(machType,tCur)
                                                                                   +v_buyMachFlex.l(machType,tCur,nCur));

********************************************************************************
*
*  Labour
*
********************************************************************************

  p_res(%1,%2,workType,"#","",tCur)        = sum( t_n(tCur,nCur), v_labOffF.l(tCur,nCur,workType)/(p_workTime(workType) * 44)*p_probn(nCur) $ workOpps(workType));
  p_res(%1,%2,allWorkType,"wage","",tCur)  = p_wage(allWorkType,tCur) ;
  p_res(%1,%2,workType,"earn","",tCur)     = p_res(%1,%2,workType,"#","",tCur) *  p_workTime(workType) * 52 * p_wage(workType,tCur) ;
  p_res(%1,%2,workType,"hours","",tCur)    = p_res(%1,%2,workType,"#","",tCur) * (p_workTime(workType) + p_commTime(workType)) * 44;

  p_res(%1,%2,"hourly","hours","",tCur)  = sum((t_n(tCur,nCur)), v_labOffHourly.l(tCur,nCur)*p_probn(nCur) );
  p_res(%1,%2,"hourly","earn","",tCur)   = p_res(%1,%2,"hourly","hours","",tCur) * p_res(%1,%2,"hourly","wage","",tCur);

  p_res(%1,%2,allWorkType,"hours","","mean") = sum(tCur, p_res(%1,%2,allWorkType,"hours","",tCur))/p_cardtCur;
  p_res(%1,%2,allWorkType,"earn","","mean")  = sum(tCur, p_res(%1,%2,allWorkType,"earn","",tCur))/p_cardtCur;
  p_res(%1,%2,allWorkType,"wage","","mean") $ p_res(%1,%2,allWorkType,"hours","","mean") = p_res(%1,%2,allWorkType,"earn","","mean")/p_res(%1,%2,allWorkType,"hours","","mean");

  p_res(%1,%2,"offFarm","hours","",tCur)    = sum(t_n(tCur,nCur), v_laboffTot.l(tCur,nCur) * p_probn(nCur));
  p_res(%1,%2,"offFarm","hours","","mean")  = sum(tCur,p_res(%1,%2,"offFarm","hours","",tCur))/p_cardtCur;

  p_res(%1,%2,"offFarm","earn","",tCur)   = sum(allWorkType, p_res(%1,%2,allWorkType,"earn","",tCur));
  p_res(%1,%2,"offFarm","wage","",tCur) $ p_res(%1,%2,"offFarm","hours","",tCur) = p_res(%1,%2,"offFarm","earn","",tCur)/ p_res(%1,%2,"offFarm","hours","",tCur);

  p_res(%1,%2,"offFarm","earn","","mean") = sum(tCur, p_res(%1,%2,"offFarm","earn","",tCur))/p_cardtCur;
  p_res(%1,%2,"offFarm","wage","","mean") $ p_res(%1,%2,"offFarm","hours","","mean") = p_res(%1,%2,"offFarm","earn","","mean")/p_res(%1,%2,"offFarm","hours","","mean");

  p_res(%1,%2,"offFarmRev","sum","",tCur)      = p_res(%1,%2,"offFarm","earn","",tCur);
  p_res(%1,%2,"offFarmRev","sum","","mean")   = sum(tCur, p_res(%1,%2,"offFarmRev","sum","",tCur))/p_cardtCur;

  $$iftheni.hire "%allowHiring%"=="true"

     p_res(%1,%2,"hiredLabour","sum","",tCur)      = sum(t_n(tCur,nCur), v_hireWorkers(tCur,nCur)*p_probN(nCur));
     p_res(%1,%2,"hiredLabour","wage","",tCur)     = sum(t_n(tCur,nCur), buy_.m("hiredLabour",tCur,nCur));
     p_res(%1,%2,"hiredLabour","cost","",tCur)     = sum((sys,t_n(tCur,nCur)), v_buyCost.l("hiredLabour",sys,tCur,nCur)*p_probN(nCur));
     p_res(%1,%2,"hiredLabour","hours","",tCur)    = sum(t_n(tCur,nCur), v_hireWorkers(tCur,nCur)*%workHoursHired%*p_probN(nCur));
  $$else.hire
     p_res(%1,%2,"hiredLabour","hours","",tCur)    = 0;
  $$endif.hire
*
* --- add total labour
*
  p_res(%1,%2,"crops","hours","",tCur)         = sum( t_n(tCur,nCur), p_probn(nCur)*v_labCrop.l(tCur,nCur));

  $$ifi %herd%==true p_res(%1,%2,"anim","hours","",tCur)          = sum( t_n(tCur,nCur),p_probn(nCur) * v_labHerd.l(tCur,nCur));

  p_res(%1,%2,branches,"hours","",tCur) $ sum(t_n(tCur,nCur),v_hasBranch.l(branches,tCur,nCur))
                            = sum( t_n(tCur,nCur), p_probn(nCur)*( v_hasBranch.l(branches,tCur,nCur)  * p_labManag(branches,"const")
                                                          +  v_branchSize.l(branches,tCur,nCur) * p_labManag(branches,"slope")));

  p_res(%1,%2,"farmManag","hours","",tCur)     = sum( t_n(tCur,nCur), p_probn(nCur)*v_hasFarm.l(tCur,nCur) * p_labManag("Farm","const"));

  $$iftheni.herd %herd%==true

    p_res(%1,%2,"Stable","hours","",tCur)        = sum( (stables,t_n(tCur,nCur),m) $ v_stableInv.up(stables,"long",tCur,nCur),
                                                       p_probn(nCur)
                                                        * v_stableUsed.l(stables,tCur,nCur) * p_stableLab(stables,m) );

  $$endif.herd

  p_res(%1,%2,"onFarm","hours","",tCur)        = sum( t_n(tCur,nCur), p_probn(nCur)* v_labOnFarm.l(tCur,nCur));
  p_res(%1,%2,"onFarm","hours",m,tCur)         = sum( t_n(tCur,nCur),
                                                           v_labCropSM.l(tCur,nCur,m)
                                                         + v_labManag.l(tCur,nCur)/card(m)
                              $$ifi %herd%==true         + v_labHerdM.l(tCur,nCur,m)
                              $$ifi %biogas%== true      + sum((curBhkw(bhkw)), v_labBioGas.l(bhkw,tCur,nCur,m))
                            );
  p_res(%1,%2,"crops","hours",m,tCur)         = sum( t_n(tCur,nCur),p_probn(nCur)*v_labCrop.l(tCur,nCur));
  p_res(%1,%2,"farmManag","hours",m,tCur)     = sum( t_n(tCur,nCur),p_probn(nCur)*v_labManag.l(tCur,nCur)/card(m));
  $$ifi %herd%==true p_res(%1,%2,"anim","hours",m,tCur) = sum( t_n(tCur,nCur),p_probn(nCur) * v_labHerdM.l(tCur,nCur,m));


  p_res(%1,%2,"leisure","hours","",tCur)       = sum(  (leisLevl,t_n(tCur,nCur),m), p_probn(nCur)* v_leisure.l(leisLevl,tCur,nCur,m));


  p_res(%1,%2,"total","hours","",tCur)         =  p_res(%1,%2,"onFarm","hours","",tCur) + p_res(%1,%2,"offFarm","hours","",tCur)
                                               + p_res(%1,%2,"hiredLabour","hours","",tCur);
*
  p_res(%1,%2,"crops","hours","","mean")       =  sum(tCur,p_res(%1,%2,"crops","hours","",tCur))  /p_cardtCur;
  p_res(%1,%2,"anim","hours","","mean")        =  sum(tCur,p_res(%1,%2,"anim","hours","",tCur))   /p_cardtCur;
  p_res(%1,%2,"stable","hours","","mean")      =  sum(tCur,p_res(%1,%2,"stable","hours","",tCur))   /p_cardtCur;
  p_res(%1,%2,"farmManag","hours","","mean")   =  sum(tCur,p_res(%1,%2,"farmManag","hours","",tCur))   /p_cardtCur;
  p_res(%1,%2,"hiredLabour","hours","","mean") =  sum(tCur,p_res(%1,%2,"hiredLabour","hours","",tCur))   /p_cardtCur;

  $$iftheni.bio %biogas% == true
     p_res(%1,%2,branches,"hours","","mean")$(not sameas(branches,"biogas")) =  sum(tCur,p_res(%1,%2,branches,"hours","",tCur))   /p_cardtCur;
  $$else.bio
     p_res(%1,%2,branches,"hours","","mean")=  sum(tCur,p_res(%1,%2,branches,"hours","",tCur))   /p_cardtCur;
  $$endif.bio

  p_res(%1,%2,"onFarm","hours","","mean")    =  sum(tCur,p_res(%1,%2,"onFarm","hours","",tCur)) /p_cardtCur;
  p_res(%1,%2,"leisure","hours","","mean")   =  sum(tCur,p_res(%1,%2,"leisure","hours","",tCur)) /p_cardtCur;
  p_res(%1,%2,"total","hours","","mean")     =  sum(tCur,p_res(%1,%2,"total","hours","",tCur))  /p_cardtCur;

  $$iftheni.herd %herd%==true
*
*    --- Manure amount and N amount from manure
*
     p_res(%1,%2,"manure","IQuant","",tCur)          = sum((curManChain,t_n(tCur,nCur)), p_probn(nCur)*v_manQuant.l(curManChain,tCur,nCur));
     p_res(%1,%2,"manure","IQuant","","mean")        = sum(tCur,p_res(%1,%2,"manure","IQuant","",tCur))/p_cardtCur;
*
*    --- manure store capacity subfloor
*
     p_res(%1,%2,"SubManStorCap","Quant","",tCur)     = sum((curManChain,t_n(tCur,nCur)), p_probn(nCur)*v_SubManStorCap.l(curManChain,tCur,nCur));
     p_res(%1,%2,"SubManStorCap","Quant","","mean")   = sum(tCur,p_res(%1,%2,"SubManStorCap","Quant","",tCur))/p_cardtCur;

*    --- manure store capacity in silo
*
     p_res(%1,%2,"SiloManStorCap","Quant","",tCur)    = sum((curManChain,t_n(tCur,nCur)), p_probn(nCur)*v_SiloManStorCap.l(curManChain,tCur,nCur));
     p_res(%1,%2,"SiloManStorCap","Quant","","mean")  = sum(tCur,p_res(%1,%2,"SiloManStorCap","Quant","",tCur))/p_cardtCur;

*     --- total manure storage capacity

     p_res(%1,%2,"TotalManStorCap","Quant","",tCur)   = sum((curManChain, t_n(tCur,nCur)), p_probn(nCur)*v_TotalManStorCap.l(curManChain,tCur,nCur));
     p_res(%1,%2,"TotalManStorCap","Quant","","mean") = sum(tCur,p_res(%1,%2,"TotalManStorCap","Quant","",tCur))/p_cardtCur;

  $$endif.herd

  p_res(%1,%2,"NApplied",m,"",tCur)             = sum( t_n(tCur,nCur), p_probn(nCur)*v_nutTotalApplied.l("N",tCur,nCur,m));
  p_res(%1,%2,"NMinApplied",m,"",tCur)          = sum ((t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),syntFertilizer) $ p_nutInSynt(syntFertilizer,"N"),
                                                       p_probn(nCur)* v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * p_nutInSynt(syntFertilizer,"N") );

  p_res(%1,%2,"PApplied",m,"",tCur)             = sum( t_n(tCur,nCur), p_probn(nCur)*v_nutTotalApplied.l("P",tCur,nCur,m));
  p_res(%1,%2,"PMinApplied",m,"",tCur)          = sum ((t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),syntFertilizer) $ p_nutInSynt(syntFertilizer,"P"),
                                                       p_probn(nCur)* v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * p_nutInSynt(syntFertilizer,"P") );
  $$iftheni.herd %herd% == true

    p_res(%1,%2,"InStorage",m,"",tCur)
               = sum( (curManChain,t_n(tCur,nCur)), p_probn(nCur)*v_volInStorage.l(curManChain,tCur,nCur,m));

    p_res(%1,%2,ManStorage,m,"",tCur)
            = sum( (curManChain,t_n(tCur,nCur)), p_probn(nCur)*v_volInStorageType.l(curManChain,ManStorage,tCur,nCur,m));

    p_res(%1,%2,manApplicType,m,"",tCur)
         = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),curManType)
                 $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                      p_probn(nCur)*v_manDist.l(crops,plot,till,intens,ManApplicType,curManType,tCur,nCur,m) );

    p_res(%1,%2,nutManApplicType,m,"",tCur)
      = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),
              nutManApplicType_manApplicType(nutManApplicType,manApplicType),
                curManType,nutManApplicType_nut(nutManApplicType,nut))
                     $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                         p_probn(nCur) * v_manDist.l(crops,plot,till,intens,ManApplicType,curManType,tCur,nCur,m)
                     * sum(manChain_applic(manChain,ManApplicType),p_nut2inMan("NTan",curManType,manChain) + p_nut2inMan("Norg",curManType,manChain))$sameas(nut,"N")
                     * sum(manChain_applic(manChain,ManApplicType),p_nut2inMan("P",curManType,manChain) )$sameas(nut,"P"));
  $$endif.herd

  p_res(%1,%2,nFromTToMean,"Quant","",tCur)    = sum(m, p_res(%1,%2,nFromTToMean,m,"",tCur));
  p_res(%1,%2,nFromTToMean,"Quant","","Mean")     = sum(tCur,p_res(%1,%2,nFromTToMean,"Quant","",tCur))/p_cardtCur;

  p_res(%1,%2,nFromTToMean,m,"","Mean")           = sum(tCur,p_res(%1,%2,nFromTToMean,m,"",tCur))/p_cardtCur;

  p_res(%1,%2,curCrops(crops),MeanForCrops,tia,"mean")      $ p_res(%1,%2,crops,"levl",tia,"mean")
          = sum(tCur, p_res(%1,%2,crops,MeanForCrops,tia,tCur) * p_res(%1,%2,crops,"levl",tia,tCur))
                /  (p_res(%1,%2,crops,"levl",tia,"mean")*p_cardtCur);

*  $$ifi %duev%==true $$include 'exploiter/store_duev.gms'

* --- total land for core table

  p_res(%1,%2,"sumLand","Quant","",tCur)   =  sum((t_n(tCur,nCur),crops,sys),p_probn(nCur)*v_sumCrop.l(crops,sys,tCur,nCur));
  p_res(%1,%2,"sumLand","Quant","","mean") =  sum((t_n(tCur,nCur),crops,sys),p_probn(nCur)*v_sumCrop.l(crops,sys,tCur,nCur))/p_cardtCur;


  $$iftheni.herd %herd% == true

*    --- Livestock unit calculation

     p_res(%1,%2,"LUtot","Quant","",tCur)
       = sum(t_n(tCur,nCur), p_probn(nCur)*v_sumGV.l(tCur,nCur));

     p_res(%1,%2,"LUtot","Quant","","mean")
       = sum(tCur, p_res(%1,%2,"LUtot","Quant","",tCur)) /p_cardtCur;

*    --- Livestock units per ha of land

     p_res(%1,%2,"LUperha","Quant","",tCur)  $ sum((t_n(tCur,nCur),plot),v_totPlotLand.l(plot,tCur,nCur))
       = sum(t_n(tCur,nCur), p_probn(nCur)*v_sumGV.l(tCur,nCur))
             / sum((t_n(tCur,nCur),plot),v_totPlotLand.l(plot,tCur,nCur));

     p_res(%1,%2,"LUperha","Quant","","mean") $sum(tCur, p_res(%1,%2,"LUperha","Quant","",tCur))
       = sum(tCur, p_res(%1,%2,"LUperha","Quant","",tCur)) /p_cardtCur;

*    --- Livestock units per herd

     p_res(%1,%2,"LUperherd","Quant",possherds,tCur)
       = sum((breeds,feedRegime,t_n(tCur,nCur),m) $ p_prodLength(possherds,breeds),
          p_probn(nCur) * v_herdSize.l(possherds,breeds,feedRegime,tCur,nCur,m) * p_lu(possherds,breeds) * (1/card(m)));

     p_res(%1,%2,"LUperherd","Quant",possherds,"mean") $sum(tCur, p_res(%1,%2,"LUperherd","Quant",possherds,tCur))
      = sum(tCur, p_res(%1,%2,"LUperherd","Quant",possherds,tCur)) /p_cardtCur;

  $$endif.herd

  $$ifi "%envAcc%"    == "true" $include 'exploiter/store_res_envAcc.gms' "%1%" "%2%"
  $$ifi "%socialAcc%" == "true" $include 'exploiter/store_res_socialAcc.gms' "%1%" "%2%"

* --- NH3 emissions from manure application and different nutrients in storage, per month

  $$iftheni.herd %herd% == true

*      p_res(%1,%2,"applManNH3Mon",m,"",tCur) = sum((curManChain,t_n(tCur,nCur)), p_probn(nCur)*   v_emissions.l(curManChain,"manAppl","NH3",tCur,nCur,m) ) ;
      p_res(%1,%2,"NTANstorage",m,"",tCur)   = sum((curManChain,t_n(tCur,nCur)), p_probn(nCur)*   v_nutPoolInStorage.l(curManChain,"NTAN",tCur,nCur,m))  ;
      p_res(%1,%2,"NOrgStorage",m,"",tCur)   = sum((curManChain,t_n(tCur,nCur)), p_probn(nCur)*   v_nutPoolInStorage.l(curManChain,"NOrg",tCur,nCur,m))  ;
      p_res(%1,%2,"PStorage",m,"",tCur)      = sum((curManChain,t_n(tCur,nCur)), p_probn(nCur)*   v_nutPoolInStorage.l(curManChain,"P",tCur,nCur,m))    ;

  $$endif.herd

* --- Export of manure from farm

  $$iftheni.man %manure% ==true

     $$iftheni.ExMan %AllowManureExport%==true

        p_res(%1,%2,"manExportVol","Quant","",tCur)
           = sum( (curManChain,t_n(tCur,nCur),curManType,m),p_probn(nCur)* v_manExport.l(curManChain,curManType,tCur,nCur,m) ) ;

        p_res(%1,%2,"manExportVol","Quant","","mean")
           = sum( (curManChain,t_n(tCur,nCur),curManType,m),p_probn(nCur)* v_manExport.l(curManChain,curManType,tCur,nCur,m) ) / p_cardtCur ;

        p_res(%1,%2,"manExportN","Quant","",tCur)
           = sum( (curManChain,t_n(tCur,nCur),nut2,m) $ (not sameas (nut2,"P")),p_probn(nCur)*  v_nut2Export.l(curManChain,nut2,tCur,nCur,m) ) ;

        p_res(%1,%2,"manExportN","Quant","","mean")
           = sum( (curManChain,t_n(tCur,nCur),nut2,m) $ (not sameas (nut2,"P")),p_probn(nCur)*  v_nut2Export.l(curManChain,nut2,tCur,nCur,m) ) / p_cardtCur  ;

        p_res(%1,%2,"manExportP","Quant","",tCur)
           = sum( (curManChain,t_n(tCur,nCur),nut2,m) $  sameas (nut2,"P"),p_probn(nCur)*  v_nut2Export.l(curManChain,nut2,tCur,nCur,m) ) ;

        p_res(%1,%2,"manExportP","Quant","","mean")
           = sum( (curManChain,t_n(tCur,nCur),nut2,m) $ sameas (nut2,"P"), p_probn(nCur)* v_nut2Export.l(curManChain,nut2,tCur,nCur,m) ) / p_cardtCur ;

     $$endif.ExMan

     $$iftheni.ExMan %AllowManureImport%==true

        p_res(%1,%2,"manImortVol","Quant","",tCur)    =  sum ( (t_n(tCur,nCur),m,ManImports), v_manImport.l(ManImports,tCur,nCur,m)   ) ;

        p_res(%1,%2,"manImortVol","Quant","","mean")  =  sum ( (t_n(tCur,nCur),m,ManImports), v_manImport.l(manImports,tCur,nCur,m)   ) /p_cardtCur ;

        p_res(%1,%2,"manImportN","Quant","",tCur)     =  sum ( ( t_n(tCur,nCur),nut2,m)  $ (not sameas (nut2,"P")),  v_nut2import.l(nut2,tCur,nCur,m) ) ;

        p_res(%1,%2,"manImportN","Quant","","mean")   =  sum ( ( t_n(tCur,nCur),nut2,m)  $ (not sameas (nut2,"P")),  v_nut2import.l(nut2,tCur,nCur,m) ) /p_cardtCur ;

        p_res(%1,%2,"manImportP","Quant","",tCur)     =  sum ( ( t_n(tCur,nCur),nut2,m)  $  sameas (nut2,"P"),  v_nut2import.l(nut2,tCur,nCur,m) ) ;

        p_res(%1,%2,"manImportP","Quant","","mean")   =  sum ( ( t_n(tCur,nCur),nut2,m)  $  sameas (nut2,"P"),  v_nut2import.l(nut2,tCur,nCur,m) ) /p_cardtCur ;

     $$endif.ExMan

 $$endif.man

 $$ifi "%output_p_res%"=="true"  display p_res;

 $$ifi "%output_p_resCM%"=="true" $batinclude 'exploiter/gen_gm.gms' '%1' '%2' '""'

 $$iftheni.biodiv "%biodiv_ind%"=="true"
    $$batinclude 'exploiter/biodiv_ind_simple.gms' '%1' '%2'
    $$batinclude 'exploiter/biodiv_ind_smart.gms' '%1' '%2'

    $$ifi exist "exploiter/salcaWeights.gdx" $$batinclude 'exploiter/biodiv_ind_salca.gms' '%1' '%2'
 $$endif.biodiv

*$batinclude 'exploiter/gen_CGE_data.gms' '%1' '%2'

 $$ifi "%output_p_resFertVal%"=="true" $batinclude 'exploiter/gen_fert_valid.gms' '%1' '%2' '""'
