*-----------------------------------------------------------------------------------
*
*   Applied Modeling of Agricultural System WS 2020/2021
*
*   Import of SALSA weights, data edited by Eva-Charlotte and do a test calculation
*
*   Author: W.Britz
*
*
*-----------------------------------------------------------------------------------
*
*
*  --- if not commented out, this le the program jump after the preparation of the salca weights
*      to calculate the farm
*
$goto crops
*
* ----------------------------------------------------------------------------------------------------------------------------
*
*
* --- these are the flags for n=null, z=zwinged (requied) and m= (multiple options possible)
*
  acronym n,z,m;
*  ---- read the SALCA weights / grades from EXCEL sheet and store as GDX
*
*$CALL gdxxrw.exe input=kontrolltabelle.xls acronyms=1 cMerge=1 par=p_salcaWeights rng=Kontrolltabelle!A4:CZ4825 rDim=7 cDim=2
*
*  ---- read the identifiers from the generated GAMS parameter
*
set ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,coeffs;

$GDXIN "kontrollTabelle.gdx"
*
* --- load the sets, defined as the list of keys used on the different dimension of the "kontrollTabelle"
*     (Table with impact weights and grades)
*
  $$LOAD ID<=p_salcaWeights.dim1

  $$LOAD habType1<=p_salcaWeights.dim2
  $$LOAD habType2<=p_salcaWeights.dim3

  $$LOAD BewNiv1<=p_salcaWeights.dim4
  $$LOAD BewNiv2<=p_salcaWeights.dim5
  $$LOAD BewNiv3<=p_salcaWeights.dim6

  $$LOAD opt<=p_salcaWeights.dim7

  $$LOAD biodType<=p_salcaWeights.dim8

  $$LOAD coeffs<=p_salcaWeights.dim9

$GDXIN

  alias(id,jd);
  display coeffs;
*
* --- declare the parameter based on the sets defined above and load from GDX
*
  parameter p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,coeffs);
  execute_load "kontrollTabelle.gdx" p_salcaWeights;
$ontext
  p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"Benotung GAV")
   $ (p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"Benotung"))
   =  p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"Benotung");

 p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"Benotung") = 0;

 execute_unload "kontrollTabelle.gdx";
$offtext
*
* --- generate more compact versions where only the ID, the bio-diversity type and the weights/grades etc. are maintained
*
 parameter p_salcaWeigthsCompact(ID,biodType,BewNiv1,*)
           p_salcaWeigthsCompact2(ID,BewNiv1,BewNiv2,biodType,*)
           p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,*)
           p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,coeffs);
*
* --- the ID is a unique identifier for a combination of habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,
*     remove to speed up processing. This allows to quickly loop over the different options
*
  p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,coeffs) $ (not sameas(biodType,"validierung"))
          = sum(ID,p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,coeffs));
*
* --- build a cross set to link the id to the combination of the farm management level (Bewirtschaftungsniveau)
*
 set id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3)
     id_comb2(id,habType1,habType2,BewNiv1,BewNiv2);
*
* --- any combination where a final impact coefficient ("Endkoeffizient") is reported
*
 id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3)
   $ sum( (Opt,biodType), p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"Endkoeffizient")) =  yes;

 id_comb2(id,habType1,habType2,BewNiv1,BewNiv2)
   $ sum( (BewNiv3,Opt,biodType), p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"Endkoeffizient")) =  yes;

 p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,"validierung","Nulloption (n)")
     $  sum(id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3)
             $ p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,"validierung","Nulloption (n)"),1) = n;

*
* --- these are compact version where the habitat types are missing
*
 set id_comb3s(id,BewNiv1,BewNiv2,BewNiv3);

 id_comb3s(id,BewNiv1,BewNiv2,BewNiv3)
   $ sum(id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3),1) = 1;

*
* --- For each habitat type 2, a null option is defined. This has a special meaning as the it can overwrite
*     the average min/max grade x final coefficient over the different bewNiv3 levels, if it shows a higher or lower
*     value.
*
 set nullId(id),nonNullId(id),zId(id),mId(id);

*
* --- the null-id is the one where the a entry is found for "validiergun","Nulloption"
*
 nullId(id) $ sum((id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3),opt)
                $ p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,"validierung","Nulloption (n)"),1) = YES;

 zId(id) $ sum((id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3),opt)
                $ p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,"validierung","zwingend (z)"),1)   = YES;

 nonNullId(id) $ (not nullId(id)) = YES;
*
* --- register a final grade flag for any farm managment - biodiversity type where
*     for one or several options a final grade was found. This helps to find mix/max options
*
  p_salcaWeigthsCompact3(id_comb3s(ID,BewNiv1,BewNiv2,BewNiv3),biodType,"Endkoeffizient")
         $ sum(  (id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3),opt)
                       $ (p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"Endkoeffizient")),1)= YES;

  set grades(coeffs) / "Benotung GAV", "Benotung HÖA" /;
  set minGrades / "minBenotungGAV", "minBenotungHÖA" /;
  set maxGrades / "maxBenotungGAV", "maxBenotungHÖA" /;

  set minMaxGrades / set.minGrades,set.maxGrades /;

  set minmax_grades(*,grades) /
                                     "minBenotungGAV"."Benotung GAV"
                                     "minBenotungHÖA"."Benotung HÖA"
                                     "maxBenotungGAV"."Benotung GAV"
                                     "maxBenotungHÖA"."Benotung HÖA" /;
*
* --- calculate the minimum/maximum of (grades * impact grades) for any options falling into the
*     same niv1,2,3 combination, only considering grades > 1 (exlcude missing value etc).
*     and excluding the null option
*

  p_salcaWeigthsCompact3(id_comb3s(nonNullId(ID),BewNiv1,BewNiv2,BewNiv3),biodType,maxGrades)
    $  [sum( (id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3),opt,minmax_grades(maxGrades,grades))
                        $ (p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades) gt 0),1)
         $ p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,"EndKoeffizient")]
*
*   --- maximum of final coefficient times grade
*
       = smax( (id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3),opt,minmax_grades(maxGrades,grades))
                     $ (p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades) gt 0),
            p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades)
                * p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"EndKoeffizient"));


  set min_to_max(*,*) /
      minBenotungGAV   . maxBenotungGAV
     "minBenotungHÖA" . "maxBenotungHÖA"
 /;

*
* --- introduce minimum grade
*
  p_salcaWeigthsCompact3(id_comb3s(nonNullId(ID),BewNiv1,BewNiv2,BewNiv3),biodType,minGrades)
    $  (sum(min_to_max(minGrades,maxGrades),p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,maxGrades)) $ zId(ID))
*
*   --- minimum of final coefficient times grade
*
       = smin( (id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3),opt,minmax_grades(minGrades,grades))
                      $ ( p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades)
                          $ p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"EndKoeffizient")),
           max(0,p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades))
                * p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"EndKoeffizient"));

  p_salcaWeigthsCompact3(id_comb3s(nonNullId(ID),BewNiv1,BewNiv2,BewNiv3),biodType,minGrades)
    $  (sum(min_to_max(minGrades,maxGrades),p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,maxGrades)) $ (not zId(ID)))
*
*   --- minimum of final coefficient times grade
*
       = smin( (id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3),opt,minmax_grades(minGrades,grades))
                      $ ( (p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades) gt 0)
                          $ p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"EndKoeffizient")),
             p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades)
                * p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"EndKoeffizient"));


  p_salcaWeigthsCompact3(id_comb3s(nonNullId(ID),BewNiv1,BewNiv2,BewNiv3),biodType,minGrades)
     $ [   sum(min_to_max(minGrades,maxGrades),p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,maxGrades))
         $ (not p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,minGrades))] = 1.E-10;

*  execute_unload "test1.gdx" p_salcaWeigthsCompact3;
*
* --- this serves as flag if one of the three grades is present for a ID and biodiversity type
*
 p_salcaWeigthsCompact3(id_comb3s(ID,BewNiv1,BewNiv2,BewNiv3),biodType,"maxBenotung1")
   =  sum(minMaxGrades,p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,minMaxGrades));
*
* -- the combindations of id and the first two management levels
*
  set id_comb2s(id,BewNiv1,BewNiv2);
  id_comb2s(id,BewNiv1,BewNiv2) $ sum(id_comb3s(ID,BewNiv1,BewNiv2,BewNiv3),1) = YES;
*
* --- the combination of ids which belong to the same BewNiv1,BewNiv2 combination
*     (all (BewNiv3,opt) entries for one BewNiv2). This required to check for the dominance of the null-option
*
 set id2_id3(id,id);
 id2_id3(id,jd) $ sum(id_comb3(jd,habType1,habType2,BewNiv1,BewNiv2,BewNiv3) $ id_comb2(id,habType1,habType2,BewNiv1,BewNiv2),1) = YES;

 set count / countGAV,"CountHÖA" /;
 set count_grades(count,*) /

                                        "countGAV"."minBenotungGAV"
                                        "countHÖA"."minBenotungHÖA"

                                        "countGAV"."maxBenotungGAV"
                                        "countHÖA"."maxBenotungHÖA"
                                      /;
*
* --- add over the impact grade at BewNiv3 level, for all options (IDs) at BewNiv3 found for a BewNiv2 level
*
 p_salcaWeigthsCompact2(id_comb2s(Id(ID),BewNiv1,BewNiv2),biodType,minMaxGrades)
    =  sum( (id_comb3s(nonNullId(jd),BewNiv1,BewNiv2,BewNiv3)) $  id2_id3(id,jd),
                   p_salcaWeigthsCompact3(jd,BewNiv1,BewNiv2,BewNiv3,biodType,minMaxGrades));
*
* --- add over BewNiv3, and count the # of min/max grades at BewNiv3 found for a BewNiv2 level
*
 p_salcaWeigthsCompact2(id_comb2s(ID,BewNiv1,BewNiv2),biodType,count)
    =  sum( (id_comb3s(nonNullId(jd),BewNiv1,BewNiv2,BewNiv3),count_grades(count,minGrades))
               $  (p_salcaWeigthsCompact3(jd,BewNiv1,BewNiv2,BewNiv3,biodType,minGrades) $ id2_id3(id,jd)),1);
*
* --- calculate the grade x impact for the null option for each ID-BewNiv-BewNiv2 combination and bio-diversity
*
 parameter p_salcaWeigthsNullOptions(ID,BewNiv1,BewNiv2,biodType,*);

 p_salcaWeigthsNullOptions(ID,BewNiv1,BewNiv2,biodType,minMaxGrades)
    $  sum( (id_comb2(id,habType1,habType2,BewNiv1,BewNiv2),BewNiv3,opt,minmax_grades(minmaxGrades,grades))
                  $ ( (p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,"Validierung","Nulloption (n)"))
                        $ (p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades) gt 0)),1)
     = sum( (id_comb2(id,habType1,habType2,BewNiv1,BewNiv2),BewNiv3,opt,minmax_grades(minMaxGrades,grades))
                  $ ( (p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,"Validierung","Nulloption (n)"))
                        $ (p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades) gt 0)),
                   p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades)
                * p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"EndKoeffizient"));
*
* --- remove any BewNiv3 grades (for all options), if the null option is equal or better respectively worse
*
  p_salcaWeigthsCompact3(id_comb3s(ID,BewNiv1,BewNiv2,BewNiv3),biodType,maxGrades)
      $  ( ( ( p_salcaWeigthsCompact2(ID,BewNiv1,BewNiv2,biodType,maxGrades)
                  /sum(count_grades(count,maxGrades), p_salcaWeigthsCompact2(ID,BewNiv1,BewNiv2,biodType,count)))
             le p_salcaWeigthsNullOptions(ID,BewNiv1,BewNiv2,biodType,maxGrades))
                $ p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,maxGrades))
              =  0;

  p_salcaWeigthsCompact3(id_comb3s(ID,BewNiv1,BewNiv2,BewNiv3),biodType,minGrades)
      $  ( ( ( p_salcaWeigthsCompact2(ID,BewNiv1,BewNiv2,biodType,minGrades)
                  /sum(count_grades(count,minGrades), p_salcaWeigthsCompact2(ID,BewNiv1,BewNiv2,biodType,count)))
             ge p_salcaWeigthsNullOptions(ID,BewNiv1,BewNiv2,biodType,minGrades))
*               --- attention: we need a non-zero grade, otherwise, all minimum grade are removed
                $ p_salcaWeigthsNullOptions(ID,BewNiv1,BewNiv2,biodType,minGrades)
                $ p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,minGrades))
              =  0;
*
* ---- introduce the null option if no max/min grade is given for all otions at BewNiv3
*
  p_salcaWeigthsCompact3(id_comb3s(ID,BewNiv1,BewNiv2,BewNiv3),biodType,minMaxGrades)
       $ (sum(id2_id3(id,jd) $ id_comb3s(jd,BewNiv1,BewNiv2,BewNiv3),
             p_salcaWeigthsCompact3(jd,BewNiv1,BewNiv2,BewNiv3,biodType,minMaxGrades)) eq 0)
    =

    sum( (id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3),opt,minMax_grades(minMaxGrades,grades))
               $ ((p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades) gt 0)
                   $ p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,"Validierung","Nulloption (n)")),
                      p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades)
                           $ (p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,grades) gt 0)
                        * p_salcaWeights1(habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,"EndKoeffizient"));

*
* --- add the null-id the flag counter "maxBenotung1"
*
  p_salcaWeigthsCompact3(id_comb3s(ID,BewNiv1,BewNiv2,BewNiv3),biodType,"maxBenotung1")
     $ (sum(minMaxGrades,p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,minMaxGrades))) = yes;

  p_salcaWeigthsCompact3(id_comb3s(ID,BewNiv1,BewNiv2,BewNiv3),biodType,"Endkoeffizient") = 0;

  p_salcaWeigthsCompact3(id_comb3s(ID,BewNiv1,BewNiv2,BewNiv3),biodType,minGrades)
     $ (p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,minGrades) eq 1.E-10) = 0;
*
* --- generate a compact version, where only the first level farm management category is maintained,
*     first copy the original coefficients from the Kontrolltabelle, this will be used to retrieve
*     grades/impacts by ID for the current farm program
*
  set outPutBiodType(biodType);
  outPutBiodType(biodType)      = YES;
  outPutBiodType("validierung") = NO;
*
* --- copy the coefficients from the controll table a compact version where only the ID and the first
*     farm management level is reported
*
  p_salcaWeigthsCompact(ID,outPutbiodType,BewNiv1,coeffs)
     = sum( (id_comb3(id,habType1,habType2,BewNiv1,BewNiv2,BewNiv3),opt)
                  $ (p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,outPutbiodType,"maxBenotung1")
                        $ (p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,outPutbiodType,coeffs) gt 0)),
                               p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,outPutbiodType,coeffs));
*
* --- add the min/max grade
*
  p_salcaWeigthsCompact(ID,outPutbiodType,BewNiv1,minMaxGrades)
     = sum( (BewNiv2,BewNiv3) $  p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,outPutbiodType,"maxBenotung1"),
                           p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,outPutbiodType,minMaxGrades));
*
* --- same, but with information for the three different detailed farm management levels
*     (mainly for debugging purposes)
*
  p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,coeffs)
            = sum( (habType1,habType2,Opt) $ (p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,"maxBenotung1")
                      $ (p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,coeffs) gt 0)),
                   p_salcaWeights(ID,habType1,habType2,BewNiv1,BewNiv2,BewNiv3,Opt,biodType,coeffs));
*
* --- store in a GDX for later usage
*
  execute_unload "salcaWeights.gdx" p_salcaWeigthsCompact,p_salcaWeigthsCompact3,ID,biodType,BewNiv1,BewNiv2,BewNiv3,coeffs,minMaxGrades;
$exit

* ------------------------------------------------------------------------------
*
*    input of the crop data and test application
*
* ------------------------------------------------------------------------------

$label crops

 set dummySum / Summary /;


$iftheni.definedID not defined i

*
* --- load the necessary sets from GDX generated above
*
  Set id,BewNiv1,BewNiv2,BewNiv3,biodType,BewNiv1coeffs,coeffs,minMaxGrades;
$GDXIN "exploiter/salcaWeights.gdx"
  $$LOAD ID BewNiv1 BewNiv2 BewNiv3 biodType coeffs minMaxGrades
$GDXIN

$onmulti
  Set coeffs /set.minMaxGrades /;
$offmulti
*
* --- load the salca weights and grades
*
  parameter p_salcaWeigthsCompact(ID,biodType,BewNiv1,coeffs)
            p_salcaWeigthsCompact3(ID,BewNiv1,BewNiv2,BewNiv3,biodType,coeffs);
  execute_load  "exploiter/salcaWeights.gdx" p_salcaWeigthsCompact,p_salcaWeigthsCompact3;

  parameter p_ha(crops,sys);
  parameter p_salcaInv(id,*,sys);

  execute_load "exploiter/biod_ind_salca_inv.gdx" p_salcaInv;

  p_salcaInv(ID,"CCMustardAES",sys)         = p_salcaInv(ID,"CCMustard",sys);
  p_salcaInv(ID,"CCMustardAESGreening",sys) = p_salcaInv(ID,"CCMustard",sys);


  set cropsWithSalcaData(crops,sys);
  set cropsInSolution(crops,sys);

  parameter p_salcaRes(*,*,*,*,*,*,*)
            p_salcaRes3(*,*,*,*,*,*,*,*,*);
  set grades(coeffs) / "Benotung GAV","Benotung HÖA" /;
  set outComes / cur,min,max /;

  parameter p_salcaSummary;

  set output / set.crops,total /;

  set OutComesPot /set.outcomes,pot /;

  set salcaInd /
          cur_GAV
          min_gav
          max_gav
          "pot_gav"

          "cur_HOA"
          min_HOA
          max_HOA
          "pot_HOA"

          "cur_AVG"
          min_AVG
          max_AVG
          "pot_AVG"
/;

  set impactCat / impactGAV,"impactHÖA" /;
  set impactCatAvg / set.impactCat,impactAvg /;

  set salcaInd_outcomes_impactCat(salcaInd,outcomesPot,impactCatAvg) /

          cur_GAV       .cur   .impactGAV
          min_gav       .min   .impactGAV
          max_gav       .max   .impactGAV
          "pot_gav"     .pot   .impactGAV

          "cur_HOA"     .cur   ."impactHÖA"
          min_HOA       .min   ."impactHÖA"
          max_HOA       .max   ."impactHÖA"
          "pot_HOA"     .pot   ."impactHÖA"

          "cur_AVG"     .cur   ."impactAVG"
          min_AVG       .min   ."impactAVG"
          max_AVG       .max   ."impactAVG"
          "pot_AVG"     .pot   ."impactAVG"
  /;


$endif.definedID


$iftheni.gras defined grasOutputs

 set dummyGras / gras4_14_4cuts_sil100,gras2_12_graz100 /;


*
* -- copy inventory for gras type with 4 cuts
*
 p_salcaInv(ID,grassCrops,sys) $ (sum( (grasOutputs,m) $ ((not grazOutputs(grasoutputs)) $ p_grasAttr(grassCrops,grasOutputs,m)),1) eq 4)
   =  p_salcaInv(ID,"gras4_14_4cuts_sil100",sys);

*
* -- copy inventory for gras type with 7 months of grazing
*
 p_salcaInv(ID,grassCrops,sys) $ (sum( (grazOutputs,m) $ p_grasAttr(grassCrops,grazOutputs,m),1) eq 7)
   =  p_salcaInv(ID,"gras2_12_graz100",sys);

$endif.gras
*
* --- load the ID-to-crop parameter generated by the EXCEL->GDX utility above (the execute_loadpoint appends)
*
  p_ha(curCrops,sys) =   sum((plot,sys_till(sys,till),t_n(tCur,nCur),intens),
                              v_cropHa.l(curCrops,plot,till,intens,tCur,nCur)*p_probn(nCur))/card(tCur);

  cropsWithSalcaData(curCrops,sys) $ sum(id, p_salcaInv(ID,curCrops,sys)) = YES;

  cropsInSolution(curCrops,sys) $ p_ha(curCrops,sys) = YES;

  if ( sum( cropsInSolution(curCrops,sys) $ (not cropsWithSalcaData(curCrops,sys)),1),

     cropsInSolution(cropsWithSalcaData(curCrops,sys)) = no;
     display "Warning: Salca inventory for some crops missing ",cropsInSolution;
  );

*
* --- copy the detailed information (min/max/grade information)
*
  p_salcaRes3(crops,sys,id,biodType,BewNiv1,BewNiv2,BewNiv3,"cur",coeffs) $ (p_salcaInv(id,crops,sys) $ p_ha(crops,sys))
     = p_salcaWeigthsCompact3(id,BewNiv1,BewNiv2,BewNiv3,biodType,coeffs);
*
* --- store ha and report salca weights for the different field operations (including the min/max)
*
  p_salcaRes(crops,sys,"ha","","","","")         = p_ha(crops,sys);
*
* --- load original coefficients, and min/max grades times impact for any ID performed in the management of the crop
*
  p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur",coeffs)      $ (p_salcaInv(id,curCrops,sys) $ p_ha(curCrops,sys))
     = p_salcaWeigthsCompact(id,biodType,BewNiv1,coeffs);

*
* ----- count the # of current grades (i.e.number of IDs performed in the management of the crop for which
*       grades > 0 are available in the Kontrolltabelle)

  p_salcaRes(curCrops,sys,"",biodType,BewNiv1,"cur","CountGAV") $ p_ha(curCrops,sys)
     = sum (  ID $ (p_salcaInv(id,curCrops,sys) $ (p_salcaWeigthsCompact(id,biodType,BewNiv1,"Benotung GAV") gt 0)),1);

  p_salcaRes(curCrops,sys,"",biodType,BewNiv1,"cur","CountHÖA") $ p_ha(curCrops,sys)
     = sum (  ID $ (p_salcaInv(id,curCrops,sys) $ (p_salcaWeigthsCompact(id,biodType,BewNiv1,"Benotung HÖA") gt 0)),1);
*
* ----- count the # of current and minimum coefficients (= maximal coefficients)
*
  p_salcaRes(curCrops,sys,"",biodType,BewNiv1,"min","CountGAV") $ p_ha(curCrops,sys)
     = sum (  ID $ (p_salcaInv(id,curCrops,sys) $ (p_salcaWeigthsCompact(id,biodType,BewNiv1,"minBenotungGAV") gt 0)),1);

  p_salcaRes(curCrops,sys,"",biodType,BewNiv1,"min","CountHÖA") $ p_ha(curCrops,sys)
     = sum (  ID $ (p_salcaInv(id,curCrops,sys) $ (p_salcaWeigthsCompact(id,biodType,BewNiv1,"minBenotungHÖA") gt 0)),1);

  p_salcaRes(curCrops,sys,"",biodType,BewNiv1,"max","CountGAV") $ p_ha(curCrops,sys)
     = sum (  ID $ (p_salcaInv(id,curCrops,sys) $ (p_salcaWeigthsCompact(id,biodType,BewNiv1,"maxBenotungGAV") gt 0)),1);

  p_salcaRes(curCrops,sys,"",biodType,BewNiv1,"max","CountHÖA") $ p_ha(curCrops,sys)
     = sum (  ID $ (p_salcaInv(id,curCrops,sys) $ (p_salcaWeigthsCompact(id,biodType,BewNiv1,"maxBenotungHÖA") gt 0)),1);
*
*  --- the sum over bewNiv2/3 of impact (= Endkoeffizient) and the grade
*
  p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"impactSumGAV")
     = sum(id $ p_salcaInv(id,curCrops,sys),
*                  -- for current, we need to weight the grade with the final coefficient "Endkoeffizient"
                    (p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur","Benotung GAV") $ (p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur","Benotung GAV")  gt 0)
                        *p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur","Endkoeffizient"))
                                                                                   $ sameas(outComes,"cur")
*                  -- for min/max, the sum of the bevNiv2/Niv3 is done already in the first step above
                    + p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur","minBenotungGAV") $ sameas(outComes,"min")
                    + p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur","maxBenotungGAV") $ sameas(outComes,"max"));

  p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"impactSumHÖA")
     = sum(id $ p_salcaInv(id,curCrops,sys),
*                  -- for current, we need to weight the grade with the final coefficient "Endkoeffizient"
                    (p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur","Benotung HÖA") $ (p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur","Benotung HÖA")  gt 0)
                      *p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur","Endkoeffizient"))
                                                                                   $ sameas(outComes,"cur")
*                  -- for min/max, the sum of the bevNiv2/Niv3 is done already in the first step
                    + p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur","minBenotungHÖA") $ sameas(outComes,"min")
                    + p_salcaRes(curCrops,sys,id,biodType,BewNiv1,"cur","maxBenotungHÖA") $ sameas(outComes,"max"));
*
*  --- calculate the average impact for BewNiv1
*
  p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"impactGAV") $ p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"countGAV")
   = p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"impactSumGAV")/p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"countGAV");

  p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"impactHÖA") $ p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"countHÖA")
   = p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"impactSumHÖA")/p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"countHÖA");
*
* --- calculate the average impact of all farm management (sum over BewNiv1, i.e. each ID has the same weight)
*
  p_salcaRes(curCrops,sys,"",biodType,"",outComes,"impactGAV") $ sum(BewNiv1,p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"countGAV"))
   = sum(BewNiv1,p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"impactSumGAV"))
   / sum(BewNiv1,p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"countGAV"));

  p_salcaRes(curCrops,sys,"",biodType,"",outComes,"impactHÖA") $ sum(BewNiv1,p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"countHÖA"))
   = sum(BewNiv1,p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"impactSumHÖA"))
   / sum(BewNiv1,p_salcaRes(curCrops,sys,"",biodType,BewNiv1,outComes,"countHÖA"));
*
* --- distribute catch crops to summer crops, first calculate share of catchcrops on total
*     hectares of summer crops
*
  p_salcaRes(catchCrops(curCrops),sys,"ccShare","","","","") $ p_salcaRes(curCrops,sys,"ha","","","","")
   =  p_salcaRes(curCrops,sys,"ha","","","","")
        / sum(summerHarvest, p_salcaRes(summerHarvest,sys,"ha","","","",""));

  p_salcaRes(summerHarvest,sys,"nonCCShare","","","","") $ p_salcaRes(summerHarvest,sys,"ha","","","","")
   =  1 - sum(catchCrops(curCrops),p_salcaRes(curCrops,sys,"ccShare","","","",""));
*
* --- calculate the impact for the summer harvest crops which share the cropping season with
*     a catch crop. The following set are the species classes where the minimum outcome
*     from the catch crops and the main crop is used, otherwise, a simple average is used
*
  set minWgtType(biodType) /
         "Amphibien"
         "Mollusken"
         "Spinnen"
         "Laufkäfer"
  /;

  p_salcaRes(summerHarvest,sys,"",biodType,"",outComes,impactCat) $ p_salcaRes(summerHarvest,sys,"ha","","","","")
    =
*
*       --- this the share of of the summer harvest crop accompanied with the catch crops
*
        sum(catchCrops(curCrops),  p_salcaRes(catchCrops,sys,"ccShare","","","","")
             *[  (  p_salcaRes(summerHarvest,sys,"",biodType,"",outComes,impactCat)
                  + p_salcaRes(catchCrops   ,sys,"",biodType,"",outComes,impactCat))*0.5
                    $ [ (not minWgtType(biodType))  $ p_salcaRes(summerHarvest,sys,"",biodType,"",outComes,impactCat)
                                                    $ p_salcaRes(catchCrops   ,sys,"",biodType,"",outComes,impactCat)]

               + min(  p_salcaRes(summerHarvest,sys,"",biodType,"",outComes,impactCat),
                       p_salcaRes(catchCrops   ,sys,"",biodType,"",outComes,impactCat))
                   $ [ minWgtType(biodType)   or (   (not p_salcaRes(summerHarvest,sys,"",biodType,"",outComes,impactCat))
                                                  or (not p_salcaRes(catchCrops   ,sys,"",biodType,"",outComes,impactCat)))]
               ])
*
*       --- remaining area, main crop alone
*
     + p_salcaRes(summerHarvest,sys,"nonCCShare","","","","") * p_salcaRes(summerHarvest,sys,"",biodType,"",outComes,impactCat);
*
* --- calculate average impact at farm level, using the crop hectares as weight
*
   p_salcaRes("total","","",biodType,"",outComes,impactCat)
      = sum((curCrops,sys) $ (not catchCrops(curCrops)), p_salcaRes(curCrops,sys,"",biodType,"",outComes,impactCat)  * p_salcaRes(curCrops,sys,"ha","","","",""))
      / sum((curCrops,sys) $ (not catchCrops(curCrops)), p_salcaRes(curCrops,sys,"ha","","","",""));
*
* --- summarize the results
*
  p_salcaSummary("total",biodType,outComes,impactCat)
     = p_salcaRes("total","","",biodType,"",outComes,impactCat);

  p_salcaSummary(curCrops,biodType,outComes,impactCat)
     = sum(sys,p_salcaRes(curCrops,sys,"",biodType,"",outComes,impactCat));
*
* --- calculate the potential for each crop and the farm as a total
*
  p_salcaSummary(output,biodType,"pot",impactCat)
   $ (p_salcaSummary(output,biodType,"max",impactCat)-p_salcaSummary(output,biodType,"min",impactCat))
      =  (p_salcaSummary(output,biodType,"cur",impactCat)-p_salcaSummary(output,biodType,"min",impactCat))
        / (p_salcaSummary(output,biodType,"max",impactCat)-p_salcaSummary(output,biodType,"min",impactCat)) * 100;

  p_salcaSummary(output,biodType,OutComesPot,"impactAVG")
     $ sum( impactCat,p_salcaSummary(output,biodType,OutComesPot,impactCat))
    = sum( impactCat,p_salcaSummary(output,biodType,OutComesPot,impactCat))
     / sum( impactCat $ p_salcaSummary(output,biodType,OutComesPot,impactCat),1);





set HA_GAV_AVG / "HÖA",GAV,AVG /;



  set biodType_e /
        "Grassland flora"
        "Flora arable land"
        Birds
        "Small mammals"
        "Amphibians"
        "Mollusks"
        "Spiders"
        "Ground beetles"
        "Butterflies"
        "Wild bees"
        "Grasshoppers"
  /;

  set transLate(biodtype_e,biodType) /

      "Flora arable land"  . Ackerflora
      "Grassland flora"    . Graslandflora
      Birds                . "Vögel"
      "Small mammals"      . "Kleinsäuger"
      "Amphibians"         . "Amphibien"
      "Mollusks"           . "Mollusken"
      "Spiders"            . "Spinnen"
      "Ground beetles"     . "Laufkäfer"
      "Butterflies"        . "Tagfalter"
      "Wild bees"          . "Wildbienen"
      "Grasshoppers"       . "Heuschrecken"
  /;
*
* --- copy over to result parameter used by GUI and translate into english
*
  p_res(%1,%2,output,biodType_e,salcaInd,"mean")
    = sum((transLate(biodType_e,biodType),salcaInd_outComes_impactCat(salcaInd,outcomesPot,impactCatAvg)),
         p_salcaSummary(output,biodType,outComesPot,impactCatAvg) );

table p_biodTypeWeights(biodType_e,HA_GAV_AVG)


                              "HÖA"    GAV     AVG
    "Flora arable land"                10.0    10.0
    "Grassland flora"                   8.5     8.5
    Birds                               5.1     5.1
    "Small mammals"                     4.1     4.1
    "Amphibians"               3.1      3.1     3.1
    "Mollusks"                 5.3      5.3     5.3
    "Spiders"                  6.8      6.8     6.8
    "Ground beetles"           6.8      6.8     6.8
    "Butterflies"              6.0      6.0     6.0
    "Wild bees"                         6.4     6.4
    "Grasshoppers"             5.0      5.0     5.0
;

  set salcaInd_HA_GAV_AVG(salcaInd,HA_GAV_AVG) /

          cur_GAV       .GAV
          min_gav       .GAV
          max_gav       .GAV
          "pot_gav"     .GAV

          "cur_HOA"     ."HÖA"
          min_HOA       ."HÖA"
          max_HOA       ."HÖA"
          "pot_HOA"     ."HÖA"

          "cur_AVG"     ."AVG"
          min_AVG       ."AVG"
          max_AVG       ."AVG"
          "pot_AVG"     ."AVG"
  /;

  p_res(%1,%2,crops,"Summary","ha","mean")  = sum(sys, p_ha(crops,sys));

  p_res(%1,%2,output,"Summary",salcaInd,"mean") $ sum(biodType_e,p_res(%1,%2,output,biodType_e,salcaInd,"mean"))
    = sum(biodType_e,   p_res(%1,%2,output,biodType_e,salcaInd,"mean")
                           * sum(salcaInd_HA_GAV_AVG(salcaInd,HA_GAV_AVG),p_biodTypeWeights(biodType_e,HA_GAV_AVG)))
    / sum(biodType_e,        sum(salcaInd_HA_GAV_AVG(salcaInd,HA_GAV_AVG),p_biodTypeWeights(biodType_e,HA_GAV_AVG)));


  display p_salcaRes,p_salcaSummary,p_res;
*  execute_unload "test.gdx" p_salcaRes,p_salcaSummary;
