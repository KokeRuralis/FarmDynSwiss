********************************************************************************
$ontext

   FARMDYN project

   GAMS file : TEMPL.GMS

   @purpose  : Calculation of production factors in relation to output for CGE

   @author   : T.Kuhn,
   @date     : 15.07.21
   @since    :
   @refDoc   :
   @seeAlso  :
   @calledBy : store_res.gms

$offtext
********************************************************************************


   set factor / labor,land,capital,capital_Inputs,capital_inves,capital_mach,capital_activ,capital_allVarCos /;

   set crops_prods(crops,prods);
       crops_prods(grain_wheat,prods) $ sameas(grain_wheat,prods) = YES;
       crops_prods(potatoes,prods) $ sameas(potatoes,prods) = YES;
       crops_prods(sugarbeet,prods) $ sameas(sugarbeet,prods) = YES;

   set allocCrops(crops)   / CCclover,CCmustard,CCmustardAES,CCmustardAESGreening
                $$ifthen.env  %agriEnvSchemes%==true
                   ,flowerStrip,flowerStripGre,waterStrip,waterStripGre
                $$endif.env
                      /;

parameter
       p_resCGE(crops,factor,t)         "Production factors related to crops in ha"
       p_resOut(prods,t)                "Produced output"
       p_resCGEprods(prods,factor,t)    "Production factors realted to output"
;

* ---- Define allocation factors for different cropping activities according to
*      their observed crop shares

Parameter p_sumLand ;

   p_sumLand =   sum ( ( t_n(tCur,nCur), c_p_t_i(crops,plot,till,intens)) $ ((not catchCrops(crops))
                    $$ifthen.env  %agriEnvSchemes%==true
                                $ (not strips(crops))
                     $$endif.env
                                $ arabCrops(crops) or grassCrops(crops) )  , v_cropHa.l(crops,plot,till,intens,tCur,nCur) ) ;


parameter p_cropAlloc(crops,factor);

   p_cropAlloc(crops,factor) = sum ( ( t_n(tCur,nCur), c_p_t_i(crops,plot,till,intens)) $ ((not catchCrops(crops))
                   $$ifthen.env  %agriEnvSchemes%==true
                                      $ (not strips(crops))
                    $$endif.env
                                   $ arabCrops(crops) or grassCrops(crops) )  , v_cropHa.l(crops,plot,till,intens,tCur,nCur) )
                                             /  p_sumLand
                  ;

* --- LAND: Calculation of the land needed for different outputs, allocate unspecific land use from agri-environemtnal policies according
*     to the crop shares

    p_resCGE(crops,"land",tCur) =  sum ( ( t_n(tCur,nCur), c_p_t_i(crops,plot,till,intens)) $ ((not catchCrops(crops))
                    $$ifthen.env  %agriEnvSchemes%==true
                                      $ (not strips(crops))
                    $$endif.env
                                $ arabCrops(crops) or grassCrops(crops) )  , v_cropHa.l(crops,plot,till,intens,tCur,nCur) )

$ifthen.env  %agriEnvSchemes%==true
                                +  sum ( (t_n(tCur,nCur),c_p_t_i(strips,plot,till,intens)) , v_cropHa.l(strips,plot,till,intens,tCur,nCur))
                                                         *      p_cropAlloc(crops,"land")


$endif.env
      ;


* --- LABOR: Calculation of labor needs for different outputs, allocate unspecyfied labor need (incl. agri-environmental measures)
*     according to crop shares

    p_resCGE(crops,"labor",tCur) =


      sum( (c_p_t_i(curCrops(crops),plot,till,intens),t_n(tCur,nCur),m) $ ((not catchCrops(crops))
                      $$ifthen.env  %agriEnvSchemes%==true
                                        $ (not strips(crops))
                      $$endif.env
                      ), v_cropHa.l(crops,plot,till,intens,tCur,nCur) * p_cropLab(crops,till,intens,m))


$iftheni.man %manure% == true
*
*        --- labour need for application of manure
*            (considers all field operations not out-sourced as contract work,
*             with the exemption of manure and synt fertizer application)
*
           + sum((c_p_t_i(curCrops(crops),plot,till,intens),manApplicType_manType(ManApplicType,curManType),m,t_n(tCur,nCur))
                  $ ((v_cropHa.up(crops,plot,till,intens,tCur,nCur) ne 0)
                    $ ( v_manDist.up(crops,plot,till,intens,ManApplicType,curManType,t,nCur,m) ne 0)
                    $ ((not catchCrops(crops))
                                    $$ifthen.env  %agriEnvSchemes%==true
                                                      $ (not strips(crops))
                                    $$endif.env
                                    ), v_manDist.l(crops,plot,till,intens,ManApplicType,curManType,tCur,nCur,m) * p_manDistLab(ManApplicType)
$endif.man
*
*  --- labour need for spreading synthetic fertilizer
*
        + sum((c_p_t_i(crops,plot,till,intens),curInputs(syntFertilizer),m,t_n(tCur,nCur)) $ ( (not catchCrops(crops))
           $$ifthen.env  %agriEnvSchemes%==true
                          $ (not strips(crops))
            $$endif.env
                    )  , v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * p_syntDistLab(syntFertilizer))

*  --- Labour need for management, allocated

                + sum (t_n(tCur,nCur), v_labManag.l(tCur,nCur)) *  p_cropAlloc(crops,"labor")

* --- Labour need for agri-environmental measures, allocated to cropping activities

               + [ sum( (c_p_t_i(catchCrops,plot,till,intens),t_n(tCur,nCur),m),
                            v_cropHa.l(catchCrops,plot,till,intens,tCur,nCur) * p_cropLab(catchCrops,till,intens,m) )

                  $$ifthen.env  %agriEnvSchemes%==true
               +  sum( (c_p_t_i(strips,plot,till,intens),t_n(tCur,nCur),m),
                 v_cropHa.l(strips,plot,till,intens,tCur,nCur) * p_cropLab(strips,till,intens,m) )
                   $$endif.env
                  ]  *      p_cropAlloc(crops,"labor")

                               ;



* --- CAPITAL: Calculation of capital need for different outputs, allocate unspecified capital need and agri-env. meausres
*     according to crop shares to cropping activites

* --- CAPITAL FOR INPUTS

    p_resCGE(crops,"capital_inputs",tCur)  $ curcrops(crops) =

* --- COSTS FOR INPUTS

     sum( (c_p_t_i(curCrops(crops),plot,till,intens),inputs,t_n(tCur,nCur)) $ ( p_costQuant(crops,till,intens,inputs)  $ (not allocCrops(crops))  )
           ,  v_cropHa.l(crops,plot,till,intens,tCur,nCur) * p_costQuant(crops,till,intens,inputs) * v_costQuant(crops,inputs) * p_inputprice(inputs,"conv",tCur) )

*  --- Cost synthetic fertilizer

    + sum(  (c_p_t_i(curCrops(crops),plot,till,intens),sameas(inputs,syntFertilizer),t_n(tCur,nCur),m),
                       v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * p_inputprice(inputs,"conv",tCur) )

*  --- variable costs for diesel from tractor

        + sum( (curMachines(machType),t_n(tCur,nCur)),

               sum( c_p_t_i(curCrops(crops),plot,till,intens) $ ( (not allocCrops(crops)) )
                      , v_cropHa.l(crops,plot,till,intens,tCur,nCur)
                       * p_machNeed(crops,till,intens,machType,"hour"))

                        * p_machAttr(machType,"diesel_h") * p_inputprice("diesel","conv",tCur) )

         + sum( (c_p_t_i(curCrops(crops),plot,till,intens),curMachines(machType),curInputs(syntFertilizer),t_n(tCur,nCur),m),
                               v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * (1 + m.pos*1.E-3)
                                  * p_machNeed(syntFertilizer,till,"normal",machType,"hour")
                                     * p_machAttr(machType,"diesel_h") * p_inputprice("diesel","conv",tCur) )


      + [
        sum( (c_p_t_i(allocCrops,plot,till,intens),inputs,t_n(tCur,nCur)) $ ( p_costQuant(allocCrops,till,intens,inputs))
                ,  v_cropHa.l(allocCrops,plot,till,intens,tCur,nCur) * p_costQuant(allocCrops,till,intens,inputs)
                              * v_costQuant(allocCrops,inputs) * p_inputprice(inputs,"conv",tCur) )
      +
            sum( (curMachines(machType),t_n(tCur,nCur)),

                    sum( c_p_t_i(allocCrops,plot,till,intens)
                         , v_cropHa.l(allocCrops,plot,till,intens,tCur,nCur)
                            * p_machNeed(allocCrops,till,intens,machType,"hour"))

                             * p_machAttr(machType,"diesel_h") * p_inputprice("diesel","conv",tCur) )

                        ]

                          *      p_cropAlloc(crops,"capital")

             ;

* --- CAPITAL FOR INVESTMENTS


p_resCGE(crops,"capital_inves",tCur)  $ curcrops(crops) =

   sum( (c_p_t_i(curCrops(crops),plot,till,intens),machLifeUnit,machType,t_n(tCur,nCur))
            $ ( p_lifeTimeM(machType,MachLifeUnit) $ (not allocCrops(crops)) ) ,
        v_cropHa.l(crops,plot,till,intens,tCur,nCur)
          * p_machNeed(crops,till,intens,machType,machLifeUnit)
             / p_lifeTimeM(machType,MachLifeUnit)
                *  p_priceMach(machType,tCur) * p_vPriceInv("machines")
                     )

     + sum (t_n(tCur,nCur), v_costInv("bunkerSilo450",tCur,nCur) + v_costInv("bunkerSilo26550",tCur,nCur) )
     $sum(maizSilage, sameas(crops,maizSilage))

     + sum (t_n(tCur,nCur), v_costInv("potaStore100t",tCur,nCur) + v_costInv("potaStore500t",tCur,nCur)
                  + v_costInv("potaStore11250t",tCur,nCur) )
                  $sum(potatoes, sameas(crops,potatoes))

     +  sum( (c_p_t_i(curCrops(crops),plot,till,intens),curInputs(syntFertilizer),m,machLifeUnit,machType,t_n(tCur,nCur))
                      $ ( p_lifeTimeM(machType,MachLifeUnit) $ (not allocCrops(crops)) ),
               v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * (1 + m.pos*1.E-3)
                  * p_machNeed(syntFertilizer,till,"normal",machType,machLifeUnit)
                    /  p_lifeTimeM(machType,MachLifeUnit)
                       *  p_priceMach(machType,tCur) * p_vPriceInv("machines")
                            )
       +  [ sum( (c_p_t_i(allocCrops,plot,till,intens),machLifeUnit,machType,t_n(tCur,nCur))
                $ p_lifeTimeM(machType,MachLifeUnit)  ,
            v_cropHa.l(allocCrops,plot,till,intens,tCur,nCur)
              * p_machNeed(allocCrops,till,intens,machType,machLifeUnit)
                 / p_lifeTimeM(machType,MachLifeUnit)
                    *  p_priceMach(machType,tCur) * p_vPriceInv("machines")
                         )

                     *         p_cropAlloc(crops,"capital")        ]

                          ;


* --- CAPITAL FOR MACHINERY, variable costs

 p_resCGE(crops,"capital_mach",tCur)  $ curcrops(crops)  =

    sum( (c_p_t_i(curCrops(crops),plot,till,intens),t_n(tCur,nCur),curMachines,machLifeUnit)
                 $ (not allocCrops(crops)) ,
        v_cropHa.l(crops,plot,till,intens,tCur,nCur)
         * p_machNeed(crops,till,intens,curMachines,machLifeUnit)
                *      p_machCost(curMachines,machLifeUnit,tCur)  )

    + sum( (c_p_t_i(curCrops(crops),plot,till,intens),curInputs(syntFertilizer),m,t_n(tCur,nCur),machType,machLifeUnit)
                   $ (not allocCrops(crops)),
            v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * (1 + m.pos*1.E-3)
                 * p_machNeed(syntFertilizer,till,"normal",machType,machLifeUnit)
                     *   p_machCost(machType,machLifeUnit,tCur)  )


    + [ sum( (c_p_t_i(allocCrops,plot,till,intens),t_n(tCur,nCur),curMachines,machLifeUnit),
             v_cropHa.l(allocCrops,plot,till,intens,tCur,nCur)
                * p_machNeed(allocCrops,till,intens,curMachines,machLifeUnit)
                       *      p_machCost(curMachines,machLifeUnit,tCur)  )

                        *    p_cropAlloc(crops,"capital")    ]


             ;

* --- CAPITAL for variable costs for activities and not linked to buying of inputs

      p_resCGE(crops,"capital_activ",tCur)  $ curcrops(crops)  =

*        --- variable costs of crop production (as far as not covered by constraints)
*
      + sum( (c_p_t_i(curCrops(crops),plot,till,intens),t_n(tCur,nCur))
                 $ (not allocCrops(crops)) ,
                    v_cropHa.l(crops,plot,till,intens,tCur,nCur)
                      * (p_vCostC(crops,till,intens,tCur) + p_fCostC(crops,till,intens,tCur)))
*
*        --- variable costs from straw production and storing
*
       + sum (  (c_p_t_i(curCrops(crops),plot,till,intens),t_n(tCur,nCur)),  v_residuesRemoval.l(crops,plot,till,intens,tCur,nCur)
                     * p_vCostStrawRemoval(crops,plot,till,intens,tCur) )

       + [ sum( (c_p_t_i(allocCrops,plot,till,intens),t_n(tCur,nCur)),
                     v_cropHa.l(allocCrops,plot,till,intens,tCur,nCur)
                       * (p_vCostC(allocCrops,till,intens,tCur) + p_fCostC(allocCrops,till,intens,tCur)))

                             *     p_cropAlloc(crops,"capital")  ]
                       ;



   p_resCGE(crops,"Capital",tCur) =   p_resCGE(crops,"capital_mach",tCur)
                                    + p_resCGE(crops,"capital_inves",tCur)
                                    + p_resCGE(crops,"capital_inputs",tCur)
                                    + p_resCGE(crops,"capital_activ",tCur);

* --- Calculate the annual physical output
*

    p_resOut(prodsYearly,tCur) $ sum(sameas(prodsYearly,curProds),1) =
                        sum( (c_p_t_i(curCrops(crops),plot,till,intens),t_n(tCur,nCur)), v_cropHa.l(crops,plot,till,intens,tCur,nCur)
                                       * sum(plot_soil(plot,soil) $ p_OCoeffC%l%(crops,soil,till,intens,prodsYearly,tCur),
                                                          p_OCoeffC(crops,soil,till,intens,prodsYearly,tCur))   ) ;

* --- Relate factor input to output
*

    p_resCGEprods(prodsYearly,factor,tCur) $ (p_resOut(prodsYearly,tCur) gt 0 )
                   =     sum ( crops_prods(curcrops,prodsYearly),
                                   p_resCGE(curcrops,factor,tCur)  /
                                          p_resOut(prodsYearly,tCur)  ) ;



* --- Test paramter to check for missing accounting of production factors. "CGE" and "Base" must
*     return the same values as all production factors need to be allocated to activities

* --- Differences between CGE results and model for buying inputs are caused by pesticide reduction
*     in equaction buy_ (around 10 Euro/ha)

   Parameter p_testFactors(factor,*);

   p_testFactors("land","CGEres") = sum ( (crops,tCur) , p_resCGE(crops,"land",tCur) ) /card(tCur);
   p_testFactors("land","Base")   = sum (  (t_n(tCur,nCur), c_p_t_i(crops,plot,till,intens)) $ (not catchCrops(crops))
                                             , v_cropHa.l(crops,plot,till,intens,tCur,nCur) ) /card(tCur);

   p_testFactors("labor","CGEres") = sum ( (crops,tCur) , p_resCGE(crops,"labor",tCur) ) /card(tCur);
   p_testFactors("labor","Base")   =  sum (t_n(tCur,nCur), v_labTot.l(tCur,nCur) )/ card(tCur) ;

   p_testFactors("capital_Inputs","CGEres") =  sum ( (crops,tCur) , p_resCGE(crops,"capital_inputs",tCur) ) /card(tCur);;
   p_testFactors("capital_Inputs","Base")   =  sum( (t_n(tCur,nCur)), v_buyCostTot.l("conv",tcur,nCur)) ;

   p_testFactors("capital_inves","CGEres") =  sum ( (crops,tCur) , p_resCGE(crops,"capital_inves",tCur) ) /card(tCur);;
    p_testFactors("capital_inves","Base")   = sum ( (t_n(tCur,nCur)), v_sumInv.l(tCur,nCur) ) / card(tCur)   ;

   p_testFactors("capital_mach","CGEres") =  sum ( (crops,tCur) , p_resCGE(crops,"capital_mach",tCur) ) /card(tCur);
   p_testFactors("capital_mach","Base")   =  sum ( (t_n(tCur,nCur)), v_varCostMach.l(tCur,nCur) ) /card(tCur)  ;

   p_testFactors("capital_activ","CGEres") =  sum ( (crops,tCur) , p_resCGE(crops,"capital_activ",tCur) ) /card(tCur);
   p_testFactors("capital_activ","Base")   =  sum ( (t_n(tCur,nCur)), v_varCostActs.l(tCur,nCur) ) /card(tCur)  ;

   p_testFactors("capital_allVarCos","CGEres") =  sum ( (crops,tCur) , p_resCGE(crops,"capital_activ",tCur)
                                                         + p_resCGE(crops,"capital_inputs",tCur) + p_resCGE(crops,"capital_mach",tCur) )
                                                              /card(tCur);
   p_testFactors("capital_allVarCos","Base")  =  sum ( (t_n(tCur,nCur)) , v_varCost.l(tCur,nCur) ) /card(tCur);


display p_sumLand
display p_cropAlloc;
display p_resCGE ;
display p_resOut;
display p_testFactors;

display p_resOut;
display  p_resCGEprods;
