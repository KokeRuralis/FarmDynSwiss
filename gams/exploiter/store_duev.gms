********************************************************************************
$ontext

   FarmDyn project

   GAMS file : STORE_DUEV.GMS

   @purpose  :
   @author   :
   @date     : 07.03.25
   @since    :
   @refDoc   :
   @seeAlso  :
   @calledBy :

$offtext
********************************************************************************


*
*  --- Nitrogen policy [TK 20.03.2014]
*

*  --- N and P Surplus calculation according to DueV,
*      calculating nutrient import (animal number, synth. fertilizer) and export (sold products)
*      Basis is always total used land (including idling land), exemption is the 170 kg N limit

   p_res(%1,%2,"NSurplus","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
     = sum( t_n(tCur,nCur), p_probn(nCur)*v_surplusDueV.l (tCur,nCur,"N"))/p_res(%1,%2,"totland","tot","",tCur);

   p_res(%1,%2,"NSurplus","Quant","","mean") $ p_res(%1,%2,"totland","tot","","mean")
     = sum( t_n(tCur,nCur), p_probn(nCur)*v_surplusDueV.l (tCur,nCur,"N"))
          /(p_res(%1,%2,"totland","tot","","mean")*p_cardtCur);

   $$iftheni.herd %herd% == true

      p_res(%1,%2,"NInputOrgNBalanceDuev","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
        =  sum( (nType,t_n(tCur,nCur)),v_nutExcrDuev.l("N",nType,tCur,nCur)) * p_nutEffectivDueVNv("N")
            / p_res(%1,%2,"totland","tot","",tCur);

      p_res(%1,%2,"NInputOrgNBalanceDuev","Quant","","mean") $ p_res(%1,%2,"totland","tot","","mean")
        =  sum(tCur,p_res(%1,%2,"NInputOrgNBalanceDuev","Quant","",tCur))/(p_res(%1,%2,"totland","tot","","mean")*p_cardtCur);

   $$endif.herd

   p_res(%1,%2,"NInputSyntNBalanceDuev","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
     = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),syntFertilizer,m),p_probn(nCur)*
               v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * p_nutInSynt(syntFertilizer,"N") )
                  /p_res(%1,%2,"totland","tot","",tCur);

   p_res(%1,%2,"NInputSyntNBalanceDuev","Quant","","mean") $ p_res(%1,%2,"totland","tot","","mean")
     = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),syntFertilizer,m),p_probn(nCur)*
               v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * p_nutInSynt(syntFertilizer,"N") )
                  /(p_res(%1,%2,"totland","tot","","mean")*p_cardtCur);

   p_res(%1,%2,"PInputSyntPBalanceDuev","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
     = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),syntFertilizer,m),p_probn(nCur)*
               v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * p_nutInSynt(syntFertilizer,"P") )
                  / p_res(%1,%2,"totland","tot","",tCur);

   p_res(%1,%2,"PInputSyntPBalanceDuev","Quant","","mean") $ p_res(%1,%2,"totland","tot","","mean")
     = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),syntFertilizer,m),p_probn(nCur)*
               v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m) * p_nutInSynt(syntFertilizer,"P") )
                 /(p_res(%1,%2,"totland","tot","","mean")*p_cardtCur);

   $$iftheni.herd %herd% == true

      p_res(%1,%2,"NOutputNBalanceDuev","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
          = sum(t_n(tCur,nCur),p_probn(nCur) * v_NutRemovalDuev.l("N",tCur,nCur))
                  / p_res(%1,%2,"totland","tot","",tCur);

      p_res(%1,%2,"NOutputNBalanceDuev","Quant","","mean") $ p_res(%1,%2,"totland","tot","","mean")
         = sum(t_n(tCur,nCur),p_probn(nCur)* v_NutRemovalDuev.l("N",tCur,nCur) )
                 / (p_res(%1,%2,"totland","tot","","mean")*p_cardtCur);

      p_res(%1,%2,"NOrganicApplAllowed","Quant","",tCur) =  smax(curCrops(arableCrops),p_nutManApplLimit(curCrops,tCur)) ;

      $$ifi %cattle% == true p_res(%1,%2,"NOrganicApplAllowedDer","Quant","",tCur) =  smax(gras,p_nutManApplLimit(gras,tCur));

   $$endif.herd

   $$iftheni.man %manure% == true

*     ---- Organic N application limit according to DueV (Ausbringungsobergrenze)
*          [This considers that some crops do not count towards the limit, such as idling land]
*abort p_nutManApplLimit, v_cropHa.l,p_probn;
*      p_res(%1,%2,"NOrganicApplied","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
*        =  sum(t_n(tCur,nCur),p_probn(nCur)*v_DueVOrgN.l(tCur,nCur))
*            / sum((c_p_t_i(curCrops(crops),plot,till,intens),t_n(tCur,nCur))  $ (( not catchcrops(crops) ) $ v_cropHa.l(crops,plot,till,intens,tCur,nCur)) ,
*                         p_nutManApplLimit(crops,tCur) * v_cropHa.l(crops,plot,till,intens,tCur,nCur)*p_probn(nCur)) ;
*
*
*      p_res(%1,%2,"NOrganicApplied","Quant","","mean") $ p_res(%1,%2,"totland","tot","","mean")
*         =  sum(t_n(tCur,nCur),p_probn(nCur)*v_DueVOrgN.l(tCur,nCur))
*            / sum((c_p_t_i(curCrops(crops),plot,till,intens),t_n(tCur,nCur))  $ ( not catchcrops(crops)),
*                         p_nutManApplLimit(crops,tCur) * v_cropHa.l(crops,plot,till,intens,tCur,nCur)*p_probn(nCur));

      p_res(%1,%2,"NOrganicApplied","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
        =  sum(t_n(tCur,nCur),p_probn(nCur)*v_DueVOrgN.l(tCur,nCur))
            / sum((c_p_t_i(curCrops(crops),plot,till,intens),t_n(tCur,nCur))  $ ( not catchcrops(crops) ) ,
                         2) ;

      p_res(%1,%2,"NOrganicApplied","Quant","","mean") $ p_res(%1,%2,"totland","tot","","mean")
         =  sum(t_n(tCur,nCur),p_probn(nCur)*v_DueVOrgN.l(tCur,nCur))
            / sum((c_p_t_i(curCrops(crops),plot,till,intens),t_n(tCur,nCur))  $ ( not catchcrops(crops)),
                        2);

   $$endif.man

   p_res(%1,%2,"PSurplus","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
     = sum(t_n(tCur,nCur),p_probn(nCur)*v_surplusDueV.l(tCur,nCur,"P"))
                       /p_res(%1,%2,"totland","tot","",tCur);

   p_res(%1,%2,"PSurplus","Quant","","mean") $ p_res(%1,%2,"totland","tot","","mean")
     = sum(t_n(tCur,nCur),p_probn(nCur)*v_surplusDueV.l (tCur,nCur,"P") )
                       /(p_res(%1,%2,"totland","tot","","mean")*p_cardtCur);

   p_res(%1,%2,"POutputPBalanceDuev","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
     = sum(t_n(tCur,nCur),p_probn(nCur)*v_NutRemovalDuev.l("P",tCur,nCur))
                       /p_res(%1,%2,"totland","tot","",tCur);

   p_res(%1,%2,"POutputPBalanceDuev","Quant","","mean") $ p_res(%1,%2,"totland","tot","","mean")
     = sum(t_n(tCur,nCur),p_probn(nCur)*v_NutRemovalDuev.l("P",tCur,nCur) )
                       /(p_res(%1,%2,"totland","tot","","mean")*p_cardtCur);

   $$iftheni.herd %herd% == true
     p_res(%1,%2,"PInputOrgPBalanceDuev","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
       =  sum( (nType,t_n(tCur,nCur)),p_probn(nCur)*v_nutExcrDuev.l("P",nType,tCur,nCur) *  p_nutEffectivDueVNv("P") )
                       /p_res(%1,%2,"totland","tot","",tCur);

     p_res(%1,%2,"PInputOrgPBalanceDuev","Quant","","mean") $ p_res(%1,%2,"totland","tot","","mean")
       =  sum( (nType,t_n(tCur,nCur)),p_probn(nCur)*v_nutExcrDuev.l("P",nType,tCur,nCur) *  p_nutEffectivDueVNv("P") )
                       /(p_res(%1,%2,"totland","tot","","mean")*p_cardtCur);
   $$endif.herd

   p_res(%1,%2,"POutputPBalanceDuev","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
     = sum(t_n(tCur,nCur),p_probn(nCur)*v_NutRemovalDuev.l("P",tCur,nCur))
           / p_res(%1,%2,"totland","tot","",tCur);

   p_res(%1,%2,"POutputPBalanceDuev","Quant","",tCur) $ p_res(%1,%2,"totland","tot","",tCur)
     = sum(t_n(tCur,nCur),p_probn(nCur)*v_NutRemovalDuev.l("P",tCur,nCur))
           / p_res(%1,%2,"totland","tot","",tCur);

   p_res(%1,%2,"surplusDuevAllowedN","Quant","",tCur) = p_surplusDueVMax(tCur,"N");
   p_res(%1,%2,"surplusDuevAllowedP","Quant","",tCur) = p_surplusDueVMax(tCur,"P");





   $$ifi not defined p_sumDuev parameter p_SumDueV(*,*);

   p_SumDueV("NSurplus",tCur) =  p_res(%1,%2,"NSurplus","Quant","",tCur) ;
   p_SumDueV("PSurplus",tCur) =  p_res(%1,%2,"PSurplus","Quant","",tCur) ;

   p_SumDueV("NminFert",tCur) =  p_res(%1,%2,"NInputSyntNBalanceDuev","Quant","",tCur);
   p_SumDueV("PminFert",tCur) =  p_res(%1,%2,"PInputSyntPBalanceDuev","Quant","",tCur);

   $$iftheni.herd %herd% == true

     p_SumDueV("StockDens",tCur) $ sum( t_n(tCur,nCur), v_croplandActive.l(tCur,nCur) )
        =   sum(  t_n(tCur,nCur) ,v_sumGV.l(tCur,nCur) /  v_croplandActive.l(tCur,nCur)  );

   $$endif.herd

   p_SumDueV("NneedPlanning",tCur) $ sum( t_n(tCur,nCur), v_croplandActive.l(tCur,nCur) )
            =  sum( (c_p_t_i(curCrops(crops),plot,till,intens),plot_soil(plot,soil),t_n(tCur,nCur))  $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                    v_cropHa.l(crops,plot,till,intens,tCur,nCur) * p_nutNeed(crops,soil,till,intens,"N",tCur) )
             / sum(  (t_n(tCur,nCur) ),  v_croplandActive.l(tCur,nCur) );

   p_sumDueV("NneedMin",tCur)        $ sum( t_n(tCur,nCur), v_croplandActive.l(tCur,nCur))
            =  sum( (c_p_t_i(curCrops(crops),plot,till,intens),plot_soil(plot,soil),t_n(tCur,nCur))  $ v_cropHa.l(crops,plot,till,intens,tCur,nCur)   ,
                       v_cropHa.l(crops,plot,till,intens,tCur,nCur) * p_minChemFert(crops,"N")    )
            / sum(  (t_n(tCur,nCur) ),  v_croplandActive.l(tCur,nCur) );


   p_sumDueV("PneedMin",tCur)        $ sum( t_n(tCur,nCur), v_croplandActive.l(tCur,nCur) )
             =  (    sum( (c_p_t_i(curCrops(crops),plot,till,intens),plot_soil(plot,soil),t_n(tCur,nCur)) $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                          v_cropHa.l(crops,plot,till,intens,tCur,nCur) * p_minChemFert(crops,"P")      )
            / sum(  (t_n(tCur,nCur) ),  v_croplandActive.l(tCur,nCur) ));


       p_sumDuev("NOverNeed",tCur)  $ sum( t_n(tCur,nCur), v_croplandActive.l(tCur,nCur) )
               =  sum( (c_p_t_i(curCrops(crops),plot,till,intens),t_n(tCur,nCur)), v_nutOverNeed.l(crops,plot,till,intens,"N",tCur,nCur))
                / sum( t_n(tCur,nCur),  v_croplandActive.l(tCur,nCur) );


   $$iftheni.man "%manure%" == "true"

       p_sumDueV("Norg170",TCur)  =  p_res(%1,%2,"NOrganicApplied","Quant","",tCur);

       p_sumDueV("NorgPlanAvai",tCur)   $ sum( t_n(tCur,nCur), v_croplandActive.l(tCur,nCur) )
                = sum (  (c_p_t_i(curCrops(crops),plot,till,intens),ManApplicType,curManType,t_n(tCur,nCur),m)
                              $ (v_manDist.up(crops,plot,till,intens,ManApplicType,curManType,tCur,nCur,m) ne 0),
                           v_manDist.l(crops,plot,till,intens,ManApplicType,curManType,tCur,nCur,m)

                                       * sum((manChain_applic(curManChain,ManApplicType),nut2N),
                                            p_nut2inMan(nut2N,curManType,curManChain)) * p_nutEffFOPlan(curManType,crops,m,"N")   )
                        / sum( (t_n(tCur,nCur) ),  v_croplandActive.l(tCur,nCur) );

       $$iftheni.ExMan "%AllowManureExport%" == "true"

             p_SumDueV("ManExpNha",tCur)   $ sum( t_n(tCur,nCur), v_croplandActive.l(tCur,nCur) )
                  =  p_res(%1,%2,"manExportN","Quant","","mean")
                     / sum(  (t_n(tCur,nCur) ),  v_croplandActive.l(tCur,nCur) ) / p_cardtCur  ;

       $$endif.ExMan

       $$iftheni.imMan  "%AllowManureImport%" == "true"

             p_SumDueV("ManImpNha",tCur)   $ sum( t_n(tCur,nCur), v_croplandActive.l(tCur,nCur) )
                        =  p_res(%1,%2,"manImportN","Quant","","mean")
                              / sum(  (t_n(tCur,nCur) ),  v_croplandActive.l(tCur,nCur) ) / p_cardtCur  ;
       $$endif.imMan


*      p_SumDueV("NQuotNeed",tCur) =    sum( (plot,t_n(tCur,nCur)),  v_FertQuotaNeed.l(plot,tCur,nCur) ) ;

*      p_SumDueV("NQuotAppl",tCur) =    sum( (plot,t_n(tCur,nCur)),  v_FertQuotaInput.l(plot,tCur,nCur) ) ;


       $$endif.man

  display p_sumDueV;

