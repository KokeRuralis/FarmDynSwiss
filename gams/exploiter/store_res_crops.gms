********************************************************************************
$ontext

   FARMDYN project

   GAMS file : STORE_RES_CROPS.GMS

   @purpose  :
   @author   :
   @date     : 24.07.16
   @since    :
   @refDoc   :
   @seeAlso  :
   @calledBy :

$offtext
********************************************************************************
*
*  --- cropping, results per crop
*
 p_res(%1,%2,curCrops(crops),"levl",%3,tCur)
    = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens)),
                 p_probn(nCur) * v_cropHa.l(crops,plot,till,intens,tCur,nCur)  );

 p_res(%1,%2,curCrops(crops),"levl",%3,"mean")  = sum(tCur, p_res(%1,%2,crops,"levl",%3,tCur))   / p_cardTCur;

 p_res(%1,%2,intens,"levl","",tCur)
    = sum( ( t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens) ) ,
         p_probn(nCur) *  v_cropHa.l(crops,plot,till,intens,tCur,nCur) );

 p_res(%1,%2,till,"levl","",tCur)
    = sum( ( t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens) )  ,
         p_probn(nCur) *  v_cropHa.l(crops,plot,till,intens,tCur,nCur) );

 p_res(%1,%2,curCrops(crops),"yield",%3,tCur)  $ p_res(%1,%2,crops,"levl",%3,tCur)
          = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),prods)
                     $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                           sum(plot_soil(plot,soil), p_oCoeffC(crops,soil,till,intens,prods,tCur))
                           * p_probn(nCur) * v_cropHa.l(crops,plot,till,intens,tCur,nCur) )
                                            /p_res(%1,%2,crops,"levl",%3,tCur);

  p_res(%1,%2,curCrops(crops),"yield",%3,"mean") = sum(tCur,  p_res(%1,%2,curCrops,"yield",%3,tCur))   / p_cardTCur;
  p_res(%1,%2,curCrops(crops),curProds(prods),%3,tCur)
       $ ( sum( (c_p_t_i(crops,plot,till,intens),plot_soil(plot,soil)), p_oCoeffC(crops,soil,till,intens,prods,tCur))
           $  p_res(%1,%2,crops,"Levl",%3,tcur) ) = p_res(%1,%2,crops,"yield",%3,tCur);


 p_res(%1,%2,curCrops(crops),"YieldProd",curProds(prods),tCur)$ p_res(%1,%2,crops,"levl","",tCur)
          =sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens))
               $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                  sum(plot_soil(plot,soil), p_oCoeffC(crops,soil,till,intens,curProds,tCur))
                  * p_probn(nCur)* v_cropHa.l(crops,plot,till,intens,tCur,nCur) )
                     /p_res(%1,%2,crops,"levl","",tCur);


p_res(%1,%2,curCrops(crops),"YieldProd",curProds,"mean") = sum(tCur, p_res(%1,%2,curCrops,"YieldProd",curProds,tCur)) / p_cardTCur;

p_res(%1,%2,curCrops(crops),"Production",curProds(prods),tCur)$ p_res(%1,%2,crops,"levl","",tCur)
         =sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens))
              $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                 sum(plot_soil(plot,soil), p_oCoeffC(crops,soil,till,intens,curProds,tCur))
                 * p_probn(nCur)* v_cropHa.l(crops,plot,till,intens,tCur,nCur) );


p_res(%1,%2,curCrops(crops),"Production",curProds,"mean") = sum(tCur, p_res(%1,%2,curCrops,"Production",curProds,tCur)) / p_cardTCur;


$exit
*
* --- the remainder of the calculation are quite specific and depending on the implementation of quite some modelling detail
*     better leave out ...
*



p_res(%1,%2,curCrops(crops),"labHour",%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
     = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),m) $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                         p_cropLab(crops,till,intens,m)
                               * p_probn(nCur) *v_cropHa.l(crops,plot,till,intens,tCur,nCur)

                       +  sum( (syntFertilizer) $ v_syntDist.up(crops,plot,till,intens,syntFertilizer,tCur,nCur,m),
                                  v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m)
                                    * p_probn(nCur) * p_syntDistLab(syntFertilizer))
                       )/p_res(%1,%2,crops,"levl",%3,tCur);

 p_res(%1,%2,curCrops(crops),"hours",%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
          = p_res(%1,%2,crops,"labHour",%3,tCur) * p_res(%1,%2,crops,"levl",%3,tCur);



$iftheni.herd %herd% == true

   p_res(%1,%2,curCrops(crops),nutManApplicType,%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
           = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),
                    nutManApplicType_manApplicType(nutManApplicType,manApplicType),
                     curManType,m)
                  $ ((v_manDist.up(crops,plot,till,intens,ManApplicType,curManType,tCur,nCur,m) gt 0)
                  $ v_cropHa.l(crops,plot,till,intens,tCur,nCur)),
          p_probn(nCur)
              * v_manDist.l(crops,plot,till,intens,ManApplicType,curManType,tCur,nCur,m)
              * sum(manChain_applic(manChain,ManApplicType),p_nut2inMan("NTan",curmanType,manChain) + p_nut2inMan("Norg",curmanType,manChain))
                 /  v_cropHa.l(crops,plot,till,intens,tCur,nCur));


* ---  application of manure per ha to different crops in kg N per ha [TK 07.05.15]

   p_res(%1,%2,curCrops(crops),"NmanAplHa",%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
           = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),
                             manApplicType, curmanType,m)
                                      $ ((v_manDist.up(crops,plot,till,intens,ManApplicType,curmanType,tCur,nCur,m) gt 0)
                                                       $ v_cropHa.l(crops,plot,till,intens,tCur,nCur)),
              p_probn(nCur)
                 * v_manDist.l(crops,plot,till,intens,ManApplicType,curmanType,tCur,nCur,m)
                 * sum(manChain_applic(manChain,ManApplicType),p_nut2inMan("NTan",curmanType,manChain) + p_nut2inMan("Norg",curmanType,manChain))
                 /  v_cropHa.l(crops,plot,till,intens,tCur,nCur));

* ---  application of manure per ha to different crops in kg P per ha

    p_res(%1,%2,curCrops(crops),"PmanAplHa",%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
            = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),
                              manApplicType, curmanType,m)
                                       $ ((v_manDist.up(crops,plot,till,intens,ManApplicType,curmanType,tCur,nCur,m) gt 0)
                                                        $ v_cropHa.l(crops,plot,till,intens,tCur,nCur)),
               p_probn(nCur)
                  * v_manDist.l(crops,plot,till,intens,ManApplicType,curmanType,tCur,nCur,m)
                  * sum(manChain_applic(manChain,ManApplicType),p_nut2inMan("P",curmanType,manChain))
                  /  v_cropHa.l(crops,plot,till,intens,tCur,nCur));

* --- excretion of grazing animals in kg N per ha
   $$iftheni.graz defined v_nut2ManurePast.l

   p_res(%1,%2,curCrops(pastcrops),"NGrazHa",%3,tCur) $ p_res(%1,%2,pastcrops,"levl",%3,tCur)
           = sum( (t_n(tCur,nCur),c_p_t_i(pastcrops,plot,till,intens),nut2,m) $ ( (sameas(nut2,"norg") or sameas(nut2,"ntan"))
                                                       $ v_cropHa.l(pastcrops,plot,till,intens,tCur,nCur)),
                      v_nut2ManurePast.l(pastcrops,plot,till,intens,nut2,tCur,nCur,m) *    p_probn(nCur)
                 /  v_cropHa.l(pastcrops,plot,till,intens,tCur,nCur));


   p_res(%1,%2,curCrops(pastcrops),"NGrazHa",%3,"mean") $ p_res(%1,%2,pastcrops,"levl",%3,"mean")
           = sum( (t_n(tCur,nCur),c_p_t_i(pastcrops,plot,till,intens),nut2,m) $ ( (sameas(nut2,"norg") or sameas(nut2,"ntan"))
                                                       $ v_cropHa.l(pastcrops,plot,till,intens,tCur,nCur)),
                      v_nut2ManurePast.l(pastcrops,plot,till,intens,nut2,tCur,nCur,m) *    p_probn(nCur)
                 /  v_cropHa.l(pastcrops,plot,till,intens,tCur,nCur)) / p_cardTCur;


   p_res(%1,%2,curCrops(pastcrops),"PGrazHa",%3,tCur) $ p_res(%1,%2,pastcrops,"levl",%3,tCur)
            = sum( (t_n(tCur,nCur),c_p_t_i(pastcrops,plot,till,intens),nut2,m) $ ( (sameas(nut2,"P"))
                                                        $ v_cropHa.l(pastcrops,plot,till,intens,tCur,nCur)),
                       v_nut2ManurePast.l(pastcrops,plot,till,intens,nut2,tCur,nCur,m) *    p_probn(nCur)
                  /  v_cropHa.l(pastcrops,plot,till,intens,tCur,nCur));


   p_res(%1,%2,curCrops(pastcrops),"PGrazHa",%3,"mean") $ p_res(%1,%2,pastcrops,"levl",%3,"mean")
            = sum( (t_n(tCur,nCur),c_p_t_i(pastcrops,plot,till,intens),nut2,m) $ ( (sameas(nut2,"P"))
                                                        $ v_cropHa.l(pastcrops,plot,till,intens,tCur,nCur)),
                       v_nut2ManurePast.l(pastcrops,plot,till,intens,nut2,tCur,nCur,m) *    p_probn(nCur)
                  /  v_cropHa.l(pastcrops,plot,till,intens,tCur,nCur)) / p_cardTCur;


   $$endif.graz

* --- nutrient disposal of manure in kg N or P per ha (mean)

   p_res(%1,%2,curCrops(crops),"NmanAplHa",%3,"mean") $ p_res(%1,%2,crops,"levl",%3,"mean")
           = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),
                             manApplicType, curmanType,m)
                                      $ ((v_manDist.up(crops,plot,till,intens,ManApplicType,curmanType,tCur,nCur,m) gt 0)
                                                       $ v_cropHa.l(crops,plot,till,intens,tCur,nCur)),
              p_probn(nCur)
                 * v_manDist.l(crops,plot,till,intens,ManApplicType,curmanType,tCur,nCur,m)
                 * sum(manChain_applic(manChain,ManApplicType),p_nut2inMan("NTan",curmanType,manChain) + p_nut2inMan("Norg",curmanType,manChain))
                /  v_cropHa.l(crops,plot,till,intens,tCur,nCur)) / p_cardtCur  ;


    p_res(%1,%2,curCrops(crops),"PmanAplHa",%3,"mean") $ p_res(%1,%2,crops,"levl",%3,"mean")
            = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),
                              manApplicType, curmanType,m)
                                       $ ((v_manDist.up(crops,plot,till,intens,ManApplicType,curmanType,tCur,nCur,m) gt 0)
                                                        $ v_cropHa.l(crops,plot,till,intens,tCur,nCur)),
               p_probn(nCur)
                  * v_manDist.l(crops,plot,till,intens,ManApplicType,curmanType,tCur,nCur,m)
                  * sum(manChain_applic(manChain,ManApplicType),p_nut2inMan("P",curmanType,manChain))
                 /  v_cropHa.l(crops,plot,till,intens,tCur,nCur)) / p_cardtCur  ;

* ---  total amount of nutrients excreted by grazing animals

   $$ifthen.graz defined v_nut2ManurePast.l

   p_res(%1,%2,curCrops(grasCrops),"NGraz",%3,tCur) $ p_res(%1,%2,grasCrops,"levl",%3,tCur)
           = sum( (t_n(tCur,nCur),c_p_t_i(grasCrops,plot,till,intens),nut2,m) $ ( (sameas(nut2,"norg") or sameas(nut2,"ntan"))
                                                       $ v_cropHa.l(grasCrops,plot,till,intens,tCur,nCur)),
                      v_nut2ManurePast.l(grasCrops,plot,till,intens,nut2,tCur,nCur,m) *    p_probn(nCur));

   p_res(%1,%2,curCrops(grasCrops),"PGraz",%3,tCur) $ p_res(%1,%2,grasCrops,"levl",%3,tCur)
           = sum( (t_n(tCur,nCur),c_p_t_i(grasCrops,plot,till,intens),nut2,m)
                                                       $ v_cropHa.l(grasCrops,plot,till,intens,tCur,nCur),
                      v_nut2ManurePast.l(grasCrops,plot,till,intens,"P",tCur,nCur,m) *    p_probn(nCur));

   $$endif.graz


$endif.herd
*
*  --- input from mineral fertilizer application in kg N per ha without gaesous losses
*

 p_res(%1,%2,curCrops(crops),"NMin",%3,tCur) $  p_res(%1,%2,crops,"levl",%3,tCur)
          = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),syntFertilizer,m),
                  p_probn(nCur) *   v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m)
                              * p_nutInSynt(syntFertilizer,"N") );

 p_res(%1,%2,curCrops(crops),"NMin",%3,"mean")
          = sum(tCur, p_res(%1,%2,curCrops,"NMin",%3,tCur)) / p_cardTcur;


 p_res(%1,%2,curCrops(crops),"PMin",%3,tCur) $  p_res(%1,%2,crops,"levl",%3,tCur)
          = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),syntFertilizer,m),
                  p_probn(nCur) *   v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m)
                              * p_nutInSynt(syntFertilizer,"P") );

 p_res(%1,%2,curCrops(crops),"pMin",%3,"mean")
          = sum(tCur, p_res(%1,%2,curCrops,"pMin",%3,tCur)) / p_cardTcur;

*
*  ---- here is some nonsense: p_nutDist is only set for norm, but division is by card(w)
*

 p_res(%1,%2,curCrops(crops),"NNeed",%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
          = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens)) $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                             sum(plot_soil(plot,soil),p_nutNeed(crops,soil,till,intens,"N",tCur))
                                *  p_probn(nCur) * v_cropHa.l(crops,plot,till,intens,tCur,nCur) );

 p_res(%1,%2,curCrops(crops),"PMin",%3,tCur) $  p_res(%1,%2,crops,"levl",%3,tCur)
          = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens),syntFertilizer,m)
                     $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                 p_probn(nCur) * v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m)
                              * p_nutInSynt(syntFertilizer,"P") );

 p_res(%1,%2,curCrops(crops),"PNeed",%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
          = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens)) $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                           sum(plot_soil(plot,soil), p_nutNeed(crops,soil,till,intens,"P",tCur)
                         * p_probn(nCur)   *v_cropHa.l(crops,plot,till,intens,tCur,nCur))  );


  p_res(%1,%2,curCrops(crops),"NBas",%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
           = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens)) $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
               sum((plot_soil(plot,soil),soilNutSour),p_basNut(crops,soil,till,soilNutSour,"N",tCur))
                   * p_probn(nCur) *v_cropHa.l(crops,plot,till,intens,tCur,nCur)  ) * 0;


  p_res(%1,%2,nMeanforCrops,"Quant",%3,tCur)
   = sum(crops, p_res(%1,%2,crops,nMeanForCrops,%3,tCur));

  p_res(%1,%2,nMeanForCrops,"Quant",%3,"mean")
   = sum(Tcur, p_res(%1,%2,nMeanForCrops,"Quant",%3,tCur))/p_cardtCur;

  p_res(%1,%2,curCrops(crops),nMeanforCrops,%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
    = p_res(%1,%2,crops,nMeanforCrops,%3,tCur)/p_res(%1,%2,crops,"levl",%3,tCur);

*
*  --- economic results for crops
*
 p_res(%1,%2,curCrops(crops),"reve",%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
  = sum( (c_p_t_i(crops,plot,till,intens),t_n(tCur,nCur)) $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),
                     sum(plot_soil(plot,soil),
                        [   sum(curProds(prodsYearly),  prods_.m(prodsYearly,tCur,nCur)
                                 *p_oCoeffC(crops,soil,till,intens,prodsYearly,tCur))
$ifthen.def defined prodsM_
                         +  sum( (curProds(prodsMonthly),m),
                                 prodsMY_.m(prodsMonthly,tCur,nCur,m)
                                    *p_oCoeffM(crops,soil,till,intens,prodsMonthly,m,tCur))
$endif.def
                        ]
                                *v_cropHa.l(crops,plot,till,intens,tCur,nCur) ))
                                *card(tCur)
                                *sum(sameas(tCur,tFull),(1+p_discountRate/100)**tFull.pos)


           /p_res(%1,%2,crops,"levl",%3,tCur);


 curINputs("other") = YES;
 curINputs("fixedMach") = YES;

 p_res(%1,%2,curCrops(crops),curInputs(inputs),%3,tCur) $ p_res(%1,%2,crops,"levl",%3,tCur)
*
*    --- not specified costs
*
  = sum( (t_n(tCur,nCur),c_p_t_i(crops,plot,till,intens)) $ v_cropHa.l(crops,plot,till,intens,tCur,nCur),

           p_probn(nCur) *{

           [
*
*         --- variable costs for not explicitly handled machinery
*
              p_vCostC(crops,till,intens,tCur) $ sameas(inputs,"other")
*
*         --- fixed costs for not explicitly handled machinery
*
           +  p_fCostC(crops,till,intens,tCur) $ sameas(inputs,"fixedMach")
*         --- costs for explicitly handled inputs, related to crop ha
*
           +  p_costQuant(crops,till,intens,inputs) * sum(sys_till(sys,till),p_inputPrice(inputs,sys,tCur))
*
*         --- costs for machinery
*
           + sum(  machType,

                   p_machNeed(crops,till,intens,machType,"ha")   * p_machCost(machType,"ha",tCur)
                 + p_machNeed(crops,till,intens,machType,"hour") * p_machCost(machType,"hour",tCur)
                                $ (not p_machNeed(crops,till,intens,machType,"ha")))  $ sameas(inputs,"other")
*
*         --- cost of diesel per average hour of tractor use
*
                    +  { p_machNeed(crops,till,intens,"tractor","hour")
                         * p_machAttr("tractor","diesel_h") * p_Inputprice("diesel","conv",tCur) } $ sameas(inputs,"diesel")

          ] * v_cropHa.l(crops,plot,till,intens,tCur,nCur)
*
*         --- fertilizer cost
*
          + sum( (sameas(inputs,syntFertilizer),m),
                 v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m)
                    * p_Inputprice(inputs,"conv",tCur) )
*
*         --- diesel costs for spreading fertilizer
*
          + sum( (syntFertilizer,m),
                 v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m)
                     * p_machNeed(syntFertilizer,till,"normal","tractor","hour")
                     * p_machAttr("tractor","diesel_h") * p_Inputprice("diesel","conv",tCur) ) $ sameas(inputs,"diesel")
*
*         --- variable costs for spreading fertilizer
*
          + sum( (syntFertilizer,m,machType,machLifeUnit),
                 v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m)
                     * p_machNeed(syntFertilizer,till,"normal",machType,machLifeUnit)
                     * p_machCost(machType,machLifeUnit,tCur) ) $ sameas(inputs,"other")

          } )/p_res(%1,%2,crops,"levl",%3,tCur);
