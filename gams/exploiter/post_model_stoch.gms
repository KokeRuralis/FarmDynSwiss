********************************************************************************
$ontext

   FARMDyn project

   GAMS file : POST_MODEL_STOCH.GMS

   @purpose  : Test implementation of post model stochastics
   @author   : W.Britz
   @date     : 29.05.18
   @since    :
   @refDoc   :
   @seeAlso  :
   @calledBy :

$offtext
********************************************************************************
*
* --- define # of stochastic draws
*
  $$setglobal nDraws 100
  $$ife %nDraws%<10  $setglobal nDraws  0%nDraws%
  $$ife %nDraws%<100 $setglobal nDraws  0%nDraws%

  set stochDraws / sDraws001*sDraws%nDraws% /;
*
* --- fix decision variables in model
*
  v_prods.fx(curProds(prodsYearly),t_n(tCur,nCur))            = v_prods.l(curProds,tCur,nCur);
  v_buy.fx(curInputs,sys,t_n(tCur,nCur))                          = v_buy.l(curInputs,sys,tCur,nCur);
  v_cropHa.fx(c_p_t_i(crops,plot,till,intens),t_n(tCur,nCur)) = v_cropHa.l(crops,plot,till,intens,tCur,nCur);
  v_syntDist.fx(c_p_t_i(crops,plot,till,intens),syntFertilizer,t_n(tCur,nCur),m)          = v_syntDist.l(crops,plot,till,intens,syntFertilizer,tCur,nCur,m);
  v_manDist.fx(c_p_t_i(crops,plot,till,intens),manApplicType,curManType,t_n(tCur,nCur),m) = v_manDist.l(crops,plot,till,intens,manApplicType,curManType,tCur,nCur,m);

  v_buyMach.fx(curMachines(machType),t_n(tFull,nCur)) = v_buyMach.l(machType,tFull,nCur);
  v_buyStables.fx(stables,hor,t_n(tFull,nCur))        = v_buyStables.l(stables,hor,tFull,nCur);
  v_stableInv.fx(stables,hor,t_n(tFull,nCur))         = v_stableInv.l(stables,hor,tFull,nCur);
  v_buySilos.fx(curManChain,silos,t_n(tFull,nCur))    = v_buySilos.l(curManChain,silos,tFull,nCur);
  v_buyBuildings.fx(buildings,t_n(tFull,nCur))        = v_buyBuildings.l(buildings,tFull,nCur);
  v_hasFarm.fx(t_n(tCur,nCur))                        = v_hasFarm.l(tCur,nCur);
  v_hasBranch.fx(branches,t_n(tCur,nCur))             = v_hasBranch.l(branches,tCur,nCur);
  v_labOffB.fx(t_n(tCur,nCur))                        = v_labOffB.l(tCur,nCur);
  v_labOff.fx(t_n(tCur,nCur),workType)                = v_labOff.l(tCur,nCur,workType);

  parameter p_basePrice,p_stochRes;
  p_basePrice(prodsYearly,sys,t) = p_price(prodsYearly,sys,t);
  scalar nUsableDraws / 0 /;


  loop(stochDraws,
*
*  ---  update prices (here only a dummy implementation)
*
    p_price(prodsYearly,sys,t) = p_basePrice(prodsYearly,sys,t) * uniform(0.5,1.5);
*
*  ---  solve model (to update financial part)
*
    $$batinclude 'util/title.gms' "'%titlePrefix% Solve model as %MIP% for '" stochDraws.tl
    m_farm.solprint  = 2;
    m_farm.solvelink = 5;
    solve m_farm using %RMIP% maximizing v_obje;
    if ( m_farm.sumInfes < 1.E-3,
*
*
*    ---  store results
*
        $$batinclude 'exploiter/store_res.gms' '"Base"' '"draw"' full
        p_stochRes("profit",stochDraws)             =   p_res("Base","draw","objval","sum","","mean");
        p_stochRes("credits",stochDraws)            =   p_res("Base","draw","credits","new","","mean");
        nUsableDraws = nUsableDraws + 1;
     );
  );
*
* --- reset
*
  p_price(prodsYearly,sys,t) = p_basePrice(prodsYearly,sys,t);
  solve m_farm using %MIP% maximizing v_obje;

  display p_stochRes,nUsableDraws;

