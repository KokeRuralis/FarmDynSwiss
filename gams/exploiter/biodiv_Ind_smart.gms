*******************************************************************************
$ontext

   APM course

   GAMS file : Index_according_to_SMART

   @purpose  :
   @author   : Felix Rï¿½ssing
   @date     : 18.12.20
   @since    :
   @refDoc   :
   @seeAlso  :
   @calledBy :

$offtext
********************************************************************************

$ifthen.declaredSmart not declared smartInds

 set smartInds / 182 "Proportion of arable land with zero or minimum tillage"
                 207 "Proportion of arable land with zero tillage"
                 215 "Proportion of arable land devoted to temporary grasslands"
                 219 "Proportion of arable land of cover crops under sown"
                 222 "Share of permanent grass land on total agricultural land"
                 229 "Share of EFA land on total agricultural land"
                 231 "Share of land without chemical herbizides on total agricultural land"
                 233 "Share of land without chemical fungicides on total agricultural land"
                 234 "Share of land without chemical insectides on total agricultural land"
                 236 "How many elements does the crop rotation consist of?"
                 237 "How much land is mulched?"
                 253 "Share of extensive grassland on total permanent grassland"
                 285 "Share of catch crops on arable land"
                 308 "Share of farmyard manure on organic manure"
                 323 "Mineral N per ha of agricultural land"
                 324 "Easily dissolvable mineral P per ha of agricultural land, in P205"
                 620 "Average # of cuts on grassland"
               /;
*
*   --- Species Diversity
*
 set SpecDivInd(smartInds) / 182
                             207
                             215
                             219
                             222
                             229
                             231
                             233
                             234
                             236
                             237
                             253
                             285
                             308
                             323
                             324
                             620
                           /;
*
*   --- Ecosystem Diversity
*
 set EcoDivInd(smartInds) / 215
                            219
                            222
                            229
                            231
                            233
                            234
                            236
                            237
                            323
                            324
                            620
                          /;
*
*   --- Genetic Diversity
*
 set GenDivInd (smartInds) / 222
                             229
                             233
                             234
                             236
                             253
                             620
                           /;

 set indPos  / driver,Val,Rel,Species,Genetic,EcoSys /;

 Parameter
 p_Ind(smartInds,indPos)
 p_SpecDiv
 p_EcoDiv
 p_GenDiv
 p_BioDiv
 ;

$endif.declaredSmart


********************************************************************************
*   --- Link to FarmDyn
********************************************************************************
*
*   --- Indicator 182
*
* --- Proportion of arable land with zero or no-till (Note: exlcude cover crops etc.)
 p_Ind("182","rel") $ sum( (soil,t_n(tCur,nCur)), v_croppedLand("arab",soil,tCur,nCur)*p_probN(nCur)) = 1;

* -- probability weighted sum of crop variants under no-till
 p_Ind("182","driver") $ p_Ind("182","rel")
 =  [sum((c_p_t_i(arabCrops(curCrops),plot,till,intens),t_n(tCur,nCur)) $ (sameas(till,"noTill") or sameas(till,"minTill")), v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur))]
   / sum( (soil,t_n(tCur,nCur)), v_croppedLand("arab",soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("182","val") = p_ind("182","driver");



*
*   --- Indicator 207
*
* --- Proportion of arable land with zero till and direct seeding
 p_Ind("207","rel") $ sum( (soil,t_n(tCur,nCur)), v_croppedLand("arab",soil,tCur,nCur)*p_probN(nCur)) = 1;

* -- probability weighted sum of crop variants under no-till
 p_Ind("207","driver") $ p_Ind("207","rel")
 =  [sum((c_p_t_i(arabCrops(curCrops),plot,till,intens),t_n(tCur,nCur)) $ sameas(till,"noTill"), v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur))]
   / sum( (soil,t_n(tCur,nCur)), v_croppedLand("arab",soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("207","val") = p_ind("207","driver");



*
*   --- Indicator 215
*
* --- Proportion of arable land devoted to temporary grasslands
 p_Ind("215","rel") $ sum( (soil,t_n(tCur,nCur)), v_croppedLand("arab",soil,tCur,nCur)*p_probN(nCur)) = 1;

* -- probability weighted sum of temp. grasslands incl. clover / alfalfa
 p_Ind("215","driver") $ p_Ind("215","rel")
 =  [sum((c_p_t_i(curCrops,plot,till,intens),t_n(tCur,nCur)) $ sameas(curCrops,"Alfalfa"), v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur))]
   / sum( (soil,t_n(tCur,nCur)), v_croppedLand("arab",soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("215","val") =   0                                      $(p_ind("215","driver") < 0.10)
                      + 0.25 $((p_ind("215","driver") >= 0.10) $(p_ind("215","driver") < 0.25))
                      + 0.50 $((p_ind("215","driver") >= 0.25) $(p_ind("215","driver") < 0.33))
                      + 0.75 $((p_ind("215","driver") >= 0.33) $(p_ind("215","driver") < 0.50))
                      + 1.00 $( p_ind("215","driver") >= 0.50);



*
*   --- Indicator 219
*
* --- Proportion of arable land of cover crops under sown
 p_Ind("219","rel") $ sum( (soil,t_n(tCur,nCur)), v_croppedLand("arab",soil,tCur,nCur)*p_probN(nCur)) = 1;

* -- probability weighted sum of cover crops
 p_Ind("219","driver") $ p_Ind("219","rel")
 =  [sum((c_p_t_i(catchCrops(curCrops),plot,till,intens),t_n(tCur,nCur)), v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur))]
   / sum( (soil,t_n(tCur,nCur)), v_croppedLand("arab",soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("219","val") =    0                                      $(p_ind("219","driver") < 0.05)
                       + 0.25 $((p_ind("219","driver") >= 0.05) $(p_ind("219","driver") < 0.10))
                       + 0.50 $((p_ind("219","driver") >= 0.10) $(p_ind("219","driver") < 0.25))
                       + 0.75 $((p_ind("219","driver") >= 0.25) $(p_ind("219","driver") < 0.50))
                       + 1.00 $( p_ind("219","driver") >= 0.50);



*
*   --- Indicator 222
*
* --- Share of permanent grass land on total agricultural land
 p_Ind("222","rel") $ sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landtype,soil,tCur,nCur)*p_probN(nCur)) = 1;

* -- probability weighted sum of grass land
 p_Ind("222","driver") $ p_Ind("222","rel")
 =  [sum((c_p_t_i(grasCrops(curCrops),plot,till,intens),t_n(tCur,nCur)), v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur))]
   / sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landType,soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("222","val") =   0                                      $(p_ind("222","driver") < 0.20)
                      + 0.25 $((p_ind("222","driver") >= 0.20) $(p_ind("222","driver") < 0.40))
                      + 0.50 $((p_ind("222","driver") >= 0.40) $(p_ind("222","driver") < 0.60))
                      + 0.75 $((p_ind("222","driver") >= 0.60) $(p_ind("222","driver") < 0.80))
                      + 1.00 $( p_ind("222","driver") >= 0.80);



*
*   --- Indicator 229
*
* --- Share of EFA land on total agricultural land
 p_Ind("229","rel")    $ sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landtype,soil,tCur,nCur)*p_probN(nCur)) = 1;

* -- probability weighted sum of flower strips or idling

$$ifi not defined strips set strips(crops); option kill=strips;

 p_Ind("229","driver") $ p_Ind("229","driver")
 =  [sum((c_p_t_i(curCrops,plot,till,intens),t_n(tCur,nCur)) $ (strips(curCrops) or idle(curCrops)), v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur))]
   / sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landType,soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("229","val") =   0                                      $(p_ind("229","driver") < 0.04)
                      + 0.25 $((p_ind("229","driver") >= 0.04) $(p_ind("229","driver") < 0.06))
                      + 0.50 $((p_ind("229","driver") >= 0.06) $(p_ind("229","driver") < 0.13))
                      + 0.75 $((p_ind("229","driver") >= 0.13) $(p_ind("229","driver") < 0.22))
                      + 1.00 $( p_ind("229","driver") >= 0.22);



*
*   --- Indicator 231
*
* --- Share of land without chemical herbizides on total agricultural land
 p_Ind("231","rel")    $ sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landtype,soil,tCur,nCur)*p_probN(nCur)) = 1;

* -- probability weighted sum of main crops (excluding cover crops) which do not use herbicides
*    (exclude ecological farming which does not use synthetic chemical herbicides)
 p_Ind("231","driver") $ p_Ind("231","rel")
 =  [sum((c_p_t_i(curCrops,plot,till,intens),t_n(tCur,nCur)) $ ((not  catchCrops(curCrops)) and (not p_costQuant(curCrops,till,intens,"herb"))),
           v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur))]
   / sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landType,soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("231","val") = p_ind("231","driver");



*
*   --- Indicator 233
*
* --- Share of land without chemical fungicides on total agricultural land
 p_Ind("233","rel")    $ sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landtype,soil,tCur,nCur)*p_probN(nCur)) = 1;

* -- probability weighted sum of main crops (excluding cover crops) which do not use fungicides
*    (exclude ecological farming which does not use synthetic chemical fungicides)
 p_Ind("233","driver") $ p_Ind("233","rel")
 =  [sum((c_p_t_i(curCrops,plot,till,intens),t_n(tCur,nCur)) $ ((not  catchCrops(curCrops)) and (not p_costQuant(curCrops,till,intens,"fung"))),
           v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur))]
   / sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landType,soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("233","val") = p_ind("233","driver");



*
*   --- Indicator 234
*
* --- Share of land without chemical insectides on total agricultural land
 p_Ind("234","rel")    $ sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landtype,soil,tCur,nCur)*p_probN(nCur)) = 1;

* -- probability weighted sum of main crops (excluding cover crops) which do not use insecticides
*    (exclude ecological farming which does not use synthetic chemical instecticides)
 p_Ind("234","driver") $ p_Ind("234","rel")
 =  [sum((c_p_t_i(curCrops,plot,till,intens),t_n(tCur,nCur)) $ ((not  catchCrops(curCrops)) and (not p_costQuant(curCrops,till,intens,"insect"))),
           v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur))]
   / sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landType,soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("234","val") = p_ind("234","driver");



*
*   --- Indicator 236
*
* --- How many elements does the crop rotation consist of?
 p_Ind("236","rel")    $ sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landtype,soil,tCur,nCur)*p_probN(nCur)) = 1;

* -- probability weighted sum of ???
 p_Ind("236","driver") $ p_Ind("236","rel")
 =  sum(arabCrops(CurCrops) $ sum((c_p_t_i(curCrops,plot,till,intens),t_n(tCur,nCur)) $ ((not  catchCrops(curCrops)) $ v_cropHa(curCrops,plot,till,intens,tCur,nCur)),1),1);

* - Calculation of the actual value
 p_ind("236","val") =   0                                   $(p_ind("236","driver") < 3)
                      + 0.25 $((p_ind("236","driver") >= 3) $(p_ind("236","driver") < 4))
                      + 0.50 $((p_ind("236","driver") >= 4) $(p_ind("236","driver") < 5))
                      + 0.75 $((p_ind("236","driver") >= 5) $(p_ind("236","driver") < 6))
                      + 1.00 $( p_ind("236","driver") >= 6);



*
*   --- Indicator 237
*
* --- How much land is mulched?
  p_Ind("237","rel")    = p_Ind("219","rel");

* -- mulch, here assume that all cover crops are mulched
  p_Ind("237","driver") = p_Ind("219","driver");

* - Calculation of the actual value
 p_ind("237","val") = p_ind("237","driver");



*
*   --- Indicator 253
*
* --- Share of extensively managed permanent grassland:
*      (a) Less than 3 cuts
*   or (b) Grazing only
*     and Zero application of fertilizers and pesticides
  p_Ind("253","rel") $ sum( (soil,t_n(tCur,nCur)), (v_croppedLand("gras",soil,tCur,nCur)+v_croppedLand("past",soil,tCur,nCur))*p_probN(nCur)) = 1;

* --
  p_Ind("253","driver") $ (p_Ind("253","rel"))
    =  sum((c_p_t_i(grasCrops(curCrops),plot,till,intens),t_n(tCur,nCur))
                  $ [ {(not (    p_costQuant(curCrops,till,intens,"herb")
                               + p_costQuant(curCrops,till,intens,"fung")
                               + p_costQuant(curCrops,till,intens,"insect")))}

                     and (not sum( (syntFertilizer,m),            v_syntDist(curCrops,plot,till,intens,syntFertilizer,tCur,nCur,m)))

$if defined v_manDist  and (not sum( (manApplicType_manType(ManApplicType,curManType),m),  v_manDist(curCrops,plot,till,intens,ManApplicType,curManType,tCur,nCur,m)))

                     and (
*                    -- pasture use only
                             past(curCrops)
*                    -- or less than 3 ctus
$ifthen.gras defined grasTypes

                        or ( sum( (grasTypes,noPastOutputs,m) $ (sameas(curCrops,grasTypes )$ p_grasAttr(grasTypes,noPastOutputs,m)),1) lt 3)
$endif.gras
                        )
                      ],

                          v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur))
      / sum( (soil,t_n(tCur,nCur)), (v_croppedLand("gras",soil,tCur,nCur)+v_croppedLand("past",soil,tCur,nCur))*p_probN(nCur));

* - Calculation of the actual value
 p_ind("253","val") = p_ind("253","driver");



*
*   --- Indicator 285
*
* --- Share of catch crops on arable land
 p_Ind("285","rel")    = p_Ind("219","rel");

* --
 p_Ind("285","driver") = p_Ind("219","driver");

* - Calculation of the actual value
 p_ind("285","val") = p_ind("285","driver");



*
*   --- Indicator 308
*
* --- Share of farmyard manure on total manure (distributed)
$ifthen.mandist defined manDist
  p_Ind("308","rel")
      $ sum( (c_p_t_i(curCrops,plot,till,intens),manApplicType_manType(ManApplicType,curManType),t_n(tCur,nCur),m),
                                  v_manDist(curCrops,plot,till,intens,ManApplicType,curManType,tCur,nCur,m)*p_probN(nCur)) = 1;

* --
  p_Ind("308","driver") $ p_Ind("308","rel")
      = sum( (c_p_t_i(curCrops,plot,till,intens),manApplicType_manType("applSolidSpread",curManType),t_n(tCur,nCur),m),
                                  v_manDist(curCrops,plot,till,intens,"applSolidSpread",curManType,tCur,nCur,m)*p_probN(nCur))
      / sum( (c_p_t_i(curCrops,plot,till,intens),manApplicType_manType(ManApplicType,curManType),t_n(tCur,nCur),m),
                                  v_manDist(curCrops,plot,till,intens,ManApplicType,curManType,tCur,nCur,m)*p_probN(nCur));
$endif.mandist

* - Calculation of the actual value
 p_ind("308","val") = p_ind("308","driver");



*
*   --- Indicator 323
*
* --- kg N per ha of agricultural land
  p_Ind("323","rel") $ sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landtype,soil,tCur,nCur)*p_probN(nCur)) = 1;

* --
  p_Ind("323","driver") $ p_Ind("323","rel")
         = sum ((c_p_t_i(curCrops,plot,till,intens),curInputs(syntFertilizer),t_n(tCur,nCur),m),
                        v_syntDist(curCrops,plot,till,intens,syntFertilizer,tCur,nCur,m)
                             * p_nutInSynt(syntFertilizer,"N") )
           /sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landtype,soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("323","val") =     1                                                                                 $(p_ind("323","driver") <  25)
                       + (1 - ((p_ind("323","driver") - 25) * (1 / 145))) $ ((p_ind("323","driver") >=  25) $(p_ind("323","driver") < 170))
                       +  0                                               $ ( p_ind("323","driver") >= 170);



*
*   --- Indicator 324
*
* --- kg P (correctly P2O5) per ha of agricultural land
  p_Ind("324","rel") $ sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landtype,soil,tCur,nCur)*p_probN(nCur)) = 1;

* --
  p_Ind("324","driver") $ p_Ind("324","rel")
         = sum ((c_p_t_i(curCrops,plot,till,intens),curInputs(syntFertilizer),t_n(tCur,nCur),m),
                        v_syntDist(curCrops,plot,till,intens,syntFertilizer,tCur,nCur,m)
                             * p_nutInSynt(syntFertilizer,"P") )
           /sum( (landType,soil,t_n(tCur,nCur)), v_croppedLand(landtype,soil,tCur,nCur)*p_probN(nCur));

* - Calculation of the actual value
 p_ind("324","val") =   0                                   $(p_ind("324","driver") >= 50)
                      + 0.25 $((p_ind("324","driver") < 50) $(p_ind("324","driver") >= 25))
                      + 0.50 $((p_ind("324","driver") < 25) $(p_ind("324","driver") >= 10))
                      + 0.75 $((p_ind("324","driver") < 10) $(p_ind("324","driver") >=  0))
                      + 1.00 $( p_ind("324","driver") <  0);



*
*   --- Indicator 620
*
* --- average # of cut permanent grasslands which are not grazed (also not in a mix with cuts)
  p_Ind("620","rel")
     $ sum((c_p_t_i(gras(curCrops),plot,till,intens),t_n(tCur,nCur)),v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur)) = 1;

* --
$ifthen.gras defined grasTypes
  p_Ind("620","driver") $ p_Ind("620","rel")
    = sum((c_p_t_i(gras(curCrops),plot,till,intens),t_n(tCur,nCur)),
                                   sum( (grasTypes,noPastOutputs,m) $ (sameas(curCrops,grasTypes) $ p_grasAttr(grasTypes,noPastOutputs,m)),
                                          v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur)))
   /  sum((c_p_t_i(gras(curCrops),plot,till,intens),t_n(tCur,nCur)),v_cropHa(curCrops,plot,till,intens,tCur,nCur)*p_probN(nCur));
$endif.gras

* - Calculation of the actual value
 p_ind("620","val") =   0                                 $(p_ind("620","driver") <= 2)
                      + 0.5 $((p_ind("620","driver") > 2) $(p_ind("620","driver") <= 4))
                      + 1   $( p_ind("620","driver") > 4);



********************************************************************************
*   --- Scores
********************************************************************************
*
*   --- Species Diversity
*
 p_ind(smartInds,"species") $ specDivInd(smartInds) = 1;

 p_SpecDiv $ sum(specDivInd(smartInds), p_ind(smartInds,"rel"))
 = sum(specDivInd(smartInds) $ p_ind(smartInds,"rel"),p_ind(smartInds,"val"))
   /sum(specDivInd(smartInds), p_ind(smartInds,"rel"));

*
*   --- Ecosystem Diversity
*
 p_ind(smartInds,"ecoSys") $ ecoDivInd(smartInds) = 1;

 p_EcoDiv $ sum(ecoDivInd(smartInds), p_ind(smartInds,"rel"))
 = sum(ecoDivInd(smartInds) $ p_ind(smartInds,"rel"),p_ind(smartInds,"val"))
   /sum(ecoDivInd(smartInds), p_ind(smartInds,"rel"));

*
*   --- Genetic Diversity
*

 p_ind(smartInds,"genetic") $ ecoDivInd(smartInds) = 1;

 p_GenDiv $ sum(genDivInd(smartInds), p_ind(smartInds,"rel"))
 = sum(genDivInd(smartInds) $ p_ind(smartInds,"rel"),p_ind(smartInds,"val"))
   /sum(genDivInd(smartInds), p_ind(smartInds,"rel"));

*
*   --- Overall Biodiversity
*
 p_BioDiv =[ + p_SpecDiv
             + p_EcoDiv
             + p_GenDiv ]/ 3;


 p_res(%1,%2,smartInds,indPos,"","mean") = p_ind(smartInds,indPos);
 p_res(%1,%2,"species","val","","mean")  = p_SpecDiv;
 p_res(%1,%2,"ecosys","val","","mean")   = p_ecoDiv;
 p_res(%1,%2,"genetic","val","","mean")  = p_genDiv;
 p_res(%1,%2,"SMART","val","","mean")    = p_bioDiv;
