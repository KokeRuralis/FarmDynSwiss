********************************************************************************
$ontext

   Dairdyn project

   GAMS file : biodiv_ind.gms

   @purpose  : Generate results for bio-diversity indicator
   @author   : F.Roessing and W.Britz
   @date     : 03.12.20
   @since    :
   @refDoc   :
   @seeAlso  :
   @calledBy : exploiter\store_res.gms

$offtext
********************************************************************************

$Ontext
Assumptions:
1. The Shannon-Index is just taking arable Land into account
2. Stocking density is calculated with all land where i can use fertilizer
3. Gras does not get fertilized
$Offtext

$ifthen.declared not declared p_arabLandend

   $$ifthen.strips not declared strips

    set flowerStrips(crops)  "Flower strips under AES"  / flowerStrip, flowerStripGre/ ;
    set waterStrips(crops) "Strips along surface waters under AES" / waterStrip, waterStripGre / ;
    set strips(crops) "Flower and other strips" /set.flowerStrips, set.waterStrips/ ;

   $$endif.strips
   $$onmulti
     set arableCrops / set.strips /;
   $$offmulti
   set solIndPos / shan,fert,rum,sol /;
   set shannonCrops(Crops) / set.arableCrops,idle /;



********************************************************************************
*                        --- Farm-Data ---
********************************************************************************
 Parameter
  p_haArable(crops,*,t) "Parameter which stands for a table with the hectares devoted to the different crops"
  p_arabLandEnd(t) "Parameter which represents the endowment of arable land"
  p_grasLandEnd(t) "Parameter which represents the endowment of gras land of the farm"
  p_totLand(t) "Parameter which represents the total land endowment"
  p_arabShare(t) "Parameter which represents the Share of arable land on the total land endowment"
  p_grasShare(t) "Parameter which represents the Share of gras land on the total land endowment";
  Set FodarableCrops(crops);
$endif.declared

  p_haArable(shannonCrops,"hectares",t) = sum( (curSys,t_n(t,nCur)), v_sumCrop.l(shannonCrops,curSys,t,nCur) * p_probN(nCur));
  p_arabLandEnd(t) = sum(shannonCrops, p_haArable(shannonCrops,"hectares",t));
  p_grasLandEnd(t) = sum( (grasCrops,curSys,t_n(t,nCur)), v_sumCrop(grasCrops,curSys,t,nCur)* p_probN(nCur));
  p_totLand(t) = p_arabLandEnd(t) + p_grasLandEnd(t);
  p_arabShare(t) $(p_arabLandEnd(t) > 0) = p_arabLandEnd(t) / p_totLand(t);
  p_grasShare(t) $(p_grasLandEnd(t) > 0) = p_grasLandEnd(t) / p_totLand(t);
*
*   --- Set of activities in the "Arable" branch where i produce fodder for cows
*
 fodarableCrops(curCrops) $ (arableCrops(curCrops) and sum(sameas(curCrops,feedsY),1)) = YES;

********************************************************************************
*        --- New Shannon-Index ---
********************************************************************************
 Parameter
  p_CropShare(crops,t) "Share of hectare of the total arable land devoted to the crop"
  p_ShannonIndex(t) "Simple Shannon-Index"
  p_MAXShannonIndex(t) "Maximum value the Shannon-Index can achieve"
*  p_eve(t) "Parameter which represents the evenness of distribution of the arable land to the different crops"
*  p_ShanCrops (t) "Relation between number of crops actually grown on the farm and number of crops maximum possible"
  p_NewShannonIndex(t) "New modified Shannon-Index"
  p_ShanLand(t) "Parameter describing the amound of land affecting p_NewShannonIndex";

  p_ShanLand(t) = p_arabLandEnd(t);



********************************************************************************
*        --- N-Fertilizer-Index ---
********************************************************************************
 Parameter
  p_NFert(t) "Total amound of nitrogen applied per year and per hectare of total land"
  p_NFertIndex(t) "N-Fertilization-Index"
  p_NLand(t) "Parameter describing the amound of land affecting p_NFertIndex";

  p_NLand(t) = p_totLand(t);

********************************************************************************
*        --- Ruminant-Index ---
********************************************************************************

*
*  --- calculate share of production of potential fodder crops (which are also cash crops)
*      used for feeding
*
   parameter p_feedShare(crops,t);



 Parameter
  p_RumLand "Parameter describing the amound of land affecting p_RumIndex";

*
*   --- Parameter for stocking density, all densities between MIN and MAX are
*       assumed to benefit biodiversity.
*       (Values from a "pasture suitability index" - Britz)
*
 Parameter
  p_StockDens(t);


 Parameter
  p_MinStockDens /0.640/
  p_MaxStockDens /1.368/
  p_OptStockDens;

  p_OptStockDens = (p_MinStockDens + p_maxStockDens)/2;

 Parameter
  p_RumIndex(t) "Ruminant-Index";

********************************************************************************
*        --- Final-Index ---
********************************************************************************
 parameter
  p_ImTotLand(t)    "Parameter describing the total imaginary amound of land affecting p_SollIndex"
  p_ShanLandShare   "Parameter describing the share of imaginary total land which is ShanLand"
  p_NLandShare(t)   "Parameter describing the share of imaginary total land which is NLand"
  p_RumLandShare(t) "Parameter describing the share of imaginary total land which is RumLand"
  p_SollIndex(t)    "Parameter for the final biodiversity score";




********************************************************************************
*
*        --- Calculations ---
*
********************************************************************************


   p_feedShare(curCrops(FodarableCrops),t)  $ (p_haArable(curCrops,"hectares",t) $  sum((prodsYearly,sys,t_n(t,nCur)) $ sameas(curCrops,prodsYearly),v_saleQuant.l(prodsYearly,sys,t,nCur)))
      =
*
*     1 - the saled quantities over total production
*
      1 -     sum( (prodsYearly,sys,t_n(t,nCur)) $ sameas(curCrops,prodsYearly),v_saleQuant.l(prodsYearly,sys,t,nCur)*p_probN(nCur))
            / sum( (prodsYearly,t_n(t,nCur))     $ sameas(curCrops,prodsYearly),(v_prods.l(prodsYearly,t,nCur)*p_probN(nCur)))
            ;



  p_RumLand(t) = Sum (curCrops(fodarableCrops), p_haArable(curCrops,"hectares",t)*p_feedShare(curCrops,t)) + p_grasLandEnd(t);
  $$ifi defined v_sumGV p_StockDens(t) $(p_RumLand(t) > 0) =  sum(t_n(t,nCur),v_sumGV(t,nCur))/p_rumLand(t);
  p_StockDens(t) $(p_RumLand(t) = 0) = 0;

********************************************************************************
*        --- New Shannon-Index ---
********************************************************************************
*


*  --- Parameter which represents the share of the land endowment used for each crop
*
 p_CropShare(shannonCrops,t) $ (p_haArable(shannonCrops,"hectares",t)>0)  = p_haArable(shannonCrops,"hectares",t) / p_arabLandEnd(t);

*
*   --- Shannon-Index
*
 p_ShannonIndex(t) = - Sum(shannonCrops $(p_haArable(shannonCrops,"hectares",t)>0),
                                    p_CropShare(shannonCrops,t) * log(p_CropShare(shannonCrops,t)));



*
*   --- Mamximum value of the Shannon-Index (= Log(card(shannonCrops))
*
 p_MAXShannonIndex(t) $(p_arabLandEnd(t) > 0)
                                   =  - Sum(shannonCrops, 1/card(shannonCrops) * log(1/card(shannonCrops)));
*

 p_NewShannonIndex(t) $(p_MAXShannonIndex(t) > 0) = p_ShannonIndex(t) / p_MAXShannonIndex(t);
 p_NewShannonIndex(t) $(p_MAXShannonIndex(t) = 0) = 0;


********************************************************************************
*        --- N-Fertilizer-Index ---
********************************************************************************
*
*   --- Parameter for N fertilizer use per hectare
*
 p_NFert(t) $ p_totLand(t)  = sum( t_n(t,nCur), v_nutTotalAppliedYear("n",t,nCur)*p_probN(nCur)) / p_totLand(t);

*
*   --- N-fertilising index, can take values from 0 to 1, the higher the better
*       (according to Paracchini and Britz 2010:
*       "Quantifying effects of changed farm practise on biodiversity in policy impact assesment- an application of CAPRI-Spat" p. 7)
*
 p_NFertIndex(t) = + (1.0 -  p_NFert(t)        /  30 * 0.2) $((p_NFert(t) <=  30))
                   + (0.8 - (p_NFert(t) -  30) /  70 * 0.3) $((p_NFert(t) >   30)  $(p_NFert(t) <= 100))
                   + (0.5 - (p_NFert(t) - 100) / 100 * 0.4) $((p_NFert(t) >  100)  $(p_NFert(t) <= 200))
                   + (0.1 - (p_NFert(t) - 200) / 800 * 0.1) $((p_NFert(t) >  200)  $(p_NFert(t) <= 800));

********************************************************************************
*        --- Ruminant-Index ---
********************************************************************************
*
*   --- Index for biodiversity impact of ruminants, can take values from 0 to 1, the higher the better
*       (according to Paracchini and Britz 2010:
*       "Quantifying effects of changed farm practise on biodiversity in policy impact assesment- an application of CAPRI-Spat" p. 8)
*

 p_RumIndex(t) $(p_stockDens(t) = 0) = 0;

 p_RumIndex(t) =   (0.1 + (p_stockDens(t) - 0.00) / p_MinStockDens * 0.7)
                    $((p_stockDens(t) <= p_MinStockDens) $(p_stockDens(t) > 0))

                 + (0.8 + (p_stockDens(t) - p_MinStockDens) / (p_OptStockDens - p_MinStockDens) * 0.2)
                    $((p_stockDens(t) > p_MinStockDens) $(p_stockDens(t) <= p_OptStockDens))

                 + (1.0 - (p_stockDens(t) - p_OptStockDens) / (p_MaxStockDens - p_OptStockDens) * 0.2)
                    $((p_stockDens(t) > p_OptStockDens) $(p_stockDens(t) <= p_MaxStockDens))

                 + (0.8 - (p_stockDens(t) - p_MaxStockDens) / (2 * p_MaxStockDens) * 0.7)
                    $((p_stockDens(t) > p_MaxStockDens) $(p_stockDens(t) <= p_MaxStockDens * 3))

                 + (0.1 - (p_stockDens(t) - p_MaxStockDens * 3) / (p_MaxStockDens *10)*0.1)
                    $((p_stockDens(t) > p_MaxStockDens * 3));



********************************************************************************
*        --- Final-Index ---
********************************************************************************
 p_ImTotLand(t) = p_ShanLand(t) + p_NLand(t) + p_RumLand(t);

 p_ShanLandShare(t) $(p_ImTotLand(t) > 0) = p_ShanLand(t) / p_ImTotLand(t);

 p_NLandShare(t) $(p_ImTotLand(t) > 0)    = p_NLand(t) / p_ImTotLand(t);

 p_RumLandShare(t) $(p_ImTotLand(t) > 0)  = p_RumLand(t) / p_ImTotLand(t);

*
*   --- Parameter for the final biodiversity score, can take calues between 0 and 1, the higher the better
*
 p_SollIndex(t) =    p_NewShannonIndex(t) * p_ShanLandShare(t)
                   + p_NFertIndex(t)      * p_NLandShare(t)
                   + p_RumIndex(t)        * p_RumLandShare(t);

*
*   --- Creation of the results parameter
*
 p_res(%1,%2,"shan","val","",t)        = p_NewShannonIndex(t);
 p_res(%1,%2,"shan","wgt","",t)        = p_ShanLandShare(t);

 p_res(%1,%2,"fert","val","",t)        = p_NFertIndex(t);
 p_res(%1,%2,"fert","wgt","",t)        = p_NLandShare(t);

 p_res(%1,%2,"rum","val","",t)        = p_rumIndex(t);
 p_res(%1,%2,"rum","wgt","",t)        = p_rumLandShare(t);

 p_res(%1,%2,"sol","val","",t)        = p_sollIndex(t);
 p_res(%1,%2,"sol","wgt","",t)        = 1;


 p_res(%1,%2,solIndPos,"wgt","","mean") = sum(t $  p_res(%1,%2,solIndPos,"wgt","",t),1);
 p_res(%1,%2,solIndPos,"wgt","","mean") $ p_res(%1,%2,solIndPos,"wgt","","mean")
    = sum(t, p_res(%1,%2,solIndPos,"wgt","",t))/p_res(%1,%2,solIndPos,"wgt","","mean");

 p_res(%1,%2,solIndPos,"val","","mean") $ p_res(%1,%2,solIndPos,"wgt","","mean")
  = sum(t, p_res(%1,%2,solIndPos,"wgt","",t)*p_res(%1,%2,solIndPos,"val","",t))
     /p_res(%1,%2,solIndPos,"wgt","","mean");
