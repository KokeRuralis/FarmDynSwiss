********************************************************************************
$ontext

   FarmDyb project

   GAMS file : STORE_RES_BIOGAS.GMS

   @purpose  :
   @author   :
   @date     : 07.03.25
   @since    :
   @refDoc   :
   @seeAlso  :
   @calledBy :

$offtext



********************************************************************************
*
* --- inventory (by size and eeg)
*
  p_res(%1,%2,curBhkw,"Invent","",tCur)   = sum((t_n(tCur,nCur),curEeg),p_probn(nCur)*  v_invBioGas.l(curBhkw,curEeg,tCur,nCur));
  p_res(%1,%2,curBhkw,"Invent","","mean") = sum(tcur, p_res(%1,%2,curBhkw,"Invent","",tCur))/p_cardtCur;

  p_res(%1,%2,curEeg,"Invent","",tCur)  = sum((t_n(tCur,nCur),curBhkw),p_probn(nCur)* v_invBioGas.l(curBhkw,curEeg,tCur,nCur));
  p_res(%1,%2,curEeg,"Invent","","mean") = sum(tcur, p_res(%1,%2,curEeg,"Invent","",tCur))/p_cardtCur;
*
* --- investments by part (i.e. lifetime)
*
  p_res(%1,%2,curBhkw,ih,"",tCur)
      = sum((t_n(tCur,nCur),curEeg),p_probn(nCur)*(v_buyBioGasPlant.l(curBhkw,curEeg,ih,tCur,nCur) + v_buyBioGasPlantParts.l(curBhkw,ih,tCur,nCur)));
  p_res(%1,%2,curBhkw,ih,"","mean")   = sum(tCur, p_res(%1,%2,curBhkw,ih,"",tCur))/p_cardtCur;

  p_res(%1,%2,curEeg ,ih,"",tCur)     = sum((t_n(tCur,nCur),curBhkw),p_probn(nCur)*(v_buyBioGasPlant.l(curBhkw,curEeg,ih,tCur,nCur)));
  p_res(%1,%2,curEeg ,ih,"","mean")   = sum(tCur, p_res(%1,%2,curEeg,ih,"",tCur))/p_cardtCur;
*
* --- actual used by eeg
*
  p_res(%1,%2,curBhkw,curEeg,"",tCur)     = sum(t_n(tCur,nCur),p_probn(nCur)*v_useBioGasPlant.l(curBhKw,curEeg,tCur,nCur));
  p_res(%1,%2,curBhkw,curEeg,"","mean")   = sum(t_n(tCur,nCur),p_probn(nCur)*v_useBioGasPlant.l(curBhKw,curEeg,tCur,nCur))/p_cardtCur;

*
* --- investment cost
*
  p_res(%1,%2,curBhkw,"invCost","",tCur)  = sum((t_n(tCur,nCur),curEeg),
            p_probn(nCur)*[
                           v_buyBioGasPlant.l(curBhkw,curEeg,"ih20",tCur,nCur)
                                                    * p_priceBioGasPlant(curBhkw,"ih20")

                + sum(ih, v_buyBioGasPlantParts.l(curBhkw,ih,tCur,nCur)
                               * ( p_priceBioGasPlant(curBhkw,ih) $ (not(ih20(ih)))))]);

  p_res(%1,%2,curEeg,"invCost","",tCur)  = sum((t_n(tCur,nCur),curBhkw),
              p_probn(nCur)*
                        v_buyBioGasPlant.l(curBhkw,curEeg,"ih20",tCur,nCur)
                                                 * p_priceBioGasPlant(curBhkw,"ih20"));

*         + sum(ih, v_buyBioGasPlantParts.l(curBhkw,curEeg,tCur,nCur,ih)
*                                      * ( p_priceBioGasPlant(curBhkw,ih) $ (not(ih20(ih)))
*                                           + p_priceFlexBioGasPlant(curBhkw,curEeg,ih) $ eegDM(curEeg)))]);

  p_res(%1,%2,"bioGas","invCost","",tCur)  = sum(curEeg, p_res(%1,%2,curEeg,"invCost","",tCur));
*
* --- output
*
  p_res(%1,%2,curEeg,"heat","",tCur)        = sum(  t_n(tCur,nCur),           p_probn(nCur)*v_sellHeat.l(curEEg,tCur,nCur));
  p_res(%1,%2,curEeg,"ElecCrop","",tCur)    = sum( (t_n(tCur,nCur),curBhkw,m),p_probn(nCur)* v_prodElecCrop.l(curBhkw,curEeg,tCur,nCur,m));
  p_res(%1,%2,curEeg,"ElecManure","",tCur)  = sum( (t_n(tCur,nCur),curBhkw,m),p_probn(nCur)* v_prodElecManure.l(curBhkw,curEeg,tCur,nCur,m));
  p_res(%1,%2,curEeg,"Elec","",tCur)        = sum( (t_n(tCur,nCur),curBhkw,m),p_probn(nCur)* v_prodElec.l(curBhkw,curEeg,tCur,nCur,m));

  p_res(%1,%2,curBhkw,"ElecCrop","",tCur)   = sum( (t_n(tCur,nCur),curEeg,m),p_probn(nCur)* v_prodElecCrop.l(curBhkw,curEeg,tCur,nCur,m));
  p_res(%1,%2,curBhkw,"ElecManure","",tCur) = sum( (t_n(tCur,nCur),curEeg,m),p_probn(nCur)* v_prodElecManure.l(curBhkw,curEeg,tCur,nCur,m));
  p_res(%1,%2,curBhkw,"Elec","",tCur)       = sum( (t_n(tCur,nCur),curEeg,m),p_probn(nCur)* v_prodElec.l(curBhkw,curEeg,tCur,nCur,m));

  p_res(%1,%2,"heat","OQuant","",tCur)       = sum(curEeg,p_res(%1,%2,curEeg,"heat","",tCur));
  p_res(%1,%2,"heat","OQuant","","mean")     = sum(Tcur,  p_res(%1,%2,"heat","OQuant","",tCur))/p_cardtCur;

  p_res(%1,%2,"elec","OQuant","",tCur)       = sum(curEeg,p_res(%1,%2,curEeg,"elec","",tCur));
  p_res(%1,%2,"elec","OQuant","","mean")     = sum(Tcur,  p_res(%1,%2,"elec","OQuant","",tCur))/p_cardtCur;

* --- Digestate output

  p_res(%1,%2,curBhkw,"digCrop","",tCur)   = sum(  (crM,t_n(tCur,nCur),m), p_probn(nCur) * v_voldigCrop.l(crM,tCur,nCur,m));
  p_res(%1,%2,curBhkw,"digMan","",tCur)   = sum(  (t_n(tCur,nCur),m), p_probn(nCur) * v_voldigMan.l(tCur,nCur,m));
*
* --- sales revenues
*
  p_res(%1,%2,"heat","SReve","",tCur) = sum( (t_n(tCur,nCur),curEeg(eeg)), p_probn(nCur)* v_sellHeat.l(eeg,tCur,nCur) * p_priceHeat(tCur) );
  p_res(%1,%2,"heat","SReve","","mean") = sum(Tcur, p_res(%1,%2,"heat","SReve","",tCur))/p_cardtCur;

  p_res(%1,%2,"heat","Price","",tCur) = p_priceHeat(tCur);
  p_res(%1,%2,"heat","Price","","mean") $ p_res(%1,%2,"heat","SReve","","mean")
          = p_res(%1,%2,"heat","SReve","","mean")/p_res(%1,%2,"heat","OQuant","","mean");


  p_res(%1,%2,"elec","SReve","",tCur) = sum(t_n(tCur,nCur), p_probn(nCur)*v_salRevBioGas.l(tCur,nCur)) - p_res(%1,%2,"heat","SReve","",tCur);
  p_res(%1,%2,"elec","SReve","","mean") = sum(Tcur, p_res(%1,%2,"elec","SReve","",tCur))/p_cardtCur;

  p_res(%1,%2,"elec","Price","","mean") $ p_res(%1,%2,"elec","SReve","","mean")
          = p_res(%1,%2,"elec","SReve","","mean")/p_res(%1,%2,"elec","OQuant","","mean");

  p_res(%1,%2,"elec","Price","",tCur) $ p_res(%1,%2,"elec","SReve","",tCur)
          = p_res(%1,%2,"elec","SReve","",tCur)/p_res(%1,%2,"elec","OQuant","",tCur);

  p_res(%1,%2,"bioGasRev","sum","",tCur) = sum( t_n(tCur,nCur),p_probn(nCur)*v_salRevBioGas.l(tCur,nCur));
  p_res(%1,%2,"bioGasRev","sum","","mean") = sum(tCur, p_res(%1,%2,"bioGasRev","sum","",tCur)) /p_cardtCur;
*
* --- variable costs not specified via constraints
*
  p_res(%1,%2,curEeg,"vCostO","",tCur)    = sum(   (t_n(tCur,nCur),curBhkw),p_probn(nCur)* v_varCostBiogas.l(curbhkw,tCur,nCur));
  p_res(%1,%2,"Biogas","vCostO","",tCur)    = sum( (t_n(tCur,nCur),curBhkw),p_probn(nCur)* v_varCostBiogas.l(curbhkw,tCur,nCur));

*
* --- input use
*
  p_res(%1,%2,curBhkw,crM,"",tCur)            = sum( (t_n(tCur,nCur),curEeg,m), p_probn(nCur)* v_usedCropBiogas.l(curBhkw,curEeg,crM,tCur,nCur,m));
  p_res(%1,%2,curEeg,crM,"",tCur)             = sum( (t_n(tCur,nCur),curBhkw,m), p_probn(nCur)* v_usedCropBiogas.l(curBhkw,curEeg,crM,tCur,nCur,m));

  p_res(%1,%2,curBhkw,maM,"",tCur)            = sum( (t_n(tCur,nCur),curEeg,m), p_probn(nCur)*  v_usedManBiogas.l(curBhkw,curEeg,maM,tCur,nCur,m));
  p_res(%1,%2,curEeg,maM,"",tCur)             = sum( (t_n(tCur,nCur),curBhkw,m),p_probn(nCur)*   v_usedManBiogas.l(curBhkw,curEeg,maM,tCur,nCur,m));
*
* --- purchased inputs
*
  $$iftheni.crmPuchDef not defined crmPurch

     set crmPurch /                     maizCorn_purch
                                        maizCCM_purch
                                        wheatGPS_purch
                                        maizSil_purch
                                        grasSil_purch
                                 /;

     set crmPurch_inputs(crmPurch,bioGasFeedM) ;
         crmPurch_inputs("wheatGPS_purch",biogasFeedM) $ sum(sameas(biogasFeedM,GPS),1)          = YES;
         crmPurch_inputs("maizSil_purch",biogasFeedM)  $ sum(sameas(biogasFeedM,maizSilage),1)   = YES;
         crmPurch_inputs("grasSil_purch",biogasFeedM)  $ sum(sameas(biogasFeedM,grasSil),1)      = YES;
         crmPurch_inputs("maizCorn_purch",biogasFeedM) $ sum(sameas(biogasFeedM,grain_maize),1)  = YES;
         crmPurch_inputs("maizCCM_purch",biogasFeedM)  $ sum(sameas(biogasFeedM,maizCCM),1)      = YES;

*     --- Manure (purch)

     set mamPurch / manCatt_purch
                    manPig_purch
                                 /;
     set mamPurch_inputs(mamPurch,maM) /
                                                                              manCatt_purch . manCatt
                                                                              manPig_purch . manPig
     /;
*
*    --- on farm inputs
*
     set crmOnFarm/ maizCorn_onFarm
                    maizCCM_onFarm
                    wheatGPS_onFarm
                    maizSil_onFarm
                    grasSil_onFarm
                 /;

     set crmOnFarm_inputs(crmOnFarm,bioGasFeedM) ;

        crmOnFarm_inputs("wheatGPS_onFarm",biogasFeedM) $ sum(sameas(biogasFeedM,GPS),1)          = YES;
        crmOnFarm_inputs("maizSil_onFarm",biogasFeedM)  $ sum(sameas(biogasFeedM,maizSilage),1)   = YES;
        crmOnFarm_inputs("grasSil_onFarm",biogasFeedM)  $ sum(sameas(biogasFeedM,grasSil),1)      = YES;
        crmOnFarm_inputs("maizCorn_onFarm",biogasFeedM) $ sum(sameas(biogasFeedM,grain_maize),1)  = YES;
        crmOnFarm_inputs("maizCCM_onFarm",biogasFeedM)  $ sum(sameas(biogasFeedM,maizCCM),1)      = YES;

     set mamFeed / manCatt_feed
                   manPig_feed

                                 /;
     set mamFeed_inputs(mamFeed,maM) /
                                                                              manCatt_feed . manCatt
                                                                              manPig_feed . manPig
      /;
     set bioGasMeanItems / set.mam,set.mamPurch,set.mamFeed,
                                                    set.crm,set.crmPurch,set.crmOnFarm,
                                                    cropCost,manureCost,hours,Elec,ElecManure,ElecCrop,digCrop,digMan,heat,sReve,vCostO,vCost,gm,invCost /;



     set bioGasAgg / set.curEeg,set.curBhkw,Biogas /;

  $$$endif.crmPuchDef

  p_res(%1,%2,curBhkw,crmPurch,"",tCur)
    = sum( (t_n(tCur,nCur),curEeg,crmPurch_inputs(crmPurch,crm),m),
        p_probn(nCur)*v_purchCrop.l(curBhkw,curEeg,crm,tCur,nCur,m) * p_silageLoss);

  p_res(%1,%2,curEeg,crmPurch,"",tCur)
    = sum( (t_n(tCur,nCur),curBhkw,crmPurch_inputs(crmPurch,crm),m),
        p_probn(nCur)*v_purchCrop.l(curBhkw,curEeg,crm,tCur,nCur,m)*p_silageLoss);

  p_res(%1,%2,curBhkw,mamPurch,"",tCur)
     = sum( (t_n(tCur,nCur),curEeg,mamPurch_inputs(mamPurch,mam),m),
         p_probn(nCur)*v_purchManure.l(curBhkw,curEeg,mam,tCur,nCur,m));
  p_res(%1,%2,curEeg,mamPurch,"",tCur)
     = sum( (t_n(tCur,nCur),curBhkw,mamPurch_inputs(mamPurch,mam),m),
         p_probn(nCur)* v_purchManure.l(curBhkw,curEeg,mam,tCur,nCur,m));

  p_res(%1,%2,curBhkw,crmOnFarm,"",tCur)
     = sum( (t_n(tCur,nCur),curEeg,crmOnFarm_inputs(crmOnFarm,crm),m),
          p_probn(nCur)*v_feedBioGas.l(curBhkw,curEeg,crm,tCur,nCur,m));

  p_res(%1,%2,curEeg,crmOnFarm,"",tCur)
      = sum( (t_n(tCur,nCur),curBhkw,crmOnFarm_inputs(crmOnFarm,crm),m),
          p_probn(nCur)*v_feedBioGas.l(curBhkw,curEeg,crm,tCur,nCur,m));

* --- Manure Own feed

  p_res(%1,%2,curBhkw,mamFeed,"",tCur)
      = sum( (t_n(tCur,nCur),curEeg,mamFeed_inputs(mamFeed,mam),m),
            p_probn(nCur)*(v_usedManBiogas.l(curBhkw,curEeg,mam,tCur,nCur,m) - v_purchManure.l(curBhkw,curEeg,mam,tCur,nCur,m)));
  p_res(%1,%2,curEeg,mamFeed,"",tCur)
       = sum( (t_n(tCur,nCur),curBhkw,mamFeed_inputs(mamFeed,mam),m),
            p_probn(nCur)*(v_usedManBiogas.l(curBhkw,curEeg,mam,tCur,nCur,m) - v_purchManure.l(curBhkw,curEeg,mam,tCur,nCur,m)));
*
* --- cost for purchasing inputs
*
  p_res(%1,%2,curBhkw,"manureCost","",tCur)
          = sum( (t_n(tCur,nCur),curEeg,mam,m),p_probn(nCur)* v_purchManure.l(curBhkw,curEeg,mam,tCur,nCur,m)
                    * p_price(mam,"conv",tCur) );

  p_res(%1,%2,curBhkw,"cropCost","",tCur)
          = sum( (t_n(tCur,nCur),curEeg,crm,m),p_probn(nCur)* v_purchCrop.l(curBhkw,curEeg,crm,tCur,nCur,m)
                    * p_price(crm,"conv",tCur) );

  p_res(%1,%2,curEeg,"manureCost","",tCur)
          = sum( (t_n(tCur,nCur),curBhkw,mam,m),p_probn(nCur)* v_purchManure.l(curBhkw,curEeg,mam,tCur,nCur,m)
                    * p_price(mam,"conv",tCur) );

  p_res(%1,%2,curEeg,"cropCost","",tCur)
          = sum( (t_n(tCur,nCur),curBhkw,crm,m),p_probn(nCur)* v_purchCrop.l(curBhkw,curEeg,crm,tCur,nCur,m)
                    * p_price(crm,"conv",tCur) );

  p_res(%1,%2,"biogas","manureCost","",tCur)
          = sum( (t_n(tCur,nCur),curBhkw,curEeg,mam,m),p_probn(nCur)* v_purchManure.l(curBhkw,curEeg,mam,tCur,nCur,m)
                    * p_price(mam,"conv",tCur) );

  p_res(%1,%2,"biogas","cropCost","",tCur)
          = sum( (t_n(tCur,nCur),curBhkw,curEeg,crm,m),p_probn(nCur)* v_purchCrop.l(curBhkw,curEeg,crm,tCur,nCur,m)
                    * p_price(crm,"conv",tCur) );
*
* --- aggregate result for branch "biogas"
*
  p_res(%1,%2,curBhkw,"hours","",tCur)         = sum((t_n(tCur,nCur),m),p_probn(nCur)* v_labBiogas.l(curBhkw,tCur,nCur,m));
  p_res(%1,%2,"Biogas","hours","",tCur)        = sum(curBhkw(bhkw), p_res(%1,%2,curBhkw,"hours","",tCur));

  p_res(%1,%2,"Biogas","Elec","",tCur)         = sum(curEeg, p_res(%1,%2,curEeg,"Elec","",tCur));
  p_res(%1,%2,"Biogas","ElecManure","",tCur)   = sum(curEeg, p_res(%1,%2,curEeg,"ElecManure","",tCur));
  p_res(%1,%2,"Biogas","ElecCrop","",tCur)     = sum(curEeg, p_res(%1,%2,curEeg,"ElecCrop","",tCur));
  p_res(%1,%2,"Biogas","heat","",tCur)         = sum(curEeg, p_res(%1,%2,curEeg,"heat","",tCur));
  p_res(%1,%2,"Biogas","sReve","",tCur)        = p_res(%1,%2,"heat","sReve","",tCur) + p_res(%1,%2,"Elec","sReve","",tCur);

  p_res(%1,%2,bioGasAgg,"vCost","",tCur) =  p_res(%1,%2,bioGasAgg,"vCostO","",tCur)
                                                                                    + p_res(%1,%2,bioGasAgg,"cropCost","",tCur)
                                                                                    + p_res(%1,%2,bioGasAgg,"manureCost","",tCur);

  p_res(%1,%2,bioGasAgg,"gm","",tCur) =   p_res(%1,%2,bioGasAgg,"sReve","",tCur)
                                                                                  - p_res(%1,%2,bioGasAgg,"vCost","",tCur);

  p_res(%1,%2,bioGasAgg,bioGasMeanItems,"","mean") = sum(tCur, p_res(%1,%2,bioGasAgg,bioGasMeanItems,"",tCur))/p_cardtCur;

